<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vätskebalans IVA Skövde</title>
    <!-- Länkar till Font Awesome för ikoner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: #fff;
            --grid-item-bg: #fcfcfc;
            --grid-column-bg: #f9f9f9;
            --border-color: #e0e0e0;
            --input-bg: #fff;
            --input-border: #ccc;
            --primary-color: #1a73e8;
            --primary-hover: #0d47a1;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --success-color: #28a745;
            --success-hover: #218838;
            --important-input-bg: #fff5f5;
            --important-input-border: #ffdddd;
            --filled-input-bg: #f5fff5;
            --filled-input-border: #ddffdd;
            --modal-content-bg: #fff;
            --header-border: #ddd;
            --table-header-bg: #e9e9e9;
            --table-row-even-bg: #f5f5f5;
            --result-bg: #e3f2fd;
            --result-border: #bbdefb;
            --result-value-color: #1a73e8;
        }

        body.dark-theme {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --container-bg: #1e1e1e;
            --grid-item-bg: #2a2a2a;
            --grid-column-bg: #252525;
            --border-color: #3c3c3c;
            --input-bg: #3a3a3a;
            --input-border: #555;
            --primary-color: #8ab4f8;
            --primary-hover: #9ac2f9;
            --secondary-color: #a9adb1;
            --secondary-hover: #b9bec3;
            --danger-color: #f28b82;
            --danger-hover: #f5a39d;
            --success-color: #81c995;
            --success-hover: #98d3a7;
            --important-input-bg: #4d2b2b;
            --important-input-border: #6d3f3f;
            --filled-input-bg: #2b4d2b;
            --filled-input-border: #3f6d3f;
            --modal-content-bg: #2a2a2a;
            --header-border: #444;
            --table-header-bg: #3a3a3a;
            --table-row-even-bg: #2c2c2c;
            --result-bg: #1e3a5f;
            --result-border: #2a528f;
            --result-value-color: #8ab4f8;
        }

        /* Grundläggande stil för body */
        body {
            font-family: 'Inter', sans-serif;
            margin: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Ny stil för att förhindra scrolling på body när modal är öppen */
        body.modal-open {
            overflow: hidden;
        }

        /* Stil för huvudbehållaren som centrerar innehållet */
        .container {
            max-width: 980px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);
            transition: background-color 0.3s;
        }

        /* Stil för rubriker */
        h2 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 4px;
            margin-top: 0;
            margin-bottom: 8px;
            text-align: center;
            font-size: 1.5em;
        }

        .info-row {
            display: grid;
            gap: 10px;
            margin-bottom: 10px;
        }
        .info-row .grid-item {
            margin-bottom: 0;
        }
        .grid-4-cols {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Ny stil för 2-kolumns rutnät (används för Balansräkning) */
        .grid-container.two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Stil för varje rutnätsartikel (enkel inmatningsgrupp) */
        .grid-item {
            margin-bottom: 8px;
            background-color: var(--grid-item-bg);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Stil för de yttre kolumnerna inom 2-kolumns rutnät */
        .grid-column-item {
            background-color: var(--grid-column-bg);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .grid-column-item h3 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--header-border);
            padding-bottom: 3px;
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1.1em;
        }


        /* Stil för etiketter (labels) */
        .grid-item label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        /* Stil för alla inmatningsfält och select-menyer */
        .grid-item input[type="date"],
        .grid-item input[type="time"],
        .grid-item input[type="text"], /* Changed from type="number" to type="text" for formula input */
        .grid-item select {
            width: calc(100% - 10px);
            padding: 6px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9rem;
            transition-property: background-color, border-color, box-shadow, color;
            transition-duration: 0.3s;
            transition-timing-function: ease;
        }

        .grid-item input:focus,
        .grid-item select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        /* Stil för inmatningsgrupper med knapp (t.ex. tid + "Nu"-knapp) */
        .input-group {
            display: flex;
            align-items: center;
        }
        .input-group input[type="time"] {
            flex-grow: 1;
            margin-right: 6px;
        }
        .input-group button {
            padding: 6px 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition-property: background-color, transform;
            transition-duration: 0.3s, 0.2s;
            transition-timing-function: ease, ease;
        }
        body.dark-theme .input-group button {
            color: #000;
        }
        .input-group button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        .input-group button:active {
            transform: translateY(0);
        }

        /* Stil för "viktigt input"-markering (ljusrosa bakgrund) */
        .important-input {
            background-color: var(--important-input-bg);
            border-color: var(--important-input-border);
        }
        /* Stil för "fyllt input"-markering (ljusgrön bakgrund) */
        .filled-input {
            background-color: var(--filled-input-bg);
            border-color: var(--filled-input-border);
        }

        /* Stil för numeriska inmatningar med plus/minus-knappar */
        .number-input-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        /* Changed from type="number" to type="text" */
        .number-input-buttons input[type="text"] {
            flex-grow: 1;
            text-align: center;
            border-radius: 4px;
        }

        .number-input-buttons button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
            flex-shrink: 0;
            transition-property: background-color, transform;
            transition-duration: 0.3s, 0.2s;
            transition-timing-function: ease, ease;
        }
        body.dark-theme .number-input-buttons button {
            color: #000;
        }
        .number-input-buttons button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-1px);
        }
        .number-input-buttons button:active {
            transform: translateY(0);
        }

        /* Stil för "Annan plats" inmatningsfält när det visas */
        #otherLocationInput {
            margin-top: 6px;
            width: calc(100% - 10px);
        }

        /* Stil för det automatiskt beräknade Kcal-fältet */
        .calculated-output {
            background-color: var(--input-bg);
            border-color: var(--input-border);
        }

        /* Stil för enskild vätskerad (Kristalloider/Kolloider & Läkemedelsvätskor) */
        .fluid-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }

        /* Ny stil för blodprodukt rad (utan Kcal) */
        .blood-product-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }
        /* Ny stil för TPN/Sondmat rad (med Kcal) */
        .tpn-sondmat-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }
        /* Ny stil för förlust rad (utan Kcal) */
        .loss-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }


        .fluid-entry-row .grid-item,
        .blood-product-entry-row .grid-item,
        .tpn-sondmat-entry-row .grid-item,
        .loss-entry-row .grid-item {
            margin-bottom: 0;
            padding: 0;
            background-color: transparent;
            border: none;
        }

        .fluid-entry-row input,
        .fluid-entry-row select,
        .blood-product-entry-row input,
        .blood-product-entry-row select,
        .tpn-sondmat-entry-row input,
        .tpn-sondmat-entry-row select,
        .loss-entry-row input,
        .loss-entry-row select {
            width: 100%;
            padding: 3px;
            font-size: 0.8rem;
        }

        /* Stil för den egna vätskan/läkemedlet */
        .custom-input-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .custom-input {
            flex-grow: 1;
        }
        .cancel-custom-input {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
        }
        .cancel-custom-input:hover {
            color: #333;
        }

        .remove-fluid-button {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition-property: background-color;
            transition-duration: 0.3s;
            transition-timing-function: ease;
            height: fit-content;
            align-self: center;
            line-height: 1;
        }
         body.dark-theme .remove-fluid-button {
            color: #000;
        }
        .remove-fluid-button:hover {
            background-color: var(--danger-hover);
        }
        /* Stil för knappen som inte ska kunna tas bort */
        .remove-fluid-button.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .remove-fluid-button.disabled:hover {
            background-color: #cccccc;
            transform: none;
        }


        .add-button {
            display: block;
            width: 100%;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            transition-property: background-color, transform;
            transition-duration: 0.3s, 0.2s;
            transition-timing-function: ease, ease;
        }
         body.dark-theme .add-button {
            color: #000;
        }
        .add-button:hover {
            background-color: var(--success-hover);
            transform: translateY(-1px);
        }

        /* Stil för tabellrubrikerna */
        .fluid-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid var(--input-border);
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: var(--text-color);
        }
        /* Ny stil för blodprodukter tabellrubriker (utan Kcal) */
        .blood-product-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid var(--input-border);
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: var(--text-color);
        }
        /* Ny stil för TPN/Sondmat tabellrubriker (med Kcal) */
        .tpn-sondmat-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid var(--input-border);
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: var(--text-color);
        }
        /* Ny stil för förlust tabellrubriker (utan Kcal) */
        .loss-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid var(--input-border);
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: var(--text-color);
        }
        .fluid-table-header div,
        .blood-product-table-header div,
        .tpn-sondmat-table-header div,
        .loss-table-header div {
            text-align: left;
        }
        /* Justera för att papperskorgskolumnen ska vara tom i headern */
        .fluid-table-header div:last-child,
        .blood-product-table-header div:last-child,
        .tpn-sondmat-table-header div:last-child,
        .loss-table-header div:last-child {
            width: 25px;
        }

        /* Stil för notis om justerad idealvikt */
        .adjusted-weight-notice {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            display: block;
        }

        /* NYA STYLING REGLER */
        /* Flexbox för att placera Beräknad Perspiratio-input och knapp på samma rad */
        .calculated-perspiratio-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Justera bredd för input i den nya gruppen */
        .calculated-perspiratio-group input[type="text"] {
            flex-grow: 1;
            max-width: 150px;
            text-align: center;
        }

        /* Justera knappen i den nya gruppen */
        .calculated-perspiratio-group button {
            width: fit-content; /* KORRIGERING: Återställer bredden för denna specifika knapp */
            margin-top: 0 !important;
            flex-shrink: 0;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Nytt: Stil för Spara/Ladda-knapparna */
        .file-buttons-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .file-buttons-group .add-button {
            margin-top: 0;
            flex-grow: 1; /* Får knapparna att ta upp lika mycket plats */
        }

        /* Nytt: Stil för Verktygsknappar */
        .tool-buttons-group {
            display: flex;
            gap: 8px;
            margin-top: 0; /* Tar bort marginalen för den här gruppen */
        }
        .tool-buttons-group .add-button {
            margin-top: 0;
            flex-grow: 1;
        }
        .tool-buttons-group .reset-button {
            margin-top: 0;
            flex-grow: 1;
            background-color: var(--danger-color);
        }
         body.dark-theme .tool-buttons-group .reset-button {
            color: #000;
        }
        .tool-buttons-group .reset-button:hover {
            background-color: var(--danger-hover);
        }


        #perspiratioWarning {
            font-size: 0.75rem;
            color: var(--danger-color);
            margin-top: 4px;
            display: block;
            min-height: 1em;
        }

        /* --- Tooltip Stilar --- */
        .label-with-tooltip {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .input-with-tooltip {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .label-with-tooltip label {
            margin-bottom: 0; /* Remove default margin from label inside this container */
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            color: var(--primary-color);
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-weight: normal;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* --- Modal Specifika Stilar --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Dimmed background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index to appear on top */
            visibility: hidden; /* Hidden by default */
            opacity: 0;
            transition-property: visibility, opacity;
            transition-duration: 0.3s, 0.3s;
            transition-timing-function: ease, ease;
        }
        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: var(--modal-content-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            max-width: 1100px;
            width: 90%; /* Responsive width */
            position: relative;
            transform: translateY(-20px); /* Small animation effect */
            transition-property: transform;
            transition-duration: 0.3s;
            transition-timing-function: ease;
            /* För att modal-content ska anpassa sin höjd efter innehållet och ha egen scroll */
            max-height: 90vh; /* Sätter maxhöjden till 90% av viewportens höjd */
            overflow-y: auto; /* Lägger till scroll om innehållet överskrider maxhöjden */
            box-sizing: border-box; /* Inkluderar padding i höjden */
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        #nutritionCalculatorContent {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            align-items: start;
        }

        /* Adjusted grid for modal content to be 3 columns */
        .modal-content .grid-container.modal-three-column-grid { /* New class for specific modal grid */
            display: grid;
            /* Using minmax(0, 1fr) to ensure columns don't grow beyond 1fr due to content */
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 15px;
            /* Säkerställer att alla grid-items sträcker sig till samma höjd */
            align-items: stretch;
        }
        /* Added to explicitly make grid-column-items fill their grid cells */
        .modal-content .grid-container.modal-three-column-grid > .grid-column-item {
            width: 100%; /* Ensure it takes full width of its grid cell */
            height: 100%; /* Ensure it takes full height of its grid cell */
            box-sizing: border-box; /* Ensures padding/border are included in width/height */
        }
        .modal-content h3 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--header-border);
            padding-bottom: 3px;
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1.1em;
        }
        /* Justerad font-storlek för modal-p och modal-ul */
        .modal-content p {
            font-size: 0.7rem; /* Något mindre */
            margin-bottom: 5px;
            line-height: 1.4;
            word-wrap: break-word; /* Lägg till för att tvinga radbrytning */
            overflow-wrap: break-word; /* Fallback för word-wrap */
        }
        .modal-content ul {
            list-style: none;
            padding-left: 0;
            font-size: 0.8rem;
        }
        .modal-content ul li {
            margin-bottom: 8px;
            padding-left: 1em;
            text-indent: -1em;
        }
        .modal-content ul li::before {
            content: "• ";
            color: var(--primary-color);
            padding-right: 5px;
        }
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem; /* Smaller text for tables to fit 3 columns */
        }
        .modal-content th, .modal-content td {
            border: 1px solid var(--border-color);
            padding: 4px; /* Reduced padding for table cells */
            text-align: left;
        }
        .modal-content th {
            background-color: var(--table-header-bg);
            font-weight: 600;
        }
        .modal-content tr:nth-child(even) {
            background-color: var(--table-row-even-bg);
        }
        .modal-content .category-heading {
            font-weight: bold;
            background-color: #e0e0e0;
            padding: 4px 6px;
            margin-top: 8px;
            margin-bottom: 4px;
            border-radius: 3px;
            font-size: 0.75rem; /* Smaller category heading */
        }
        body.dark-theme .modal-content .category-heading {
            background-color: #333;
        }

        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition-property: color;
            transition-duration: 0.2s;
            transition-timing-function: ease;
        }
         body.dark-theme .modal-close-button {
            color: #aaa;
        }
        .modal-close-button:hover {
            color: #333;
        }
        body.dark-theme .modal-close-button:hover {
            color: #eee;
        }
        /* Stil för den statiska Perspiratio-selecten för att säkerställa att den syns tydligt */
        #lossSelect_perspiratio_static {
            color: #333 !important; /* Force a darker color */
            font-weight: bold; /* Make it bold */
            opacity: 1; /* Ensure full opacity */
            -webkit-text-fill-color: currentColor; /* Override user agent style for disabled options */
        }

        /* Justering för mörkt läge */
        body.dark-theme #lossSelect_perspiratio_static {
            color: var(--text-color) !important; /* Använd temats textfärg */
            background-color: var(--input-bg); /* Matcha andra inmatningsfält */
        }

        /* Specific styles for Diuresis Calculator modal */
        #diuresisCalculatorModalOverlay .modal-content {
            max-width: 950px;
        }

        #diuresisCalculatorModalOverlay .grid-container.two-column-diuresis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        #diuresisCalculatorModalOverlay .diuresis-summary-table td,
        #diuresisCalculatorModalOverlay .diuresis-summary-table th {
            padding: 5px; /* Adjusted padding for summary table */
            font-size: 0.8rem;
        }
        #diuresisCalculatorModalOverlay .diuresis-summary-table .detail-row {
            font-size: 0.75rem;
            color: #555;
            padding-left: 15px;
        }
        .highlight-row {
            background-color: #e6ffe6; /* Light green for highlight */
            font-weight: bold;
        }
        body.dark-theme .highlight-row {
            background-color: #2a4d2a;
            color: #e0e0e0;
        }


        /* Stilar för tabellerna i detaljerad sammanställning modalen */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.8rem; /* Anpassa storlek för utskrift */
            table-layout: fixed; /* Nytt för jämna kolumner */
        }
        .summary-table th, .summary-table td {
            border: 1px solid var(--header-border);
            padding: 6px 8px;
            text-align: left;
            width: 50%; /* Nytt för jämna kolumner */
        }
        .summary-table th {
            background-color: var(--table-header-bg);
            font-weight: bold;
        }
        .summary-table tr:nth-child(even) {
            background-color: var(--container-bg);
        }
        .summary-table .numeric-value {
            text-align: right;
            font-weight: 500;
        }
        .summary-table .highlight-row-print {
            background-color: #f0f0f0; /* Ljusgrå bakgrund för utskrift */
            font-weight: bold;
        }
        body.dark-theme .summary-table .highlight-row-print {
            background-color: #333;
        }
        .summary-table .category-row td {
            font-weight: bold;
            padding-top: 10px;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--header-border);
        }
        .summary-table .subcategory-row td {
            font-style: italic;
            padding-left: 20px;
        }
        .summary-table .item-row td {
            padding-left: 30px;
        }

        /* Nytt: Grid för summary-tabeller */
        .summary-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
            margin-bottom: 20px;
        }
        .summary-grid-container .summary-table {
            margin-bottom: 0;
        }

        /* Nytt: Grid för detalj-tabeller */
        .details-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        /* Nytt: Stil för tomma rutor i sammanställningen */
        .patient-label-placeholder {
            border: 1px dashed #ccc;
            height: 120px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-style: italic;
        }
        .summary-info-box {
            border: 1px solid var(--input-border);
            height: 120px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.9rem;
        }
        .summary-info-box p {
            margin: 2px 0;
            font-size: 0.9rem;
        }


        /* Nytt: Stil för sidfot och ändringslogg */
        .app-footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            font-size: 0.8rem;
            color: #888;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        .changelog-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }
        .changelog-link:hover {
            text-decoration: underline;
        }
        #theme-toggle {
            cursor: pointer;
            font-size: 1.2em;
            color: var(--secondary-color);
        }

        /* Nytt: Stil för låg diures */
        .low-diuresis {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Nytt: Stilar för nutritionsnivå-val */
        .nutrition-level-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nutrition-level-option {
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .nutrition-level-option input[type="radio"] {
            margin-right: 10px;
        }

        .nutrition-level-option:hover {
            background-color: var(--grid-column-bg);
        }

        .nutrition-level-option.selected {
            border-color: var(--primary-color);
            background-color: var(--result-bg);
        }

        .nutrition-level-option p {
            font-size: 0.8rem;
            color: #666;
            margin-left: 25px; /* Indent description */
        }
        body.dark-theme .nutrition-level-option p {
            color: #bbb;
        }


        .nutrition-level-option label {
            font-weight: bold;
            display: block;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .slider-container input[type="range"] {
            flex-grow: 1;
        }

        #nutritionResultContent {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
        }
        .result-item {
            text-align: center;
        }
        .result-label {
            font-size: 0.9em;
            color: var(--text-color);
            display: block;
            margin-bottom: 5px;
        }
         body.dark-theme .result-label {
            color: #ccc;
        }
        .result-value {
            font-size: 1.6em;
            font-weight: bold;
            color: var(--result-value-color);
            display: block;
        }
        .result-percent {
            font-size: 0.9em;
            font-weight: normal;
        }

        /* ---- NY CSS FÖR PLANERINGSSEKTION ---- */
        .planned-nutrition-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .planned-nutrition-column {
            background-color: var(--grid-column-bg);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .planned-nutrition-column h4 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--header-border);
            padding-bottom: 3px;
            margin: 0 0 6px 0;
            font-size: 1em;
        }
        .planned-nutrition-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 6px;
            align-items: center;
        }
        .planned-nutrition-row input,
        .planned-nutrition-row select {
            width: 100%;
            padding: 3px;
            font-size: 0.8rem;
        }
        .planned-nutrition-header {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            font-size: 0.8rem;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--input-border);
            margin-bottom: 4px;
            min-height: 2.5em; /* Försök att linjera rubriker */
            align-items: end; /* Linjera texten längst ner */
        }
        .planned-bolus-header {
             display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            font-size: 0.8rem;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--input-border);
            margin-bottom: 4px;
             min-height: 2.5em; /* Försök att linjera rubriker */
            align-items: end; /* Linjera texten längst ner */
        }
         .planned-nutrition-summary p,
         #nutritionPrognosis p {
             margin: 4px 0;
             font-size: 0.85rem;
         }
         #nutritionPrognosis {
             grid-column: 1 / -1; /* Får prognosen att spänna över båda kolumner */
             background-color: var(--result-bg);
             border-color: var(--result-border);
             padding: 10px;
             border-radius: 6px;
             margin-top: 10px;
         }
         #nutritionPrognosis h4 {
             margin-top: 0;
             font-size: 1em; /* Matcha kolumnrubriker */
             color: var(--primary-color);
             border-bottom: 1px solid var(--header-border);
             padding-bottom: 3px;
             margin-bottom: 6px;
         }

        /* ---- SLUT NY CSS ---- */

        /* Mediafråga för mindre skärmar (staplar kolumnerna) */
        @media (max-width: 1024px) {
             .grid-4-cols, .grid-5-cols, .grid-2-cols {
                 grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            }
            .planned-nutrition-section {
                grid-template-columns: 1fr; /* Stapla kolumnerna */
            }
        }
        @media (max-width: 768px) {
            .grid-container, .grid-container.two-column-grid, .info-row, #nutritionCalculatorContent, #diuresisCalculatorModalOverlay .grid-container {
                grid-template-columns: 1fr;
            }
            .container {
                margin: 5px;
                padding: 10px;
            }
            body {
                font-size: 0.85rem;
            }
            .grid-column-item {
                padding: 10px;
            }
            .fluid-entry-row, .fluid-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .blood-product-entry-row, .blood-product-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .tpn-sondmat-entry-row, .tpn-sondmat-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .loss-entry-row, .loss-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .fluid-entry-row input,
            .fluid-entry-row select,
            .blood-product-entry-row input,
            .blood-product-entry-row select,
            .tpn-sondmat-entry-row input,
            .tpn-sondmat-entry-row select,
            .loss-entry-row input,
            .loss-entry-row select {
                width: calc(100% - 6px);
            }
            .fluid-table-header div,
            .blood-product-table-header div,
            .tpn-sondmat-table-header div,
            .loss-table-header div {
                text-align: center;
            }
            /* Återställ temp-grid-container till en kolumn på små skärmar */
            .temp-grid-container {
                grid-template-columns: 1fr;
            }
            /* Justera perspiratio-gruppen på små skärmar */
            .calculated-perspiratio-group {
                flex-direction: column;
                align-items: stretch;
            }
            .calculated-perspiratio-group input[type="text"] {
                max-width: 100%;
            }
            /* Modal justeringar för små skärmar */
            #nutritionCalculatorContent,
            .modal-content .grid-container.modal-three-column-grid,
            #diuresisCalculatorModalOverlay .grid-container.two-column-diuresis,
            #diuresisCalculatorModalOverlay .grid-container, /* Applies to modal's inner grids */
             .planned-nutrition-section { /* Stapla planeringskolumner på små skärmar */
                grid-template-columns: 1fr;
            }
            .modal-content p {
                font-size: 0.8rem;
            }
            .modal-content ul {
                font-size: 0.75rem;
            }
            .modal-content table {
                font-size: 0.7rem;
            }
        }

        /* --- Print-specifika stilar --- */
        @media print {
            body > *:not(#printDetailedSummaryModalOverlay) {
                display: none !important; /* Hide everything except the print modal overlay */
            }

            #printDetailedSummaryModalOverlay {
                position: static !important; /* Remove fixed positioning for print */
                top: auto !important;
                left: auto !important;
                width: 100% !important;
                height: auto !important;
                background-color: transparent !important; /* No dimmed background on print */
                display: flex !important; /* Ändrad till flex för att kunna justera */
                justify-content: flex-start !important; /* Tvingar allt innehåll till vänster */
                visibility: visible !important;
                opacity: 1 !important;
                box-shadow: none !important; /* No shadow on print */
            }

            #printDetailedSummaryModalOverlay .modal-content {
                max-width: 100% !important; /* Use full width for print */
                width: 100% !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0 !important; /* No padding on content for full use of paper */
                transform: none !important; /* Remove translation */
                max-height: none !important; /* No max height for print */
                overflow-y: visible !important; /* Allow content to flow */
                background-color: transparent !important; /* No background on print */
            }

            .modal-close-button, .add-button, .app-footer {
                display: none !important; /* Hide close button, add buttons, and footer on print */
            }

            .summary-table {
                border: none !important;
            }
            .summary-table th, .summary-table td {
                border: none !important;
                border-bottom: 1px solid #eee !important;
                padding: 4px !important; /* Adjust padding for print if needed */
            }
            .summary-table th {
                border-bottom: 2px solid #ccc !important;
            }
            .summary-table tr:last-child td {
                border-bottom: none !important;
            }

            /* Adjust font sizes for better print readability */
            .modal-content h2 {
                font-size: 1.4em !important;
            }
            .modal-content h3 {
                font-size: 1.2em !important;
                margin-top: 20px !important;
            }
            .summary-info-box p,
            .summary-table,
            .summary-table th,
            .summary-table td {
                font-size: 1.0em !important;
            }

            /* Page breaks for tables if necessary */
            .summary-table {
                page-break-inside: avoid !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Patientinformation</h2>
        <div class="info-row grid-4-cols">
            <!-- Datumfält -->
            <div class="grid-item">
                <label for="dateInput">Datum:</label>
                <input type="date" id="dateInput">
            </div>
            <!-- Sängval och "Annan plats" fält -->
            <div class="grid-item">
                <label for="bedSelect">Säng:</label>
                <select id="bedSelect">
                    <option value="">Välj säng</option>
                    <option value="IVA 1">IVA 1</option>
                    <option value="IVA 2">IVA 2</option>
                    <option value="IVA 3">IVA 3</option>
                    <option value="IVA 4">IVA 4</option>
                    <option value="IVA 5">IVA 5</option>
                    <option value="IVA 6">IVA 6</option>
                    <option value="IVA 7">IVA 7</option>
                    <option value="IVA 8">IVA 8</option>
                    <option value="IVA 9">IVA 9</option>
                    <option value="IVA 10">IVA 10</option>
                    <option value="IVA 11">IVA 11</option>
                    <option value="IVA 12">IVA 12</option>
                    <option value="IMA 1">IMA 1</option>
                    <option value="IMA 2">IMA 2</option>
                    <option value="IMA 3">IMA 3</option>
                    <option value="IMA 4">IMA 4</option>
                    <option value="Annan plats">Annan plats</option>
                </select>
                <input type="text" id="otherLocationInput" placeholder="Ange annan plats" style="display: none;">
            </div>
            <!-- Starttid med "Nu"-knapp -->
            <div class="grid-item">
                <label for="startTime">Beräknat från (starttid):</label>
                <div class="input-group">
                    <input type="time" id="startTime" value="06:00">
                    <button data-action="setNow" data-target="startTime">Nu</button>
                </div>
            </div>
            <!-- Sluttid med "Nu"-knapp -->
            <div class="grid-item">
                <label for="endTime">till (sluttid):</label>
                <div class="input-group">
                    <input type="time" id="endTime" value="06:00">
                    <button data-action="setNow" data-target="endTime">Nu</button>
                </div>
            </div>
        </div>
        <div class="info-row grid-4-cols">
            <!-- Längd -->
            <div class="grid-item">
                <label for="height">Längd (cm):</label>
                <input type="text" id="height" placeholder="t.ex. 175.0">
            </div>
            <!-- Kön -->
            <div class="grid-item">
                <label for="gender">Kön:</label>
                <select id="gender">
                    <option value="">Välj kön</option>
                    <option value="Man">Man</option>
                    <option value="Kvinna">Kvinna</option>
                </select>
            </div>
             <!-- Utgångsvikt/torrvikt -->
            <div class="grid-item">
                <label for="initialWeight">Utgångsvikt/torrvikt (kg):</label>
                <input type="text" id="initialWeight" class="important-input" placeholder="t.ex. 70.0">
            </div>
            <!-- Dagens vikt -->
            <div class="grid-item">
                 <div class="label-with-tooltip">
                    <label for="dailyWeight">Dagens vikt (kg):</label>
                    <span class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltiptext">Alla beräkningar inklusive timdiures och perspiratio utgår från detta värde</span>
                    </span>
                </div>
                <input type="text" id="dailyWeight" class="important-input" placeholder="t.ex. 71.5" value="">
            </div>
        </div>
        <div class="info-row grid-4-cols">
             <!-- Idealvikt (kg) -->
            <div class="grid-item">
                <label id="idealWeightLabel" for="idealWeight">Idealvikt (kg):</label>
                <input type="text" id="idealWeight" readonly class="calculated-output" value="Var god ange längd och kön">
                <span id="adjustedWeightNotice" class="adjusted-weight-notice" style="display: none;"></span>
            </div>
            <!-- Kumulativ balans föregående dygn -->
            <div class="grid-item">
                <div class="label-with-tooltip">
                    <label for="cumulativeBalancePrev">Gårdagens kumulativa balans:</label>
                    <span class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltiptext">Fyll i den kumulativa balansen (ml) från föregående dygns avstämning (t.ex. gårdagens värde kl 06:00).</span>
                    </span>
                </div>
                <input type="text" id="cumulativeBalancePrev" value="">
            </div>
             <!-- Nytt fält för Ålder -->
            <div class="grid-item">
                <div class="label-with-tooltip">
                    <label for="isUnder15">Patient under 15 år?</label>
                    <span class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltiptext">Perspiratio beräknas ej hos patient under 15 år.</span>
                    </span>
                </div>
                <select id="isUnder15">
                    <option value="no" selected>Nej</option>
                    <option value="yes">Ja</option>
                </select>
            </div>
             <!-- Antal tryckset med +/- knappar -->
            <div class="grid-item">
                <div class="label-with-tooltip">
                    <label for="pressureSets">Antal tryckset:</label>
                     <span class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltiptext">Varje tryckset beräknas ge 3 ml/timme. Ett CVP-set räknas som två tryckset.</span>
                    </span>
                </div>
                <div class="number-input-buttons">
                    <button data-action="changeNumber" data-target="pressureSets" data-delta="-1"><i class="fas fa-minus"></i></button>
                    <input type="text" id="pressureSets" value="0">
                    <button data-action="changeNumber" data-target="pressureSets" data-delta="1"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
        <div class="info-row grid-4-cols">
            <!-- Antal förfyllda 10ml NaCl-sprutor med +/- knappar -->
            <div class="grid-item">
                <div class="label-with-tooltip">
                    <label for="naclSyringes">Antal förfyllda 10ml NaCl-sprutor:</label>
                    <span class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltiptext">Frivilligt att fylla i.</span>
                    </span>
                </div>
                <div class="number-input-buttons">
                    <button data-action="changeNumber" data-target="naclSyringes" data-delta="-1"><i class="fas fa-minus"></i></button>
                    <input type="text" id="naclSyringes" value="0">
                    <button data-action="changeNumber" data-target="naclSyringes" data-delta="1"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ny sektion för Balansräkning -->
    <div class="container" style="margin-top: 8px;">
        <h2>Balansräkning</h2>
        <div class="grid-container two-column-grid">
            <!-- Första kolumn: Kristalloider/Kolloider -->
            <div class="grid-column-item">
                <div class="label-with-tooltip">
                    <h3>Rena Glucoslösningar/Kolloider</h3>
                    <span class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltiptext">Du kan skriva in enkla uträkningar direkt i fältet genom att börja med ett likhetstecken. Exempel: =50+100*2.</span>
                    </span>
                </div>
                <!-- Tabellrubriker för vätskeraderna -->
                <div class="fluid-table-header">
                    <div>Vätska</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div>Protein (g)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="fluidEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addFluidButton" data-action="addRow" data-type="fluid" class="add-button">Lägg till vätska</button>
            </div>

            <!-- Andra kolumn: Läkemedelsvätskor -->
            <div class="grid-column-item">
                <h3>Läkemedelsvätskor</h3>
                <!-- Tabellrubriker för läkemedelsvätskeraderna -->
                <div class="fluid-table-header">
                    <div>Läkemedel</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div>Protein (g)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="medicineEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addMedicineButton" data-action="addRow" data-type="medicine" class="add-button">Lägg till läkemedelsvätska</button>
            </div>

            <!-- Ny kolumn: Blodprodukter -->
            <div class="grid-column-item">
                <h3>Blodprodukter</h3>
                <div class="blood-product-table-header"> <!-- Specifik header för blodprodukter -->
                    <div>Blodprodukt</div>
                    <div>Mängd (ml)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="bloodProductEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addBloodProductButton" data-action="addRow" data-type="bloodProduct" class="add-button">Lägg till blodprodukt</button>
            </div>

            <!-- Ny kolumn: TPN/Sondmat/Peroralt -->
            <div class="grid-column-item">
                <h3>TPN/Sondmat/Näringsdryck/Peroralt</h3>
                <div class="tpn-sondmat-table-header"> <!-- Specifik header för TPN/Sondmat -->
                    <div>Typ</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div>Protein (g)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="tpnSondmatEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addTpnSondmatButton" data-action="addRow" data-type="tpnSondmat" class="add-button">Lägg till TPN/Sondmat/Peroralt</button>
            </div>

            <!-- Ny kolumn: Förluster -->
            <div class="grid-column-item">
                <h3>Förluster</h3>
                <div class="loss-table-header"> <!-- Specifik header för Förluster -->
                    <div>Typ</div>
                    <div>Mängd (ml)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="lossEntriesContainer">
                    <!-- Statisk, icke-borttagningsbar Perspiratio-rad -->
                    <div class="loss-entry-row" data-id="perspiratio_static" id="perspiratio_static_row">
                        <div class="grid-item">
                            <!-- Hardcode the option for "Perspiratio" as it's static and disabled -->
                            <select id="lossSelect_perspiratio_static" disabled>
                                <option value="Perspiratio" selected disabled>Perspiratio</option>
                            </select>
                            <!-- Ingen custom input behövs för Perspiratio -->
                        </div>
                        <div class="grid-item">
                            <input type="text" id="lossMlInput_perspiratio_static" value="">
                        </div>
                        <!-- Ingen ta bort-knapp för denna rad -->
                        <button class="remove-fluid-button disabled" disabled><i class="fas fa-trash"></i></button>
                    </div>
                    <!-- Dynamiska rader läggs till här -->
                </div>
                <button id="addLossButton" data-action="addRow" data-type="loss" class="add-button">Lägg till förlust</button>
            </div>

            <!-- Ny kolumn: Perspiratio-beräkning -->
            <div class="grid-column-item">
                <h3>Perspiratio-beräkning</h3>
                <div class="grid-item">
                    <label for="breathingSupport">Andningsstöd:</label>
                    <select id="breathingSupport">
                        <option value="standard">Standard/Inget</option>
                        <option value="niv_hmef">NIV med HMEF</option>
                        <option value="intub_hmef">Intuberad med HMEF</option>
                        <option value="niv_humid">NIV med aktiv befuktning</option>
                        <option value="hfnc">HFNC</option>
                        <option value="intub_humid">Intuberad med aktiv befuktning</option>
                    </select>
                </div>
                <div class="grid-item">
                    <label for="maxTemp">Medeltemperatur under dygnet (°C):</label>
                    <input type="text" id="maxTemp" value="37.0" placeholder="t.ex. 38.5">
                </div>
                <div class="grid-item">
                    <label id="calculatedPerspiratioLabel" for="calculatedPerspiratio">Beräknad Perspiratio (ml):</label>
                    <div class="calculated-perspiratio-group"> <!-- Ny flex-container för input och knapp -->
                        <input type="text" id="calculatedPerspiratio" readonly class="calculated-output" value="0">
                        <button id="transferPerspiratioButton" data-action="transferPerspiratio" class="add-button">För över till förlust</button>
                    </div>
                    <span id="perspiratioWarning"></span>
                </div>
            </div>

            <!-- NY KOLUMN: Verktyg -->
            <div class="grid-column-item">
                <h3>Verktyg</h3>
                <div class="tool-buttons-group">
                    <button id="resetButton" data-action="openModal" data-target="confirmationModalOverlay" class="add-button reset-button">Rensa allt</button>
                    <button id="openPrintSummaryButton" data-action="openModal" data-target="printDetailedSummaryModalOverlay" class="add-button">Skriv ut</button>
                </div>
                <div class="tool-buttons-group">
                    <button id="openDiuresisCalculatorButton" data-action="openModal" data-target="diuresisCalculatorModalOverlay" class="add-button">Diureskalkylator</button>
                    <button id="openNutritionCalculatorButton" data-action="openModal" data-target="nutritionCalculatorModalOverlay" class="add-button">Nutritionskalkylator</button>
                </div>
                <button id="openCalculationsButton" data-action="openModal" data-target="calculationsModalOverlay" class="add-button">Beräkningar & Referensvärden</button>
                <!-- Nya knappar för Spara/Ladda -->
                <div class="file-buttons-group">
                    <button id="saveToFileButton" data-action="save" class="add-button">Spara till fil</button>
                    <input type="file" id="loadFromFileInput" style="display: none;" accept=".json">
                    <button id="loadFromFileButton" data-action="load" class="add-button">Ladda från fil</button>
                </div>
            </div>

            <!-- NY KOLUMN: Sammanställning -->
            <div class="grid-column-item">
                <h3>Sammanställning</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding: 4px; border-bottom: 1px solid #ddd;">Post</th>
                            <th style="text-align:right; padding: 4px; border-bottom: 1px solid #ddd;">Volym (ml)</th>
                            <th style="text-align:right; padding: 4px; border-bottom: 1px solid #ddd;">Kcal</th>
                            <th style="text-align:right; padding: 4px; border-bottom: 1px solid #ddd;">Protein (g)</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <tr>
                            <td style="padding: 4px;">Totalt intag</td>
                            <td id="totalIntakeMl" style="text-align:right; padding: 4px;">0</td>
                            <td id="totalIntakeKcal" style="text-align:right; padding: 4px;">0</td>
                            <td id="totalIntakeProtein" style="text-align:right; padding: 4px;">0</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Totalt förlust</td>
                            <td id="totalLossMl" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px; font-weight: bold;">Netto balans</td>
                            <td id="netBalanceMl" style="text-align:right; padding: 4px; font-weight: bold;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Kumulativ balans</td>
                            <td id="cumulativeBalanceMl" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                             <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Differens mot utgångsvikt (kg)</td>
                            <td id="weightDifferenceKg" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                             <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <!-- Ny rad för timdiures -->
                        <tr>
                            <td style="padding: 4px;">
                                <div class="label-with-tooltip" style="justify-content: space-between;">
                                    <span>Genomsnittlig timdiures (ml/kg/h)</span>
                                    <span class="tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="tooltiptext">Visar den genomsnittliga urinproduktionen per kilo kroppsvikt och timme. Värdet blir rött om det understiger 0.5 ml/kg/h.</span>
                                    </span>
                                </div>
                            </td>
                            <td id="avgHourlyDiuresis" style="text-align:right; padding: 4px;">0.00</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                             <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal för Beräkningar & Referensvärden -->
    <div id="calculationsModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="calculationsModalOverlay">×</button>
            <h2>Beräkningar & Referensvärden</h2>
            <!-- New class for modal's inner grid to handle 3 columns -->
            <div class="grid-container modal-three-column-grid">
                <div class="grid-column-item">
                    <h3>Perspiratioberäkning</h3>
                    <p>Perspiratio beräknas utifrån en fast grundförlust per dygn som justeras med en temperaturfaktor. Det slutgiltiga värdet anpassas till den valda tidsperioden.</p>
                    <p><strong>Grundförlust (per 24 timmar):</strong></p>
                    <ul>
                        <li><strong>700 ml:</strong> Standard (Inget andningsstöd, NIV/HMEF, Intuberad/HMEF)</li>
                        <li><strong>500 ml:</strong> Vid viss befuktning (NIV/aktiv befuktning, HFNC)</li>
                        <li><strong>400 ml:</strong> Vid optimal befuktning (Intuberad/aktiv befuktning)</li>
                    </ul>
                    <p><strong>Temperaturjustering:</strong><br>Beräkningen baseras på patientens medeltemperatur under dygnet. En faktor beräknas enligt `1 + (Medeltemp - 37) * 0.25`. Vid extrem kroppstemperatur används en fast faktor (0.5 vid <35°C och 2.0 vid >41°C).</p>
                    <p><strong>Gränsvärden:</strong><br>Beräkning sker ej om patientens ålder är under 15 år eller vikt är under 50 kg. Perspiratio sätts då till 0 ml.</p>
                </div>
                <div class="grid-column-item">
                    <h3>Idealvikt & Justerad Idealvikt</h3>
                    <p><strong>Idealvikt (Devine-formeln):</strong></p>
                    <ul>
                        <li><strong>Män:</strong> 50 + 0.91 x (Längd i cm - 152.4)</li>
                        <li><strong>Kvinnor:</strong> 45.5 + 0.91 x (Längd i cm - 152.4)</li>
                    </ul>
                    <p><strong>Justerad Idealvikt:</strong> Används om patientens dagliga vikt överstiger den beräknade idealvikten med mer än 20%.</p>
                    <ul>
                        <li>Justerad vikt = Idealvikt + 0.4 * (Aktuell vikt - Idealvikt)</li>
                    </ul>
                    <p><em>Alla vikter avrundas till en decimal.</em></p>
                </div>
                <!-- Nya Kcal-sektioner -->
                <div class="grid-column-item" id="kcalKristalloiderContainer"></div>
                <div class="grid-column-item" id="kcalMedicineContainer"></div>
                <div class="grid-column-item" id="kcalTpnSondmatContainer"></div>
            </div>
        </div>
    </div>

    <!-- START Diureskalkylator Modal -->
    <div id="diuresisCalculatorModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="diuresisCalculatorModalOverlay">×</button>
            <h2>Diureskalkylator</h2>

            <!-- Instruktionsavsnitt -->
            <div class="grid-column-item" style="margin-bottom: 15px; grid-column: 1 / -1;">
                <h3>Instruktioner</h3>
                <p style="font-size: 0.8rem;">
                    Fyll i relevanta vätsketillförslar och vätskeförluster i <strong>huvudfliken</strong>.<br>
                    Fyll in önskad vätskebalans fram till kl 06:00 nästa dygn i detta avsnitt.<br>
                    Fyll in planerade framtida tillförslar/förluster i detta avsnitt.
                </p>
            </div>

            <div class="grid-container two-column-diuresis">
                <!-- Vänster kolumn: Grundläggande inställningar & mål + Aktuell balans (nuvarande tidpunkt) -->
                <div class="grid-column-item">
                    <h3>Grundläggande inställningar & mål</h3>
                    <div class="grid-item">
                        <label for="desiredBalanceTomorrow">Önskad vätskebalans (ml) fram till klockan 06:00 nästa dygn:</label>
                        <input type="text" id="desiredBalanceTomorrow" value="" placeholder="">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">*Lämna tomt eller ange 0 för att sikta på nollbalans.*</p>
                    </div>
                    <div class="grid-item">
                        <label for="diuresisCalcTime">Beräkning från klockslag:</label>
                        <div class="input-group">
                            <input type="time" id="diuresisCalcTime">
                            <button data-action="setNow" data-target="diuresisCalcTime">Nu</button>
                        </div>
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Tidpunkt du gör din beräkning.</p>
                    </div>
                </div>

                <!-- Höger kolumn: Planerad framtida balans -->
                <div class="grid-column-item">
                    <h3>Planerad framtida balans (från 'Beräkning från' till 06:00 nästa dygn)</h3>
                    <div class="grid-item">
                        <label for="remainingTimeTo0600">Tid kvar till 06:00 (timmar):</label>
                        <input type="text" id="remainingTimeTo0600" readonly class="calculated-output">
                    </div>
                    <div class="grid-item">
                        <label for="expectedPerspiratioRemaining">Förväntad Perspiratio (återstående till 06:00) (ml):</label>
                        <input type="text" id="expectedPerspiratioRemaining" readonly class="calculated-output">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Beräknad perspiratio för återstående tid. Justeras automatiskt baserat på data från huvudfliken.</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedSingleIntake">Förväntad vätsketillförsel (engångsdoser) (ml):</label>
                        <input type="text" id="plannedSingleIntake" value="" placeholder="">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Planerade enstaka infusioner/vätskor.</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedHourlyIntake">Förväntad vätsketillförsel per timma (ml/h):</label>
                        <input type="text" id="plannedHourlyIntake" value="" placeholder="">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Kontinuerliga dropp (ex. Propofol, Noradrenalin).</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedSingleLosses">Förväntade övriga förluster (engångsförluster) (ml):</label>
                        <input type="text" id="plannedSingleLosses" value="" placeholder="">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Planerade/förväntade enstaka förluster.</p>
                    </div>
                </div>
            </div>

            <!-- Resultat och Diuresbehov -->
            <div class="grid-column-item" style="margin-top: 15px; grid-column: 1 / -1;">
                <h3>Resultat och Diuresbehov</h3>
                <table class="diuresis-summary-table" style="width:100%; border-collapse: collapse;">
                    <tbody>
                        <tr>
                            <td colspan="2" class="category-heading">Aktuella Värden (från Huvudfliken)</td>
                        </tr>
                        <tr>
                            <td>Aktuell vätskebalans (ml)</td>
                            <td id="summaryBalanceTillNow" style="text-align:right;">0</td>
                        </tr>

                        <tr>
                            <td colspan="2" class="category-heading" style="margin-top: 15px;">Planerade Framtida Värden (från nu till 06:00 nästa dygn)</td>
                        </tr>
                        <tr>
                            <td>Tid kvar till 06:00 (timmar)</td>
                            <td id="summaryRemainingHoursFuture" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntad engångstillförsel (ml)</td>
                            <td id="summaryPlannedSingleIntakeSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Total förväntad kontinuerlig tillförsel (<span id="plannedHourlyIntakeDisplay">0</span> ml/h x <span id="remainingHoursDisplay">0</span> timmar)</td>
                            <td id="summaryPlannedHourlyIntakeTotal" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntade engångsförluster (ml)</td>
                            <td id="summaryPlannedSingleLossesSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntad perspiratio (ml)</td>
                            <td id="summaryExpectedPerspiratioRemainingSummary" style="text-align:right;">0</td>
                        </tr>

                        <tr>
                            <td colspan="2" class="category-heading" style="margin-top: 15px;">Sammanställda Beräkningar & Diuresbehov</td>
                        </tr>
                        <tr>
                            <td>Önskad vätskebalans vid 06:00 nästa dygn (ml)</td>
                            <td id="summaryDesiredBalanceTomorrowSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Beräknad total tillförsel (till 06:00 nästa dygn) (ml)</td>
                            <td id="summaryTotalCalculatedIntake" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Beräknade totala förluster (exkl. Diures) (till 06:00 nästa dygn) (ml)</td>
                            <td id="summaryTotalCalculatedLossExclDiuresis" style="text-align:right;">0</td>
                        </tr>
                        <tr class="highlight-row">
                            <td>Diuresbehov per timma (för återstående tid) (ml/h)</td>
                            <td id="diuresisNeedPerHour" style="text-align:right;">0</td>
                        </tr>
                    </tbody>
                </table>
                 <div class="grid-item" style="margin-top: 15px; text-align: center;">
                    <label for="includeDiuresisGoalInPrint" style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="includeDiuresisGoalInPrint">
                        Inkludera diuresbehov i utskriften
                    </label>
                </div>
            </div>

            <button data-action="closeModal" data-target="diuresisCalculatorModalOverlay" class="add-button" style="margin-top: 15px;">Tillbaka till Vätskebalans</button>
        </div>
    </div>
    <!-- END Diureskalkylator Modal -->

    <!-- START Detaljerad Sammanställning Modal -->
    <div id="printDetailedSummaryModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="printDetailedSummaryModalOverlay">×</button>
            <h2>Vätskebalansräkning</h2>

            <div class="summary-grid-container">
                <div>
                    <div class="patient-label-placeholder">klistra patientetikett här</div>
                    <h3>Vikter</h3>
                    <table class="summary-table">
                        <tr>
                            <td>Utgångsvikt/torrvikt:</td>
                            <td id="printInitialWeight" class="numeric-value"></td>
                        </tr>
                        <tr>
                            <td>Dagens vikt:</td>
                            <td id="printDailyWeight" class="numeric-value"></td>
                        </tr>
                        <tr>
                            <td id="printIdealWeightLabel">Idealvikt:</td>
                            <td id="printIdealWeight" class="numeric-value"></td>
                        </tr>
                        <tr>
                            <td>Differens mot utgångsvikt:</td>
                            <td id="printWeightDifference" class="numeric-value"></td>
                        </tr>
                        <tr>
                            <td>Gårdagens kumulativa balans:</td>
                            <td id="printCumulativeBalancePrev" class="numeric-value"></td>
                        </tr>
                    </table>
                </div>
                <div>
                    <div class="summary-info-box">
                        <p><strong>Datum:</strong> <span id="summaryDatePrint"></span></p>
                        <p><strong>Tidsperiod:</strong> <span id="summaryTimePeriodPrint"></span></p>
                        <p><strong>Plats:</strong> <span id="summaryLocationPrint"></span></p>
                    </div>
                    <h3>Sammanställning</h3>
                    <table class="summary-table">
                        <tr>
                            <td>Totalt vätskeintag:</td>
                            <td id="printTotalIntakeMl" class="numeric-value"></td>
                        </tr>
                        <tr>
                            <td>Total vätskeförlust:</td>
                            <td id="printTotalLossMl" class="numeric-value"></td>
                        </tr>
                        <tr class="highlight-row-print">
                            <td>Nettobalans:</td>
                            <td id="printNetBalanceMl" class="numeric-value"></td>
                        </tr>
                        <tr class="highlight-row-print">
                            <td>Kumulativ balans:</td>
                            <td id="printCumulativeBalanceMl" class="numeric-value"></td>
                        </tr>
                        <tr class="highlight-row-print">
                            <td>Totalt kaloriintag:</td>
                            <td id="printTotalKcalIntake" class="numeric-value"></td>
                        </tr>
                        <tr class="highlight-row-print">
                            <td>Totalt proteinintag:</td>
                            <td id="printTotalProteinIntake" class="numeric-value"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Ny sektion för detaljerad lista -->
            <div id="print-details-container" class="details-grid-container">
                <div id="print-details-intake"></div>
                <div id="print-details-loss"></div>
            </div>

            <!-- Utskriftsknapp -->
            <button class="add-button" style="margin-top: 20px;" data-action="print">Skriv ut</button>
        </div>
    </div>
    <!-- END Detaljerad Sammanställning Modal -->

    <!-- START Nutritionskalkylator Modal -->
    <div id="nutritionCalculatorModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="nutritionCalculatorModalOverlay">×</button>
            <h2>Nutritionskalkylator</h2>

            <div id="nutritionDataWarning" class="grid-column-item" style="display: none; background-color: #fff5f5; border-color: #ffdddd;">
                <p style="font-size: 0.9rem; color: #d32f2f; text-align: center;">Var god fyll i längd, kön och dagens vikt i huvudfliken för att använda kalkylatorn.</p>
            </div>

            <div id="nutritionCalculatorContent">
                 <div class="grid-column-item">
                     <h3>Beräkningsvikt</h3>
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                         <div class="grid-item">
                             <label>Beräkningsvikt baseras på:</label>
                             <div>
                                 <label style="display:inline-block; margin-right: 15px;">
                                     <input type="radio" name="calculationWeightSource" value="ideal" checked> Idealvikt
                                 </label>
                                 <label style="display:inline-block; margin-right: 15px;">
                                     <input type="radio" name="calculationWeightSource" value="daily"> Dagens vikt
                                 </label>
                                 <label style="display:inline-block;">
                                     <input type="radio" name="calculationWeightSource" value="custom"> Annat
                                 </label>
                             </div>
                         </div>
                         <div class="grid-item" style="display: flex; flex-direction: column; justify-content: center; gap: 10px;">
                            <label><input type="checkbox" id="applyFeverAdjustment" checked> Feberjustering</label>
                            <label><input type="checkbox" id="applyBmiAdjustment" checked> BMI-justering</label>
                         </div>
                         <div class="grid-item">
                             <label id="nutritionFinalCalculationWeightLabel" for="nutritionFinalCalculationWeight">Beräkningsvikt för nutrition (kg):</label>
                             <input type="text" id="nutritionFinalCalculationWeight" class="calculated-output">
                         </div>
                         <div class="grid-item">
                             <label for="bmiDisplay">BMI:</label>
                             <div style="display: flex; align-items: center; gap: 10px;">
                                 <input type="text" id="bmiDisplay" readonly class="calculated-output" style="flex-grow: 1;">
                                 <span id="bmiCategory" class="adjusted-weight-notice" style="color: #dc3545; flex-shrink: 0;"></span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="grid-column-item">
                     <h3>Dygnsbehov</h3>
                     <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                         <div class="grid-item">
                             <label>Nutritionsnivå & Kalorimål</label>
                             <button data-action="openModal" data-target="nutritionLevelModalOverlay" class="add-button" style="margin-top:0; width: 100%; background-color: #6c757d;">Välj nutritionsnivå</button>
                             <div id="nutritionLevelDisplay" style="padding: 6px; font-weight: bold; min-height: 24px; margin-top: 10px;">Inget valt</div>
                             <div class="slider-container">
                                <input type="range" id="kcalSlider" min="0" max="35" step="5" value="0" disabled>
                                <span id="kcalSliderValue">0 kcal/kg</span>
                             </div>
                             <div id="kcalGoalDisplay" style="font-weight: bold; font-size: 1.2em; padding: 6px; margin-top: 5px;">Mål: 0 kcal/dygn</div>
                             <span id="kcalFeverWarning" class="adjusted-weight-notice" style="color: #dc3545; display: none;"></span>
                             <input type="hidden" id="selectedNutritionLevel">
                             <input type="hidden" id="selectedNutritionLevelKcal" value="">
                         </div>
                         <div class="grid-item">
                            <label>Proteinnivå & Mål</label>
                             <button data-action="openModal" data-target="proteinLevelModalOverlay" class="add-button" style="margin-top:0; width: 100%; background-color: #6c757d;">Välj proteinnivå</button>
                            <div id="proteinLevelDisplay" style="padding: 6px; font-weight: bold; min-height: 24px; margin-top: 10px;">Inget valt</div>
                            <div class="slider-container">
                                <input type="range" id="proteinSlider" min="0" max="2.0" step="0.1" value="0" disabled>
                                <span id="proteinSliderValue">0.0 g/kg</span>
                             </div>
                             <div id="proteinGoalDisplay" style="font-weight: bold; font-size: 1.2em; padding: 6px; margin-top: 5px;">Mål: 0 g/dygn</div>
                             <span id="proteinBmiWarning" class="adjusted-weight-notice" style="color: #dc3545; display: none;">Proteinbehovet justeras ned till BMI 25</span>
                             <input type="hidden" id="selectedProteinLevel">
                             <input type="hidden" id="selectedProteinLevelValue" value="">
                         </div>
                         <div class="grid-item">
                             <label>Basalt vätskebehov</label>
                             <div style="visibility: hidden; pointer-events: none;">
                                 <div class="add-button" style="margin-top:0; width: 100%;">&nbsp;</div>
                                 <div style="padding: 6px; font-weight: bold; min-height: 24px; margin-top: 10px;">&nbsp;</div>
                             </div>
                              <div class="slider-container">
                                <input type="range" id="fluidSlider" min="0" max="40" step="1" value="30">
                                <span id="fluidSliderValue">30 ml/kg</span>
                             </div>
                             <div id="fluidGoalDisplay" style="font-weight: bold; font-size: 1.2em; padding: 6px; margin-top: 5px;">Mål: 0 ml/dygn</div>
                              <span id="fluidBmiWarning" class="adjusted-weight-notice" style="color: #dc3545; display: none;">Vätskebehovet justeras ned till BMI 25</span>
                              <span id="fluidFeverWarning" class="adjusted-weight-notice" style="color: #dc3545; display: none;"></span>
                         </div>
                     </div>
                 </div>

                 <!-- Ny sektion för planering -->
                 <div class="grid-column-item">
                    <h3>Planera nutrition</h3>
                     <div class="grid-item" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                         <div>
                             <label for="nutritionPlanStartTime">Planera från (starttid):</label>
                             <div class="input-group">
                                 <input type="time" id="nutritionPlanStartTime" value="06:00">
                                 <button data-action="setNow" data-target="nutritionPlanStartTime">Nu</button>
                             </div>
                         </div>
                         <div>
                             <label for="nutritionPlanEndTime">Planera till (sluttid):</label>
                             <div class="input-group">
                                 <input type="time" id="nutritionPlanEndTime" value="06:00">
                                 <button data-action="setNow" data-target="nutritionPlanEndTime">Nu</button>
                             </div>
                         </div>
                         <p style="margin: 0 0 6px 0; font-size: 0.8rem;" id="nutritionPlanDuration">Planerad tid: 24.0 timmar</p>
                     </div>
                     <div class="planned-nutrition-section">
                         <div class="planned-nutrition-column">
                             <h4>Kontinuerlig nutrition</h4>
                             <div class="planned-nutrition-header">
                                 <div>Produkt</div>
                                 <div>Hastighet (ml/h)</div>
                                 <div></div>
                             </div>
                             <div id="plannedInfusionsContainer">
                                 <!-- Rader läggs till här -->
                             </div>
                             <button data-action="addPlannedNutrition" data-type="infusion" class="add-button">Lägg till nutrition</button>
                             <div class="planned-nutrition-summary">
                                 <p>Totalt kcal/h (kontinuerlig): <strong id="plannedInfusionTotalKcalPerHour">0</strong></p>
                                 <p>Totalt protein/h (kontinuerlig): <strong id="plannedInfusionTotalProteinPerHour">0.0</strong></p>
                             </div>
                         </div>
                         <div class="planned-nutrition-column">
                             <h4>Intermittent nutrition</h4>
                             <div class="planned-bolus-header">
                                 <div>Produkt</div>
                                 <div>Total mängd (ml)</div>
                                 <div></div>
                             </div>
                             <div id="plannedBolusesContainer">
                                 <!-- Rader läggs till här -->
                             </div>
                             <button data-action="addPlannedNutrition" data-type="bolus" class="add-button">Lägg till nutrition</button>
                             <div class="planned-nutrition-summary">
                                 <p>Totalt kcal (intermittent): <strong id="plannedBolusTotalKcal">0</strong></p>
                                 <p>Totalt protein (intermittent): <strong id="plannedBolusTotalProtein">0.0</strong></p>
                             </div>
                         </div>
                     </div>
                     <div id="nutritionPrognosis">
                         <h4>Prognos för planerad period</h4>
                         <p>Totalt planerat kcal: <strong id="plannedTotalKcal">0</strong></p>
                         <p>Totalt planerat protein: <strong id="plannedTotalProtein">0.0</strong> g</p>
                         <hr style="border: none; border-top: 1px solid var(--border-color); margin: 6px 0;">
                         <p>Beräknat totalt intag (nuvarande + planerat):</p>
                         <p style="padding-left: 10px;">Kalorier: <strong id="prognosisTotalKcal">0</strong> kcal (<strong id="prognosisTotalKcalPercent">0%</strong> av mål)</p>
                         <p style="padding-left: 10px;">Protein: <strong id="prognosisTotalProtein">0.0</strong> g (<strong id="prognosisTotalProteinPercent">0%</strong> av mål)</p>
                         <p style="font-size: 0.7rem; margin-top: 8px; color: #888;">* Prognosen är en beräkning baserad på angivna värden och tar ej hänsyn till avbrott, maxhastigheter etc.</p>
                     </div>
                 </div>


                 <div class="grid-column-item" style="background-color: var(--result-bg); border-color: var(--result-border); grid-column: 1 / -1;">
                    <h3>Resultat (nuvarande intag)</h3>
                    <div id="nutritionResultContent">
                        <div class="result-item">
                            <span class="result-label">Energiintag</span>
                            <span class="result-value" id="energyResultValue">0 kcal</span>
                            <span class="result-percent" id="energyResultPercent">(0% av mål)</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Proteintillförsel</span>
                            <span class="result-value" id="proteinResultValue">0 g</span>
                            <span class="result-percent" id="proteinResultPercent">(0% av mål)</span>
                        </div>
                         <div class="result-item">
                            <span class="result-label">Total Vätsketillförsel</span>
                            <span class="result-value" id="fluidResultValue">0 ml</span>
                            <span class="result-percent" id="fluidResultPercent">(0% av basalbehov)</span>
                        </div>
                    </div>
                </div>
            </div>
             <p style="text-align: center; font-size: 0.8rem; margin-top: 20px; grid-column: 1 / -1;">
                Nutritionskalkylatorn utgår från styrdokumentet
                <a href="https://mellanarkiv-offentlig.vgregion.se/alfresco/s/archive/stream/public/v1/source/available/SOFIA/SKAS9696-242963441-9/SURROGATE/Nutrition%20-%20intensivvård.pdf" target="_blank" rel="noopener noreferrer" class="changelog-link">
                    Nutrition - Intensivvård
                </a>.
            </p>
        </div>
    </div>
    <!-- END Nutritionskalkylator Modal -->

    <!-- START Nutrition Level Modal -->
    <div id="nutritionLevelModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="nutritionLevelModalOverlay">×</button>
            <h2>Välj Nutritionsnivå</h2>
            <div class="nutrition-level-options">
                <!-- Level 0 -->
                <label class="nutrition-level-option">
                    <input type="radio" name="nutritionLevel" value="Nivå 0: Resusciteringsfas (5-10 kcal/kg)" data-kcal="10">
                    <strong>Nivå 0: Resusciteringsfas (5-10 kcal/kg)</strong>
                    <p>Svår respiratorisk och cirkulatorisk svikt, t.ex. överhängande intubationsrisk, svår SIRS, CO2-retention, massivt inotropt-, volyms- eller vasopressorbehov. Enbart kristalloid vätskeersättning och ev. 5-10% glukos.</p>
                </label>
                <!-- Level 1 -->
                <label class="nutrition-level-option">
                    <input type="radio" name="nutritionLevel" value="Nivå 1: Akut instabil fas (15 kcal/kg)" data-kcal="15">
                    <strong>Nivå 1: Akut instabil fas (15 kcal/kg)</strong>
                    <p>Fortsatt högt syrgasbehov och adrenergt stöd, men inget överhängande respiratoriskt eller cirkulatoriskt hot. Patient med djup sedation. Bör kunna startas dag 1-2 om ej extremt instabil.</p>
                </label>
                <!-- Level 2 -->
                 <label class="nutrition-level-option">
                    <input type="radio" name="nutritionLevel" value="Nivå 2: Akut stabil fas (20 kcal/kg)" data-kcal="20">
                    <strong>Nivå 2: Akut stabil fas (20 kcal/kg)</strong>
                    <p>Patienten fortsätter förbättras och där nutrition redan startats på nivå 1. Bör kunna nås dygnet efter nivå 1.</p>
                </label>
                <!-- Level 3 -->
                 <label class="nutrition-level-option">
                    <input type="radio" name="nutritionLevel" value="Nivå 3: Tidig återuppbyggnadsfas (25 kcal/kg)" data-kcal="25">
                    <strong>Nivå 3: Tidig återuppbyggnadsfas (25 kcal/kg)</strong>
                    <p>Tillståndet börjar vända. Stabilt syrgas- respektive inotropi-/vasopressorbehov.</p>
                </label>
                <!-- Level 4 -->
                 <label class="nutrition-level-option">
                    <input type="radio" name="nutritionLevel" value="Nivå 4: Återhämtningsfas (30-35 kcal/kg)" data-kcal="30">
                    <strong>Nivå 4: Återhämtningsfas (30-35 kcal/kg)</strong>
                    <p>Återhämtnings-/mobiliseringsfas. Ökande energibehov.</p>
                </label>
            </div>
            <button id="selectNutritionLevelButton" data-action="selectNutritionLevel" class="add-button" style="margin-top: 20px;" disabled>Välj</button>
        </div>
    </div>
    <!-- END Nutrition Level Modal -->

     <!-- START Protein Level Modal -->
    <div id="proteinLevelModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="proteinLevelModalOverlay">×</button>
            <h2>Välj Patientgrupp för Proteinbehov</h2>
            <div class="nutrition-level-options">
                <label class="nutrition-level-option">
                    <input type="radio" name="proteinLevel" value="Standard IVA-patient (1,3-1,5g/kg/dygn)" data-protein="1.4">
                    <strong>Standard IVA-patient (1,3-1,5g/kg/dygn)</strong>
                </label>
                 <label class="nutrition-level-option">
                    <input type="radio" name="proteinLevel" value="Brännskador, IHD, trauma (1,5-2g/kg/dygn)" data-protein="1.75">
                    <strong>Brännskador, IHD, trauma (1,5-2g/kg/dygn)</strong>
                </label>
                 <label class="nutrition-level-option">
                    <input type="radio" name="proteinLevel" value="Obesitas (BMI > 30)" data-protein="2.0">
                    <strong>Obesitas (BMI > 30) (2,0-2,5 g/kg/dygn)</strong>
                </label>
                 <label class="nutrition-level-option">
                    <input type="radio" name="proteinLevel" value="Kronisk njursvikt utan dialys (0,6g/kg/dygn)" data-protein="0.6">
                    <strong>Kronisk njursvikt utan dialys (0,6g/kg/dygn)</strong>
                </label>
            </div>
            <button id="selectProteinLevelButton" data-action="selectProteinLevel" class="add-button" style="margin-top: 20px;" disabled>Välj</button>
        </div>
    </div>
    <!-- END Protein Level Modal -->

    <!-- Nytt: Modal för Ändringslogg -->
    <div id="changelogModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="changelogModalOverlay">×</button>
            <h2>Ändringslogg / Versioner</h2>
            <h3>Version 2.4</h3>
            <ul>
                <li><b>Lagt till nutritionskalkylator.</b></li>
                <li><b>Lagt till mörkt tema.</b></li>
            </ul>
            <h3>Version 2.3</h3>
            <ul>
                <li><b>Ökat teckenstorleken i utskrift.</b></li>
                <li><b>Ändrat från maxtemperatur till medeltemperatur i perspiratioberäkningen.</b></li>
                <li><b>Förbättrad användarvänlighet med tooltips.</b></li>
                <li><b>Smidigare inmatning för "Övrigt".</b></li>
                <li><b>Tydligare standardvärden.</b></li>
                <li><b>Utökad utskrift med timdiures.</b></li>
                <li><b>Justerat kaloriantal för propofol och lagt till källhänvisning.</b></li>
            </ul>
            <p style="font-size: 0.8rem; margin-top: 20px;">Feedback/input till johpa15@vgregion.se</p>
        </div>
    </div>

    <!-- Nytt: Modal för bekräftelse -->
    <div id="confirmationModalOverlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <h3>Rensa allt?</h3>
            <p>Är du säker på att du vill rensa alla fält? Detta går inte att ångra.</p>
            <div class="file-buttons-group">
                <button id="confirmResetButton" data-action="resetAll" class="add-button reset-button">Ja, rensa</button>
                <button data-action="closeModal" data-target="confirmationModalOverlay" class="add-button">Avbryt</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <span class="changelog-link" data-action="openModal" data-target="changelogModalOverlay">
            Version 2.4 - Ändringslogg
        </span>
         <span id="theme-toggle" data-action="toggleTheme"><i class="fas fa-moon"></i></span>
    </footer>

    <script>
        const app = {
            state: {
                totalIntakeMl: 0, totalIntakeKcal: 0, totalLossMl: 0, netBalanceMl: 0, cumulativeBalanceMl: 0,
                weightDifferenceKg: 0, totalDiuresisMl: 0, totalPerspiratioMl: 0, totalOtherLossMl: 0,
                dailyWeight: 0, height: 0, gender: '', isUnder15: 'no', maxTemp: 37.0, breathingSupport: 'standard',
                mainAppStartTime: '06:00', mainAppEndTime: '06:00',
                patientDate: '', patientTimePeriod: '', patientLocation: '', initialWeight: 0, idealWeight: 0,
                adjustedWeight: false,
                avgHourlyDiuresis: 0,
                perspiratioWarning: '',
                naclSyringeVolume: 0,
                pressureSetVolume: 0,
                medicineCategoryTotals: { Sedering: 0, Antibiotika: 0, Vasoaktiva: 0, Övrigt: 0 },
                kcalSummary: { peroralt: 0, sondmat: 0, tpn: 0, ivMedicine: 0, intravenousTotal: 0 },
                totalIntakeProtein: 0,
                plannedNutrition: { // New state for planned nutrition
                    infusions: [],
                    boluses: [],
                    startTime: '06:00',
                    endTime: '06:00',
                    duration: 24,
                    totalInfusionKcalPerHour: 0,
                    totalInfusionProteinPerHour: 0,
                    totalBolusKcal: 0,
                    totalBolusProtein: 0,
                    plannedTotalKcal: 0,
                    plannedTotalProtein: 0,
                    prognosisTotalKcal: 0,
                    prognosisTotalProtein: 0,
                    prognosisTotalKcalPercent: 0,
                    prognosisTotalProteinPercent: 0
                }
            },
            counters: { fluid: 0, medicine: 0, bloodProduct: 0, tpnSondmat: 0, loss: 0, plannedInfusion: 0, plannedBolus: 0 },
            config: {
                fluid: {
                    containerId: 'fluidEntriesContainer',
                    template: (id) => `<div class="fluid-entry-row" data-id="${id}" data-type="fluid"><div class="grid-item"><div class="custom-input-wrapper"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Ange övrig vätska" style="display: none;"><button class="cancel-custom-input" data-action="cancelCustomInput" style="display: none;">&times;</button></div></div><div class="grid-item"><input type="text" class="ml-input" value="" placeholder=""></div><div class="grid-item"><input type="text" class="kcal-output" placeholder=""></div><div class="grid-item"><input type="text" class="protein-output" placeholder=""></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'fluid')
                },
                medicine: {
                    containerId: 'medicineEntriesContainer',
                    template: (id) => `<div class="fluid-entry-row" data-id="${id}" data-type="medicine"><div class="grid-item"><div class="custom-input-wrapper"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Övrigt lkm" style="display: none;"><button class="cancel-custom-input" data-action="cancelCustomInput" style="display: none;">&times;</button></div></div><div class="grid-item"><input type="text" class="ml-input" value="" placeholder=""></div><div class="grid-item"><input type="text" class="kcal-output" placeholder=""></div><div class="grid-item"><input type="text" class="protein-output" placeholder=""></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'medicine')
                },
                bloodProduct: {
                    containerId: 'bloodProductEntriesContainer',
                    template: (id) => `<div class="blood-product-entry-row" data-id="${id}" data-type="bloodProduct"><div class="grid-item"><select class="select-main"></select></div><div class="grid-item"><div class="input-with-tooltip"><input type="text" class="ml-input" value="" placeholder=""><span class="tooltip" style="display: none;"><i class="fas fa-info-circle"></i><span class="tooltiptext">Volymen för en enhet trombocyter är oftast cirka 200 ml, men kan variera. Kontrollera påsen.</span></span></div></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'bloodProduct')
                },
                tpnSondmat: {
                    containerId: 'tpnSondmatEntriesContainer',
                    template: (id) => `<div class="tpn-sondmat-entry-row" data-id="${id}" data-type="tpnSondmat"><div class="grid-item"><div class="custom-input-wrapper"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Övrigt" style="display: none;"><button class="cancel-custom-input" data-action="cancelCustomInput" style="display: none;">&times;</button></div></div><div class="grid-item"><input type="text" class="ml-input" value="" placeholder=""></div><div class="grid-item"><input type="text" class="kcal-output" placeholder=""></div><div class="grid-item"><input type="text" class="protein-output" placeholder=""></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'tpnSondmat')
                },
                loss: {
                    containerId: 'lossEntriesContainer',
                    template: (id) => `<div class="loss-entry-row" data-id="${id}" data-type="loss"><div class="grid-item"><div class="custom-input-wrapper"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Ange annan förlust" style="display: none;"><button class="cancel-custom-input" data-action="cancelCustomInput" style="display: none;">&times;</button></div></div><div class="grid-item"><input type="text" class="ml-input" value="" placeholder=""></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'loss')
                },
                plannedInfusion: { // Config for planned infusions
                    containerId: 'plannedInfusionsContainer',
                    template: (id) => `<div class="planned-nutrition-row" data-id="${id}" data-type="plannedInfusion"><div class="grid-item"><select class="select-main"></select></div><div class="grid-item"><input type="text" class="rate-input" placeholder="ml/h"></div><button class="remove-fluid-button" data-action="removePlannedNutrition"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'plannedInfusion')
                },
                plannedBolus: { // Config for planned boluses
                    containerId: 'plannedBolusesContainer',
                    template: (id) => `<div class="planned-nutrition-row" data-id="${id}" data-type="plannedBolus"><div class="grid-item"><select class="select-main"></select></div><div class="grid-item"><input type="text" class="amount-input" placeholder="ml"></div><button class="remove-fluid-button" data-action="removePlannedNutrition"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'plannedBolus')
                }
            },
            data: {
                fluid: {
                    placeholder: 'Välj vätska', customOption: 'Övrig vätska',
                    categories: {
                        "Rena Glucoslösningar": [
                            { name: "Glukos 2.5%", kcal: 0.1 },
                            { name: "Glukos 5%", kcal: 0.2 },
                            { name: "Glukos 10%", kcal: 0.4 },
                            { name: "Glukos 20%", kcal: 0.8 },
                            { name: "Glukos 30%", kcal: 1.2 }
                        ],
                        "Kolloider": [{ name: "Albumin 20%", kcal: 0.8, protein: 0.2 }, { name: "Albumin 5%", kcal: 0 }],
                        "Elektrolytlösningar": [
                            { name: "Glukos 5% med El", kcal: 0.2 },
                            { name: "Glukos 10% med El", kcal: 0.4 },
                            { name: "NaCl Picco-Kalibrering", kcal: 0 },
                            { name: "Natriumbikarbonat 50 mg/ml", kcal: 0 },
                            { name: "Natriumklorid 9 mg/ml", kcal: 0 },
                            { name: "Natriumklorid hyperton", kcal: 0 },
                            { name: "Plasmolyte", kcal: 0 },
                            { name: "Ringer-Acetat", kcal: 0 }
                        ]
                    }
                },
                medicine: {
                    placeholder: 'Välj läkemedelsvätska', customOption: 'Övrigt läkemedel',
                    categories: {
                        "Sedering": [{ name: "Dexdor", kcal: 0 }, { name: "Esketamin", kcal: 0 }, { name: "Klonidin", kcal: 0 }, { name: "Midazolam", kcal: 0 }, { name: "Propofol 10mg/ml", kcal: 0.9 }, { name: "Propofol 20mg/ml", kcal: 0.9 }, { name: "Remifentanil", kcal: 0 }],
                        "Antibiotika": [{ name: "Pip/Taz 4g x 3", kcal: 0, defaultMl: 60 }, { name: "Vancomycin 1g x 1", kcal: 0, defaultMl: 270 }, { name: "Övrig Antibiotika", kcal: 0 }, { name: "Kaspofungin", kcal: 0, defaultMl: 250 }],
                        "Vasoaktiva": [{ name: "Adrenalin", kcal: 0 }, { name: "Argipressin", kcal: 0 }, { name: "Dobutamin", kcal: 0 }, { name: "Levosimendan", kcal: 0.2 }, { name: "Milrinon", kcal: 0 }, { name: "Noradrenalin", kcal: 0 }],
                        "Övrigt": [{ name: "Amiodarone", kcal: 0.2 }, { name: "EDA", kcal: 0 }, { name: "Kalium/Kaliumklorid", kcal: 0 }, { name: "Lispro", kcal: 0 }, { name: "Paracetamol", kcal: 0 }]
                    }
                },
                bloodProduct: { placeholder: 'Välj blodprodukt', options: ['Erytrocyter', 'Trombocyter', 'Plasma'] },
                tpnSondmat: {
                    placeholder: 'Välj TPN/Sondmat/Näringsdryck/Peroralt', customOption: 'Övrigt',
                    categories: {
                         "TPN": [
                            { name: "Smof Kabiven 900 kcal extra nitrogen", kcal: 0.9, protein: 0.066 },
                            { name: "Smof Kabiven 1100 kcal", kcal: 1.12, protein: 0.051 },
                            { name: "Smof Kabiven PI 1300 kcal", kcal: 0.68 },
                            { name: "Smof Kabiven 1350 kcal extra nitrogen", kcal: 0.9, protein: 0.065 },
                            { name: "Smof Kabiven 1600 kcal", kcal: 1.08, protein: 0.051 },
                            { name: "Smof Kabiven 1800 extra nitrogen", kcal: 1.1, protein: 0.066 },
                            { name: "Smof Kabiven 2200 kcal", kcal: 1.12, protein: 0.051 },
                            { name: "Smof Kabiven perifer", kcal: 0.7, protein: 0.032}
                        ],
                        "Sondmat": [
                            { name: "Vatten i sond", kcal: 0 },
                            { name: "Sondmat Fresubin 2 kcal HP", kcal: 2.0, protein: 0.1 },
                            { name: "Sondmat Fresubin Original", kcal: 1, protein: 0.038 },
                            { name: "Sondmat Isosource standardfibre", kcal: 1 }
                        ],
                        "Näringsdryck": [
                            { name: "Fresubin PRO drink", kcal: 2.4, protein: 0.144 },
                            { name: "Fresubin Diben", kcal: 1.5, protein: 0.075 },
                            { name: "Fresubin Xtra", kcal: 1.5, protein: 0.04 },
                            { name: "Fresubin Thickened II", kcal: 1.5, protein: 0.1 },
                            { name: "Calogen extra shot", kcal: 4.0, protein: 0.05 }
                        ],
                        "Peroralt": [
                            { name: "Peroralt intag", kcal: 0 }
                        ]
                    }
                },
                loss: { placeholder: 'Välj förlusttyp', customOption: 'Annan förlust', options: ['Avföring', 'Blödning', 'Dialys (CRRT)', 'Dialys (IHD)', 'Diures', 'Drän 1', 'Drän 2', 'Drän 3', 'Kräkning', 'Sond', 'Stomi', 'Thoraxdrän hö', 'Thoraxdrän vä', 'VAC-pump'] },
                // Options for the planning section
                plannedInfusion: {
                     placeholder: 'Välj infusion', customOption: 'Övrigt (kontinuerlig)',
                     options: [] // Populated in init
                },
                plannedBolus: {
                    placeholder: 'Välj produkt', customOption: 'Övrigt (intermittent)',
                    options: [] // Populated in init
                }
            },
            init() {
                this.cacheDOMElements();
                // Populate options for planning dropdowns after data is defined
                this.data.plannedInfusion.options = [
                    ...this.data.tpnSondmat.categories.TPN,
                    ...(this.data.tpnSondmat.categories.Sondmat.filter(item => item.name !== "Vatten i sond")), // Include sondmat except water
                    ...this.data.fluid.categories["Rena Glucoslösningar"],
                    ...(this.data.medicine.categories.Sedering.filter(item => item.name.includes('Propofol')))
                ];
                 this.data.plannedBolus.options = [
                     ...(this.data.tpnSondmat.categories.Sondmat.filter(item => item.name !== "Vatten i sond")), // Include sondmat except water
                    ...this.data.tpnSondmat.categories.Näringsdryck,
                    ...this.data.tpnSondmat.categories.Peroralt
                ];

                this.loadTheme();
                this.bindEvents();
                this.setDefaultValues();
                this.addInitialRows();
                this.checkInitialInputColors();
                this.updateAllCalculations(); // Initial calculation
            },
            cacheDOMElements() {
                this.dom = {
                    body: document.body,
                    themeToggle: document.getElementById('theme-toggle'),
                    dateInput: document.getElementById('dateInput'),
                    otherLocationInput: document.getElementById('otherLocationInput'),
                    loadFromFileInput: document.getElementById('loadFromFileInput'),
                    perspiratioWarning: document.getElementById('perspiratioWarning'),
                    containers: {
                        fluid: document.getElementById('fluidEntriesContainer'),
                        medicine: document.getElementById('medicineEntriesContainer'),
                        bloodProduct: document.getElementById('bloodProductEntriesContainer'),
                        tpnSondmat: document.getElementById('tpnSondmatEntriesContainer'),
                        loss: document.getElementById('lossEntriesContainer'),
                        plannedInfusion: document.getElementById('plannedInfusionsContainer'), // New container
                        plannedBolus: document.getElementById('plannedBolusesContainer')       // New container
                    },
                    summary: {
                        totalIntakeMl: document.getElementById('totalIntakeMl'),
                        totalIntakeKcal: document.getElementById('totalIntakeKcal'),
                        totalIntakeProtein: document.getElementById('totalIntakeProtein'),
                        totalLossMl: document.getElementById('totalLossMl'),
                        netBalanceMl: document.getElementById('netBalanceMl'),
                        cumulativeBalanceMl: document.getElementById('cumulativeBalanceMl'),
                        weightDifferenceKg: document.getElementById('weightDifferenceKg'),
                        avgHourlyDiuresis: document.getElementById('avgHourlyDiuresis'),
                    },
                    nutritionPlan: null // Will be cached when modal opens
                };
            },
            setDefaultValues() {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                this.dom.dateInput.value = yesterday.toISOString().split('T')[0];
                document.getElementById('naclSyringes').value = '0';
                document.getElementById('pressureSets').value = '0';
                 // Set default times for main app if not already set (e.g., after reset)
                 if (!document.getElementById('startTime').value) document.getElementById('startTime').value = '06:00';
                 if (!document.getElementById('endTime').value) document.getElementById('endTime').value = '06:00';
            },
            addInitialRows() {
                // Only add if the container is empty (prevent duplicates on reset)
                 if (this.dom.containers.loss && !this.dom.containers.loss.querySelector('[data-id="loss_1"]')) {
                    this.addRow('loss', { selectValue: 'Diures', isInitial: true });
                 }
            },
            checkInitialInputColors() {
                document.querySelectorAll('.important-input, .filled-input').forEach(input => {
                    this.updateInputColor(input);
                });
            },
            updateInputColor(inputElement) {
                const hasValue = inputElement.value.trim() !== '' && (inputElement.id !== 'dailyWeight' || inputElement.value.trim() !== '0');
                if (hasValue) {
                    inputElement.classList.add('filled-input');
                    inputElement.classList.remove('important-input');
                } else {
                    inputElement.classList.remove('filled-input');
                    inputElement.classList.add('important-input');
                }
            },
            bindEvents() {
                this.dom.body.addEventListener('click', this.handleDelegatedClick.bind(this));
                const mainContent = document.querySelector('body');
                // Use event delegation for input/change on main content
                mainContent.addEventListener('input', this.handleFormInput.bind(this));
                mainContent.addEventListener('change', this.handleFormInput.bind(this));

                mainContent.addEventListener('blur', (e) => {
                    if (e.target.matches('input[type="text"]')) this.handleFormulaInput(e);
                }, true);
                mainContent.addEventListener('keydown', (e) => {
                    if (e.target.matches('input[type="text"]') && e.key === 'Enter') {
                        e.preventDefault();
                        this.handleFormulaInput(e);
                        e.target.blur();
                    }
                });
                this.dom.loadFromFileInput.addEventListener('change', this.loadDataFromFile.bind(this));

                // Modal specific event listeners
                const nutritionLevelModal = document.getElementById('nutritionLevelModalOverlay');
                if (nutritionLevelModal) {
                    nutritionLevelModal.addEventListener('change', (e) => {
                        if (e.target.name === 'nutritionLevel') {
                            document.getElementById('selectNutritionLevelButton').disabled = false;
                            nutritionLevelModal.querySelectorAll('.nutrition-level-option').forEach(opt => opt.classList.remove('selected'));
                            e.target.closest('.nutrition-level-option').classList.add('selected');
                        }
                    });
                }

                const proteinLevelModal = document.getElementById('proteinLevelModalOverlay');
                 if (proteinLevelModal) {
                    proteinLevelModal.addEventListener('change', (e) => {
                        if (e.target.name === 'proteinLevel') {
                            document.getElementById('selectProteinLevelButton').disabled = false;
                            proteinLevelModal.querySelectorAll('.nutrition-level-option').forEach(opt => opt.classList.remove('selected'));
                            e.target.closest('.nutrition-level-option').classList.add('selected');
                        }
                    });
                }

                const kcalSlider = document.getElementById('kcalSlider');
                if(kcalSlider) {
                    kcalSlider.addEventListener('input', this.updateNutritionGoal.bind(this));
                }
                const proteinSlider = document.getElementById('proteinSlider');
                if(proteinSlider) {
                    proteinSlider.addEventListener('input', this.updateProteinGoal.bind(this));
                }
                const fluidSlider = document.getElementById('fluidSlider');
                if(fluidSlider) {
                    fluidSlider.addEventListener('input', this.updateFluidGoal.bind(this));
                }

                // Listeners specific to the nutrition planning time inputs - move binding to openModal
            },

            handleDelegatedClick(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const { action, target: targetId, delta, type } = target.dataset;
                let shouldRecalculateAll = false; // Flag to recalculate all at the end if needed

                switch (action) {
                    case 'setNow':
                         this.setNow(targetId);
                         // If the target is one of the planning times, only recalc planned
                         if (targetId === 'nutritionPlanStartTime' || targetId === 'nutritionPlanEndTime') {
                             this.calculatePlannedNutrition();
                         } else {
                            shouldRecalculateAll = true; // Otherwise, likely needs full recalc
                         }
                         break;
                    case 'changeNumber':
                        this.changeNumber(targetId, parseInt(delta, 10));
                        shouldRecalculateAll = true;
                        break;
                    case 'addRow':
                        this.addRow(type);
                        shouldRecalculateAll = true;
                        break;
                    case 'removeRow':
                        target.closest('[data-id]').remove();
                        shouldRecalculateAll = true;
                        break;
                    case 'transferPerspiratio':
                         this.transferPerspiratioToLoss();
                         shouldRecalculateAll = true; // Persp value changed loss
                         break;
                    case 'openModal': this.openModal(targetId); break; // openModal handles its own calcs
                    case 'closeModal': this.closeModal(targetId); break;
                    case 'save': this.saveDataToFile(); break;
                    case 'load': this.dom.loadFromFileInput.click(); break; // load triggers recalc via populate
                    case 'print': window.print(); break;
                    case 'resetAll': this.resetAll(); break; // reset triggers recalc
                    case 'cancelCustomInput':
                         this.cancelCustomInput(target);
                         shouldRecalculateAll = true; // Value changed
                         break;
                    case 'selectNutritionLevel': this.selectNutritionLevel(); break; // Triggers recalc
                    case 'selectProteinLevel': this.selectProteinLevel(); break; // Triggers recalc
                    case 'toggleTheme': this.toggleTheme(); break;
                    case 'addPlannedNutrition':
                         this.addPlannedNutritionRow(type);
                         // No immediate recalc needed, happens on input in the new row
                         break;
                    case 'removePlannedNutrition':
                         target.closest('[data-id]').remove();
                         this.calculatePlannedNutrition(); // Only recalc planned nutrition
                         break;
                }
                 // If any action potentially changed totals, recalculate everything
                 // We avoid this inside loops or frequent events for performance
                 // if (shouldRecalculateAll) {
                 //    this.updateAllCalculations(); // Removed redundant call - handled by input/change now
                 // }
            },
            handleFormInput(e) {
                const target = e.target;

                 // Update colors for important/filled inputs
                if (target.matches('.important-input, .filled-input')) {
                    this.updateInputColor(target);
                }

                 // Handle nutrition calculator weight source changes
                 if(target.name === 'calculationWeightSource' || target.id === 'applyBmiAdjustment' || target.id === 'applyFeverAdjustment') {
                    this.updateNutritionCalculationWeight(); // This function now calls update goals
                }
                 if (target.id === 'nutritionFinalCalculationWeight') {
                     const customRadio = document.querySelector('input[name="calculationWeightSource"][value="custom"]');
                     if (customRadio) customRadio.checked = true;
                    this.updateNutritionGoal(); // Also update goals when custom weight changes
                    this.updateProteinGoal();
                    this.updateFluidGoal();
                    this.calculatePlannedNutrition(); // Update prognosis if weight changes
                }

                // Toggle "Other location" input
                if (target.id === 'bedSelect') {
                    this.dom.otherLocationInput.style.display = target.value === 'Annan plats' ? 'block' : 'none';
                }

                 // Reset manual override flag for perspiratio in diuresis calc if time changes
                 if (target.id === 'diuresisCalcTime') {
                     const perspInput = document.getElementById('expectedPerspiratioRemaining');
                     if (perspInput) perspInput.dataset.manualOverride = 'false';
                 }

                 // Handle input changes within main fluid/loss rows
                 const mainRow = target.closest('[data-type]:not([data-type^="planned"])');
                 if (mainRow) {
                     const kcalOutput = mainRow.querySelector('.kcal-output');
                     const proteinOutput = mainRow.querySelector('.protein-output');

                      // Handle manual override flags
                      if (kcalOutput) {
                          if (target.classList.contains('kcal-output')) {
                              kcalOutput.dataset.manualOverride = 'true';
                          } else if (target.classList.contains('select-main') || target.classList.contains('ml-input')) {
                               kcalOutput.dataset.manualOverride = 'false'; // Reset if selection or ml changes
                          }
                      }
                      if (proteinOutput) {
                           if (target.classList.contains('protein-output')) {
                               proteinOutput.dataset.manualOverride = 'true';
                           } else if (target.classList.contains('select-main') || target.classList.contains('ml-input')) {
                                proteinOutput.dataset.manualOverride = 'false'; // Reset if selection or ml changes
                           }
                      }

                     if (target.classList.contains('select-main')) {
                         const configData = this.data[mainRow.dataset.type];
                         if (configData && (configData.customOption || configData.customOption2)) {
                             const showCustom = target.value === configData.customOption || (configData.customOption2 && target.value === configData.customOption2);
                             this.toggleCustomInput(target.closest('.custom-input-wrapper') || target.parentElement, showCustom);
                         }

                         const selectedOption = target.options[target.selectedIndex];
                         const defaultMl = selectedOption.dataset.defaultMl;
                         const mlInput = mainRow.querySelector('.ml-input');
                         if (defaultMl && mlInput && !mlInput.value) { // Only set default if ml is empty
                             mlInput.value = defaultMl;
                         }

                         if (mainRow.dataset.type === 'bloodProduct') {
                             const tooltipSpan = mainRow.querySelector('.tooltip');
                             if (tooltipSpan) {
                                 tooltipSpan.style.display = target.value === 'Trombocyter' ? 'inline-block' : 'none';
                             }
                         }
                     }
                 }

                // Handle input changes within planned nutrition rows
                 const plannedRow = target.closest('[data-type^="planned"]');
                 if (plannedRow) {
                     this.calculatePlannedNutrition(); // Recalculate planned totals on any change within these rows
                 }
                  // Recalculate *everything* after any input/change event
                  // This ensures all derived values are updated consistently
                  this.updateAllCalculations();

            },
            handleFormulaInput(event) {
                const input = event.target;
                let value = input.value.trim();
                if (!value.startsWith('=')) return;
                const expression = value.substring(1);
                if (expression === '') return;
                try {
                    if (!/^[0-9+\-*/().\s]+$/.test(expression)) {
                        console.warn(`Invalid characters in formula: "${expression}"`);
                        return;
                    }
                    const result = new Function(`return ${expression}`)();
                    if (typeof result === 'number' && !isNaN(result)) {
                        input.value = Math.round(result);
                        input.dispatchEvent(new Event('input', { bubbles: true })); // Trigger update calculations
                    }
                } catch (e) {
                    console.error(`Error evaluating formula: "${expression}"`, e);
                }
            },
             // Handles adding rows for main sections (fluid, medicine, etc.)
             addRow(type, initialData = {}) {
                 const config = this.config[type];
                 if (!config || !this.dom.containers[type]) return; // Check if container exists
                 this.counters[type]++;
                 const id = `${type}_${this.counters[type]}`;
                 const container = this.dom.containers[type];
                 container.insertAdjacentHTML('beforeend', config.template(id));
                 const newRow = container.querySelector(`[data-id="${id}"]`);
                 const select = newRow.querySelector('.select-main');
                 if (select && config.populateSelect) {
                     config.populateSelect(select);
                 }

                  // Apply initial data if provided
                  if (Object.keys(initialData).length > 0) {
                      if (initialData.selectValue && select) {
                          select.value = initialData.selectValue;
                           // Trigger change event to handle custom input visibility if needed
                           select.dispatchEvent(new Event('change', { bubbles: true }));
                      }
                     const mlInput = newRow.querySelector('.ml-input');
                     if (mlInput && initialData.mlValue !== undefined) mlInput.value = initialData.mlValue;
                     const kcalOutput = newRow.querySelector('.kcal-output');
                     if (kcalOutput && initialData.kcalValue !== undefined) {
                         kcalOutput.value = initialData.kcalValue;
                         kcalOutput.dataset.manualOverride = 'true'; // Assume loaded value is manual
                     }
                     const proteinOutput = newRow.querySelector('.protein-output');
                     if (proteinOutput && initialData.proteinValue !== undefined) {
                          proteinOutput.value = initialData.proteinValue;
                          proteinOutput.dataset.manualOverride = 'true'; // Assume loaded value is manual
                     }

                     // Handle custom value for "Övrigt"
                     if (select && (select.value === config.customOption || (config.customOption2 && select.value === config.customOption2))) {
                          const customInput = newRow.querySelector('.custom-input');
                          if (customInput && initialData.customValue !== undefined) {
                              customInput.value = initialData.customValue;
                          }
                     }
                 }


                 if (!initialData.isInitial) { // Avoid recalc for the very first Diures row
                    this.updateAllCalculations();
                 }
             },
             // Modified addRow specifically for planned nutrition
              addPlannedNutritionRow(type, initialData = {}) {
                 const configKey = type === 'infusion' ? 'plannedInfusion' : 'plannedBolus';
                 const config = this.config[configKey];
                 const container = this.dom.containers[configKey]; // Use cached container

                  if (!config || !container) {
                      console.error("Config or container missing for planned nutrition type:", type);
                      return;
                  }

                 this.counters[configKey]++;
                 const id = `${configKey}_${this.counters[configKey]}`;
                 container.insertAdjacentHTML('beforeend', config.template(id));
                 const newRow = container.querySelector(`[data-id="${id}"]`);
                 const select = newRow.querySelector('.select-main');
                 if (select && config.populateSelect) {
                     config.populateSelect(select);
                 }

                 // Apply initial data if provided (for loading from file)
                 if (Object.keys(initialData).length > 0) {
                     if (select && initialData.selectValue !== undefined) {
                          select.value = initialData.selectValue;
                          select.dispatchEvent(new Event('change', { bubbles: true })); // Handle custom input if needed
                     }
                     const rateInput = newRow.querySelector('.rate-input');
                     if (rateInput && initialData.rateValue !== undefined) rateInput.value = initialData.rateValue;
                     const amountInput = newRow.querySelector('.amount-input');
                     if (amountInput && initialData.amountValue !== undefined) amountInput.value = initialData.amountValue;

                      // Handle custom value for "Övrigt"
                     if (select && (select.value === config.customOption)) {
                          const customInput = newRow.querySelector('.custom-input'); // Assuming custom input exists, add if needed
                          if (customInput && initialData.customValue !== undefined) {
                              customInput.value = initialData.customValue;
                          }
                     }
                 }

                  // No automatic recalculation here, it happens on input/change
             },
            populateSelect(selectElement, type) {
                const configData = this.data[type];
                if (!configData || !selectElement) return; // Add checks
                selectElement.innerHTML = ''; // Clear existing options
                this.addOption(selectElement, '', configData.placeholder || 'Välj...'); // Use placeholder

                // Add custom option first if it exists
                if (configData.customOption) {
                    this.addOption(selectElement, configData.customOption, configData.customOption, 0, null, 0);
                }
                 // Add custom option 2 if it exists (relevant for some main sections)
                 if (configData.customOption2) {
                     this.addOption(selectElement, configData.customOption2, configData.customOption2, 0, null, 0);
                 }


                // Add options from list (flatten if necessary, handle objects vs strings)
                 if (configData.options && Array.isArray(configData.options)) {
                     // Flatten potential category structure within options for planning lists
                     const flatOptions = configData.options.flatMap(opt =>
                         opt.items ? opt.items.map(item => ({ ...item, category: opt.category })) : opt
                     );

                     // Sort flat list alphabetically by name
                     flatOptions.sort((a, b) => (a.name || a).localeCompare(b.name || b));
                     flatOptions.forEach(opt => {
                         if (typeof opt === 'object' && opt.name) { // Ensure it's an object with a name
                             this.addOption(selectElement, opt.name, opt.name, opt.kcal, opt.defaultMl, opt.protein);
                         } else if (typeof opt === 'string') {
                             this.addOption(selectElement, opt, opt); // Handle simple string options
                         }
                     });
                 }


                // Add options from categories (for main sections)
                if (configData.categories) {
                    const sortedCategories = Object.keys(configData.categories).sort();
                    sortedCategories.forEach(categoryLabel => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = categoryLabel;
                        // Sort items within category alphabetically by name
                         if (Array.isArray(configData.categories[categoryLabel])) { // Check if category value is array
                            configData.categories[categoryLabel].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                            configData.categories[categoryLabel].forEach(item => {
                                this.addOption(optgroup, item.name, item.name, item.kcal, item.defaultMl, item.protein);
                            });
                         }
                        selectElement.appendChild(optgroup);
                    });
                }
            },
            addOption(parent, value, text, kcal = null, defaultMl = null, protein = null) {
                 if (!parent) return; // Prevent errors if parent doesn't exist
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (kcal !== null) option.dataset.kcalPerMl = kcal;
                if (defaultMl !== null) option.dataset.defaultMl = defaultMl;
                if (protein !== null) option.dataset.proteinPerMl = protein;
                parent.appendChild(option);
            },
            toggleCustomInput(wrapper, showCustom) {
                if (!wrapper) return;
                const select = wrapper.querySelector('.select-main');
                const input = wrapper.querySelector('.custom-input');
                const button = wrapper.querySelector('.cancel-custom-input');
                if (select) select.style.display = showCustom ? 'none' : 'block';
                if (input) input.style.display = showCustom ? 'block' : 'none';
                if (button) button.style.display = showCustom ? 'block' : 'none';
                if (showCustom && input) input.focus();
            },
            cancelCustomInput(button) {
                const wrapper = button.parentElement;
                 if (!wrapper) return;
                this.toggleCustomInput(wrapper, false);
                const select = wrapper.querySelector('select');
                 if (select) select.value = '';
                const input = wrapper.querySelector('input');
                 if (input) input.value = '';
                this.updateAllCalculations();
            },
            updateAllCalculations() {
                this.calculateIdealAndAdjustedWeight();
                this.calculatePerspiratio();
                this.calculateTotals(); // Calculates main totals and updates state
                this.calculateDiuresis();
                this.updateSummaryUI(); // Updates main summary table
                this.calculateBMI();
                this.updateNutritionCalculationWeight(); // Includes goal updates
                this.calculatePlannedNutrition(); // Calculates planned totals and updates prognosis section
                this.updateResults(); // Updates main result section based on state.totalIntake...
            },
            setNow(elementId) {
                const timeInput = document.getElementById(elementId);
                if (!timeInput) return;
                const now = new Date();
                timeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                 // Trigger both events to ensure calculations run
                timeInput.dispatchEvent(new Event('input', { bubbles: true }));
                timeInput.dispatchEvent(new Event('change', { bubbles: true }));
            },
            changeNumber(elementId, delta) {
                const input = document.getElementById(elementId);
                if (!input) return;
                input.value = (parseFloat(input.value) || 0) + delta;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            },
            calculateDurationInHours(startTimeStr, endTimeStr) {
                try {
                    if (!startTimeStr || !endTimeStr) return 0;
                    const [startH, startM] = startTimeStr.split(':').map(Number);
                    const [endH, endM] = endTimeStr.split(':').map(Number);
                    const startMinutes = startH * 60 + startM;
                    let endMinutes = endH * 60 + endM;
                    if (isNaN(startMinutes) || isNaN(endMinutes)) return 0; // Added validation
                    if (startMinutes === endMinutes) return 24;
                    if (endMinutes < startMinutes) endMinutes += 24 * 60;
                    return (endMinutes - startMinutes) / 60;
                } catch (error) {
                    console.error("Error calculating duration:", startTimeStr, endTimeStr, error); // Log error with inputs
                    return 0;
                }
            },
             calculateIdealAndAdjustedWeight() {
                const height = parseFloat(document.getElementById('height')?.value); // Safe access
                const gender = document.getElementById('gender')?.value; // Safe access
                const dailyWeight = parseFloat(document.getElementById('dailyWeight')?.value); // Safe access
                const idealWeightInput = document.getElementById('idealWeight');
                const notice = document.getElementById('adjustedWeightNotice');
                const label = document.getElementById('idealWeightLabel');

                if (!idealWeightInput || !notice || !label) return 0;

                if (!height || !gender || isNaN(height)) { // Added NaN check
                    idealWeightInput.value = "Var god ange längd och kön";
                    notice.style.display = 'none';
                    label.textContent = "Idealvikt (kg):";
                    this.state.adjustedWeight = false;
                    this.state.idealWeight = 0; // Reset ideal weight state
                    return 0;
                }

                let idealWeight = (gender === 'Man') ? (50 + 0.91 * (height - 152.4)) : (45.5 + 0.91 * (height - 152.4));
                idealWeight = Math.max(0, idealWeight); // Ensure non-negative
                idealWeight = Math.round(idealWeight * 10) / 10;
                this.state.idealWeight = idealWeight; // Store the calculated ideal weight

                let displayWeight = idealWeight;
                this.state.adjustedWeight = false;
                notice.style.display = 'none';
                label.textContent = "Idealvikt (kg):";

                if (dailyWeight && !isNaN(dailyWeight) && dailyWeight > (idealWeight * 1.20)) { // Added NaN check
                    displayWeight = idealWeight + 0.4 * (dailyWeight - idealWeight);
                    this.state.adjustedWeight = true;
                    notice.textContent = "(justerad)";
                    notice.style.display = 'inline';
                }

                displayWeight = Math.round(displayWeight * 10) / 10;
                 displayWeight = Math.max(0, displayWeight); // Ensure non-negative display value
                idealWeightInput.value = displayWeight.toFixed(1);

                return displayWeight;
            },
            calculateBMI() {
                const height = parseFloat(document.getElementById('height')?.value); // Safe access
                const dailyWeight = parseFloat(document.getElementById('dailyWeight')?.value); // Safe access
                const bmiDisplay = document.getElementById('bmiDisplay');
                if (bmiDisplay) {
                    if (height && dailyWeight && !isNaN(height) && !isNaN(dailyWeight) && height > 0) { // Added checks
                        const bmi = dailyWeight / ((height / 100) * (height / 100));
                        bmiDisplay.value = bmi.toFixed(1);
                        this.updateBmiCategory(bmi);
                    } else {
                        bmiDisplay.value = '';
                        this.updateBmiCategory(null);
                    }
                }
            },
            updateBmiCategory(bmi) {
                const bmiCategoryElement = document.getElementById('bmiCategory');
                 if (!bmiCategoryElement) return;
                let category = '';
                if (bmi !== null && !isNaN(bmi)) { // Check for null and NaN
                    if (bmi < 18.5) category = 'Undervikt';
                    else if (bmi < 25) category = 'Normalvikt';
                    else if (bmi < 30) category = 'Övervikt';
                    else if (bmi < 35) category = 'Obesitas grad 1';
                    else if (bmi < 40) category = 'Obesitas grad 2';
                    else category = 'Obesitas grad 3';
                }
                bmiCategoryElement.textContent = category;
            },
            _calculatePerspiratioLogic(durationInHours) {
                const isUnder15 = document.getElementById('isUnder15')?.value === 'yes'; // Safe access
                const weight = parseFloat(document.getElementById('dailyWeight')?.value) || 0; // Safe access
                const ventilationStatus = document.getElementById('breathingSupport')?.value; // Safe access
                const temperature = parseFloat(document.getElementById('maxTemp')?.value) || 37.0; // Safe access

                 if (durationInHours === undefined || isNaN(durationInHours)) durationInHours = 0; // Added check

                if (isUnder15 || weight < 50) {
                    this.state.perspiratioWarning = "Perspiratioberäkning ej möjligt vid ålder < 15 och/eller vikt < 50 kg";
                    return 0;
                } else {
                    this.state.perspiratioWarning = "";
                }

                let lBasicPerspiratio = 700;
                switch(ventilationStatus) {
                    case 'niv_humid':
                    case 'hfnc':
                        lBasicPerspiratio = 500;
                        break;
                    case 'intub_humid':
                        lBasicPerspiratio = 400;
                        break;
                }

                let sTempFactor = 1;
                const sTempDifference = temperature - 37;
                if (temperature < 35) {
                    sTempFactor = 0.5;
                } else if (temperature > 41) {
                    sTempFactor = 2;
                } else if (!isNaN(sTempDifference)) { // Added NaN check
                    sTempFactor = 1 + (sTempDifference * 0.25);
                }

                const perspiratio24h = lBasicPerspiratio * sTempFactor;
                const finalPerspiratio = perspiratio24h * (durationInHours / 24);

                return Math.round(finalPerspiratio);
            },
            calculatePerspiratio() {
                const duration = this.calculateDurationInHours(document.getElementById('startTime')?.value, document.getElementById('endTime')?.value); // Safe access
                const finalPerspiratio = this._calculatePerspiratioLogic(duration);

                const perspOutput = document.getElementById('calculatedPerspiratio');
                 if (perspOutput) perspOutput.value = `${finalPerspiratio} ml`;
                const perspWarning = document.getElementById('perspiratioWarning');
                 if(perspWarning) perspWarning.textContent = this.state.perspiratioWarning;
            },
            transferPerspiratioToLoss() {
                const perspiratioValue = parseFloat(document.getElementById('calculatedPerspiratio')?.value) || 0; // Safe access
                 const lossInput = document.getElementById('lossMlInput_perspiratio_static');
                 if (lossInput) lossInput.value = perspiratioValue;
                this.updateAllCalculations();
            },
            calculateTotals() {
                this.state.dailyWeight = parseFloat(document.getElementById('dailyWeight')?.value) || 0; // Safe access
                this.state.initialWeight = parseFloat(document.getElementById('initialWeight')?.value) || 0; // Safe access

                 // Reset state totals
                Object.assign(this.state, {
                    totalIntakeMl: 0, totalIntakeKcal: 0, totalLossMl: 0, totalIntakeProtein: 0,
                    medicineCategoryTotals: { Sedering: 0, Antibiotika: 0, Vasoaktiva: 0, Övrigt: 0 },
                    kcalSummary: { peroralt: 0, sondmat: 0, tpn: 0, ivMedicine: 0, intravenousTotal: 0 },
                    totalDiuresisMl: 0, totalPerspiratioMl: 0, totalOtherLossMl: 0
                });
                let kcalFromKristalloider = 0;

                 // Iterate through containers and rows safely
                 ['fluid', 'medicine', 'bloodProduct', 'tpnSondmat', 'loss'].forEach(containerKey => {
                    const container = this.dom.containers[containerKey];
                    if (!container) return; // Skip if container doesn't exist

                    container.querySelectorAll('[data-id]').forEach(row => {
                        const type = row.dataset.type;
                        if (!type || type.startsWith('planned') || row.id === 'perspiratio_static_row') return; // Skip planned & static persp for now

                        const mlInput = row.querySelector('.ml-input');
                        const mlValue = parseFloat(mlInput?.value) || 0;
                        const select = row.querySelector('.select-main');
                        const selectedOption = select?.options[select.selectedIndex];
                        const kcalOutput = row.querySelector('.kcal-output');
                        const proteinOutput = row.querySelector('.protein-output');
                        let kcalValue = 0;
                        let proteinValue = 0;

                        if (selectedOption) {
                             // Kcal calculation
                             if (kcalOutput) {
                                if (kcalOutput.dataset.manualOverride !== 'true' && selectedOption.dataset.kcalPerMl !== undefined) {
                                    const kcalPerMl = parseFloat(selectedOption.dataset.kcalPerMl || '0');
                                    kcalValue = Math.round(mlValue * kcalPerMl);
                                    kcalOutput.value = mlValue > 0 ? kcalValue : '';
                                } else {
                                    kcalValue = parseFloat(kcalOutput.value) || 0;
                                }
                             }
                             // Protein calculation
                             if (proteinOutput) {
                                if (proteinOutput.dataset.manualOverride !== 'true' && selectedOption.dataset.proteinPerMl !== undefined) {
                                    const proteinPerMl = parseFloat(selectedOption.dataset.proteinPerMl || '0');
                                    proteinValue = Math.round(mlValue * proteinPerMl * 10) / 10;
                                    proteinOutput.value = mlValue > 0 ? proteinValue.toFixed(1) : '';
                                } else {
                                    proteinValue = parseFloat(proteinOutput.value) || 0;
                                }
                             }
                        }

                         // Summing totals based on type
                        if (['fluid', 'medicine', 'bloodProduct', 'tpnSondmat'].includes(type)) {
                            this.state.totalIntakeMl += mlValue;
                            this.state.totalIntakeKcal += kcalValue;
                            this.state.totalIntakeProtein += proteinValue;
                        } else if (type === 'loss') {
                            this.state.totalLossMl += mlValue;
                            if (select?.value === 'Diures') this.state.totalDiuresisMl += mlValue;
                            else this.state.totalOtherLossMl += mlValue;
                        }

                        // Specific Kcal summaries
                        if (type === 'fluid') kcalFromKristalloider += kcalValue;
                        if (type === 'medicine' && select) {
                            this.state.kcalSummary.ivMedicine += kcalValue;
                            const category = Object.keys(this.data.medicine.categories).find(cat =>
                                Array.isArray(this.data.medicine.categories[cat]) && // Check if category is array
                                this.data.medicine.categories[cat].some(item => item.name === select.value)
                            ) || 'Övrigt';
                            if (this.state.medicineCategoryTotals[category] !== undefined) {
                                this.state.medicineCategoryTotals[category] += mlValue;
                            } else {
                               this.state.medicineCategoryTotals['Övrigt'] += mlValue; // Fallback
                            }
                        }
                        if (type === 'tpnSondmat' && select) {
                             if (select.value === 'Peroralt intag') this.state.kcalSummary.peroralt += kcalValue;
                             else if (select.value.startsWith('Sondmat') || select.value === 'Vatten i sond') this.state.kcalSummary.sondmat += kcalValue;
                             // Assuming anything else in this category is TPN or Näringsdryck which counts towards TPN summary here
                             else this.state.kcalSummary.tpn += kcalValue;
                         }
                    });
                 });

                 // Add static perspiratio loss *after* iterating dynamic rows
                 const staticPerspMl = parseFloat(document.getElementById('lossMlInput_perspiratio_static')?.value) || 0;
                 this.state.totalLossMl += staticPerspMl;
                 this.state.totalPerspiratioMl += staticPerspMl;


                const naclSyringes = parseFloat(document.getElementById('naclSyringes')?.value) || 0; // Safe access
                this.state.naclSyringeVolume = naclSyringes * 10;
                this.state.totalIntakeMl += this.state.naclSyringeVolume;

                const pressureSets = parseFloat(document.getElementById('pressureSets')?.value) || 0; // Safe access
                const duration = this.calculateDurationInHours(document.getElementById('startTime')?.value, document.getElementById('endTime')?.value); // Safe access
                this.state.pressureSetVolume = Math.round(pressureSets * 3 * duration);
                this.state.totalIntakeMl += this.state.pressureSetVolume;

                this.state.netBalanceMl = this.state.totalIntakeMl - this.state.totalLossMl;
                const cumulativePrev = parseFloat(document.getElementById('cumulativeBalancePrev')?.value) || 0; // Safe access
                this.state.cumulativeBalanceMl = cumulativePrev + this.state.netBalanceMl;
                this.state.weightDifferenceKg = this.state.initialWeight ? (this.state.dailyWeight - this.state.initialWeight) : 0;
                this.state.kcalSummary.intravenousTotal = this.state.kcalSummary.ivMedicine + this.state.kcalSummary.tpn + kcalFromKristalloider;

                // Beräkna timdiures
                if (duration > 0 && this.state.dailyWeight > 0) {
                    this.state.avgHourlyDiuresis = this.state.totalDiuresisMl / duration / this.state.dailyWeight;
                } else {
                    this.state.avgHourlyDiuresis = 0;
                }
            },
            updateSummaryUI() {
                for (const key in this.dom.summary) {
                    if (this.dom.summary[key]) {
                        const value = this.state[key];
                        if (key === 'avgHourlyDiuresis') {
                            this.dom.summary[key].textContent = value.toFixed(2);
                            this.dom.summary[key].classList.toggle('low-diuresis', value < 0.5 && this.state.totalDiuresisMl > 0);
                        } else if (key === 'totalIntakeProtein') {
                             this.dom.summary[key].textContent = value.toFixed(1);
                        } else {
                            this.dom.summary[key].textContent = typeof value === 'number' ? (key.includes('Kg') ? value.toFixed(1) : Math.round(value)) : value;
                        }
                    }
                }
            },
            calculateDiuresis() {
                 // Ensure elements exist before proceeding
                 const desiredBalanceEl = document.getElementById('desiredBalanceTomorrow');
                 const calcTimeEl = document.getElementById('diuresisCalcTime');
                 const plannedSingleIntakeEl = document.getElementById('plannedSingleIntake');
                 const plannedHourlyIntakeEl = document.getElementById('plannedHourlyIntake');
                 const plannedSingleLossesEl = document.getElementById('plannedSingleLosses');
                 const expectedPerspiratioInput = document.getElementById('expectedPerspiratioRemaining');

                 if (!desiredBalanceEl || !calcTimeEl || !plannedSingleIntakeEl || !plannedHourlyIntakeEl || !plannedSingleLossesEl || !expectedPerspiratioInput) {
                    // console.warn("One or more diuresis calculator elements not found.");
                     return; // Exit if elements aren't ready
                 }


                const desiredBalance = parseFloat(desiredBalanceEl.value) || 0;
                const calcTime = calcTimeEl.value;
                const remainingHours = this.calculateDurationInHours(calcTime, '06:00');
                const plannedSingleIntake = parseFloat(plannedSingleIntakeEl.value) || 0;
                const plannedHourlyIntake = parseFloat(plannedHourlyIntakeEl.value) || 0;
                const plannedSingleLosses = parseFloat(plannedSingleLossesEl.value) || 0;


                const calculatedPerspiratio = this._calculatePerspiratioLogic(remainingHours);

                 // Only update if not manually overridden
                 if (expectedPerspiratioInput.dataset.manualOverride !== 'true') {
                     expectedPerspiratioInput.value = calculatedPerspiratio;
                 }
                const expectedPerspiratio = parseFloat(expectedPerspiratioInput.value) || 0;

                const remainingTimeEl = document.getElementById('remainingTimeTo0600');
                 if (remainingTimeEl) remainingTimeEl.value = remainingHours.toFixed(1);


                const totalFutureIntake = plannedSingleIntake + (plannedHourlyIntake * remainingHours);
                const totalFutureLoss = plannedSingleLosses + expectedPerspiratio;

                const requiredDiuresis = this.state.netBalanceMl + totalFutureIntake - totalFutureLoss - desiredBalance;
                const diuresisPerHour = remainingHours > 0 ? requiredDiuresis / remainingHours : 0;

                // Update summary table in modal - check if elements exist
                 const elementsToUpdate = {
                     'summaryBalanceTillNow': Math.round(this.state.netBalanceMl),
                     'summaryRemainingHoursFuture': remainingHours.toFixed(1),
                     'summaryPlannedSingleIntakeSummary': Math.round(plannedSingleIntake),
                     'plannedHourlyIntakeDisplay': Math.round(plannedHourlyIntake),
                     'remainingHoursDisplay': remainingHours.toFixed(1),
                     'summaryPlannedHourlyIntakeTotal': Math.round(plannedHourlyIntake * remainingHours),
                     'summaryPlannedSingleLossesSummary': Math.round(plannedSingleLosses),
                     'summaryExpectedPerspiratioRemainingSummary': Math.round(expectedPerspiratio),
                     'summaryDesiredBalanceTomorrowSummary': Math.round(desiredBalance),
                     'summaryTotalCalculatedIntake': Math.round(this.state.totalIntakeMl + totalFutureIntake),
                     'summaryTotalCalculatedLossExclDiuresis': Math.round(this.state.totalOtherLossMl + this.state.totalPerspiratioMl + totalFutureLoss),
                     'diuresisNeedPerHour': diuresisPerHour.toFixed(1)
                 };

                 for (const id in elementsToUpdate) {
                     const el = document.getElementById(id);
                     if (el) {
                         el.textContent = elementsToUpdate[id];
                     }
                 }
            },
             openModal(targetId) {
                const modalOverlay = document.getElementById(targetId);
                 if (!modalOverlay) return;

                 // Logic specific to each modal
                 if (targetId === 'calculationsModalOverlay') this.populateKcalTableInModal();
                 if (targetId === 'printDetailedSummaryModalOverlay') this.populatePrintModal();
                 if (targetId === 'diuresisCalculatorModalOverlay') {
                     const perspInput = document.getElementById('expectedPerspiratioRemaining');
                      if (perspInput) perspInput.dataset.manualOverride = 'false';
                     this.setNow('diuresisCalcTime'); // Set time first
                     this.calculateDiuresis(); // Then calculate
                 }
                 if (targetId === 'nutritionCalculatorModalOverlay') {
                     // Check required data
                     const height = document.getElementById('height')?.value;
                     const gender = document.getElementById('gender')?.value;
                     const dailyWeight = document.getElementById('dailyWeight')?.value;
                     const warningDiv = document.getElementById('nutritionDataWarning');
                     const contentDiv = document.getElementById('nutritionCalculatorContent');

                     if (warningDiv && contentDiv) { // Ensure elements exist
                         if (!height || !gender || !dailyWeight) {
                             warningDiv.style.display = 'block';
                             contentDiv.style.display = 'none';
                         } else {
                             warningDiv.style.display = 'none';
                             contentDiv.style.display = 'grid';
                              // Cache elements specifically for this modal IF NOT ALREADY CACHED
                              this.cacheNutritionPlanElements();
                             // Recalculate everything now that elements are confirmed/cached
                              this.updateAllCalculations();
                         }
                     } else {
                         console.error("Warning or content div for nutrition calculator not found.");
                     }
                 }

                 // Handle pre-selection for level modals
                  if (targetId === 'nutritionLevelModalOverlay') {
                     const modal = document.getElementById('nutritionLevelModalOverlay');
                     if (modal) {
                         const radios = modal.querySelectorAll('input[name="nutritionLevel"]');
                         let currentSelection = document.getElementById('selectedNutritionLevel')?.value; // Safe access
                         radios.forEach(radio => {
                             radio.checked = (radio.value === currentSelection);
                             const optionDiv = radio.closest('.nutrition-level-option');
                             if (optionDiv) { // Check if closest found
                                 optionDiv.classList.toggle('selected', radio.checked);
                             }
                         });
                         const selectButton = document.getElementById('selectNutritionLevelButton');
                         if (selectButton) selectButton.disabled = !currentSelection;
                      }
                  }
                  if (targetId === 'proteinLevelModalOverlay') {
                      const modal = document.getElementById('proteinLevelModalOverlay');
                      if (modal) {
                         const radios = modal.querySelectorAll('input[name="proteinLevel"]');
                         let currentSelection = document.getElementById('selectedProteinLevel')?.value; // Safe access
                         radios.forEach(radio => {
                             radio.checked = (radio.value === currentSelection);
                             const optionDiv = radio.closest('.nutrition-level-option');
                             if (optionDiv) { // Check if closest found
                                 optionDiv.classList.toggle('selected', radio.checked);
                             }
                         });
                         const selectButton = document.getElementById('selectProteinLevelButton');
                          if (selectButton) selectButton.disabled = !currentSelection;
                      }
                  }


                 modalOverlay.classList.add('active');
                 this.dom.body.classList.add('modal-open');
             },
             // Helper to cache nutrition plan elements specifically when modal opens
              cacheNutritionPlanElements() {
                  // Only cache if not already done or if elements might have been removed (e.g., after reset)
                  if (!this.dom.nutritionPlan || !document.getElementById('nutritionPlanStartTime')) {
                      this.dom.nutritionPlan = {
                          startTime: document.getElementById('nutritionPlanStartTime'),
                          endTime: document.getElementById('nutritionPlanEndTime'),
                          duration: document.getElementById('nutritionPlanDuration'),
                          infusionTotalKcalPerHour: document.getElementById('plannedInfusionTotalKcalPerHour'),
                          infusionTotalProteinPerHour: document.getElementById('plannedInfusionTotalProteinPerHour'),
                          bolusTotalKcal: document.getElementById('plannedBolusTotalKcal'),
                          bolusTotalProtein: document.getElementById('plannedBolusTotalProtein'),
                          plannedTotalKcal: document.getElementById('plannedTotalKcal'),
                          plannedTotalProtein: document.getElementById('plannedTotalProtein'),
                          prognosisTotalKcal: document.getElementById('prognosisTotalKcal'),
                          prognosisTotalProtein: document.getElementById('prognosisTotalProtein'),
                          prognosisTotalKcalPercent: document.getElementById('prognosisTotalKcalPercent'),
                          prognosisTotalProteinPercent: document.getElementById('prognosisTotalProteinPercent'),
                           // Store container refs, not templates
                           infusionsContainer: document.getElementById('plannedInfusionsContainer'),
                           bolusesContainer: document.getElementById('plannedBolusesContainer')
                      };
                      // Set default times when caching for the first time
                       if (this.dom.nutritionPlan.startTime && !this.dom.nutritionPlan.startTime.value) {
                           this.dom.nutritionPlan.startTime.value = '06:00';
                       }
                       if (this.dom.nutritionPlan.endTime && !this.dom.nutritionPlan.endTime.value) {
                           this.dom.nutritionPlan.endTime.value = '06:00';
                       }
                        // Add event listeners for time changes *after* caching
                        if (this.dom.nutritionPlan.startTime) {
                             this.dom.nutritionPlan.startTime.removeEventListener('change', this.boundCalculatePlannedNutrition); // Remove old listener if any
                             this.boundCalculatePlannedNutrition = this.calculatePlannedNutrition.bind(this); // Store bound function
                             this.dom.nutritionPlan.startTime.addEventListener('change', this.boundCalculatePlannedNutrition);
                        }
                        if (this.dom.nutritionPlan.endTime) {
                            this.dom.nutritionPlan.endTime.removeEventListener('change', this.boundCalculatePlannedNutrition); // Remove old listener if any
                            // Use the same bound function reference
                            this.dom.nutritionPlan.endTime.addEventListener('change', this.boundCalculatePlannedNutrition);
                        }
                  }
              },
            closeModal(targetId) {
                document.getElementById(targetId)?.classList.remove('active');
                const anyModalActive = document.querySelector('.modal-overlay.active');
                if (!anyModalActive) {
                    this.dom.body.classList.remove('modal-open');
                }
            },
             populateKcalTableInModal() {
                const categoryMapping = [
                    { name: 'Rena Glucoslösningar/Kolloider', key: 'fluid', containerSuffix: 'Kristalloider' }, // Adjusted name here
                    { name: 'Läkemedelsvätskor', key: 'medicine', containerSuffix: 'Medicine' },
                    { name: 'TPN/Sondmat/Näringsdryck/Peroralt', key: 'tpnSondmat', containerSuffix: 'TpnSondmat' }
                ];

                categoryMapping.forEach(mapping => {
                    const container = document.getElementById(`kcal${mapping.containerSuffix}Container`);
                    if (!container) return;

                    container.innerHTML = `<h3>Kalori- & Proteininnehåll ${mapping.name}</h3>`;
                    const table = document.createElement('table');
                    table.innerHTML = '<thead><tr><th>Vätska/Produkt</th><th style="text-align:right;">Kcal/ml</th><th style="text-align:right;">Protein g/ml</th></tr></thead>';
                    const tbody = document.createElement('tbody');

                    const dataSet = this.data[mapping.key];
                     if (!dataSet) return; // Add check

                    const items = [];

                    if (dataSet.customOption) items.push({ name: dataSet.customOption, kcal: 0, protein: 0 });
                    if (dataSet.customOption2) items.push({ name: dataSet.customOption2, kcal: 0, protein: 0 });
                    if (dataSet.options && Array.isArray(dataSet.options)) { // Check if options is an array
                        dataSet.options.forEach(opt => {
                            if (typeof opt === 'object') {
                                items.push(opt);
                            } else {
                                items.push({ name: opt, kcal: 0, protein: 0 });
                            }
                        });
                    }
                    if (dataSet.categories) {
                        for (const cat in dataSet.categories) {
                            if (Array.isArray(dataSet.categories[cat])) { // Ensure category items are an array
                               items.push(...dataSet.categories[cat]);
                            }
                        }
                    }

                    items.sort((a, b) => (a.name || a).localeCompare(b.name || b));

                    const uniqueItems = items.filter((item, index, self) =>
                        index === self.findIndex((t) => (
                            (t.name || t) === (item.name || item)
                        ))
                    );

                    uniqueItems.forEach(item => {
                        const name = item.name || item;
                        const kcal = item.kcal ?? 0;
                        const protein = item.protein ?? 0;
                        let tooltipHtml = '';
                        if (name.includes('Propofol')) {
                            tooltipHtml = `
                                <span class="tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltiptext">Källa: ePed</span>
                                </span>`;
                        }
                        tbody.innerHTML += `<tr><td>${name} ${tooltipHtml}</td><td style="text-align:right;">${kcal}</td><td style="text-align:right;">${protein}</td></tr>`;
                    });

                    table.appendChild(tbody);
                    container.appendChild(table);
                });
            },
            populatePrintModal() {
                this.updateAllCalculations(); // Ensure state is current

                // Populate the info box
                 const datePrint = document.getElementById('summaryDatePrint');
                 if (datePrint) datePrint.textContent = document.getElementById('dateInput')?.value || '';
                 const timePrint = document.getElementById('summaryTimePeriodPrint');
                 if (timePrint) timePrint.textContent = `${document.getElementById('startTime')?.value || '??:??'} - ${document.getElementById('endTime')?.value || '??:??'}`;
                const bedSelect = document.getElementById('bedSelect');
                 const locationPrint = document.getElementById('summaryLocationPrint');
                 if (bedSelect && locationPrint) locationPrint.textContent = bedSelect.value === 'Annan plats' ? (document.getElementById('otherLocationInput')?.value || '') : bedSelect.value;

                 const initWeightPrint = document.getElementById('printInitialWeight');
                 if (initWeightPrint) initWeightPrint.textContent = `${this.state.initialWeight.toFixed(1)} kg`;
                 const dailyWeightPrint = document.getElementById('printDailyWeight');
                 if (dailyWeightPrint) dailyWeightPrint.textContent = `${this.state.dailyWeight.toFixed(1)} kg`;

                const idealWeightValue = document.getElementById('idealWeight')?.value; // Safe access
                const printIdealWeightLabelElement = document.getElementById('printIdealWeightLabel');
                const printIdealWeightValueElement = document.getElementById('printIdealWeight');
                const idealWeightRow = printIdealWeightValueElement?.parentElement; // Safe access

                if (idealWeightRow) { // Check if row exists
                    if (idealWeightValue && !isNaN(parseFloat(idealWeightValue))) {
                        idealWeightRow.style.display = ''; // or 'table-row' to be specific
                        if (printIdealWeightLabelElement) printIdealWeightLabelElement.textContent = this.state.adjustedWeight ? 'Justerad idealvikt:' : 'Idealvikt:';
                        if (printIdealWeightValueElement) printIdealWeightValueElement.textContent = `${idealWeightValue} kg`;
                    } else {
                        idealWeightRow.style.display = 'none';
                    }
                }

                 const weightDiffPrint = document.getElementById('printWeightDifference');
                 if (weightDiffPrint) weightDiffPrint.textContent = `${this.state.weightDifferenceKg.toFixed(1)} kg`;
                 const cumBalPrevPrint = document.getElementById('printCumulativeBalancePrev');
                 if (cumBalPrevPrint) cumBalPrevPrint.textContent = `${document.getElementById('cumulativeBalancePrev')?.value || 0} ml`; // Default to 0

                 const intakeMlPrint = document.getElementById('printTotalIntakeMl');
                 if (intakeMlPrint) intakeMlPrint.textContent = `${Math.round(this.state.totalIntakeMl)} ml`;
                 const lossMlPrint = document.getElementById('printTotalLossMl');
                 if (lossMlPrint) lossMlPrint.textContent = `${Math.round(this.state.totalLossMl)} ml`;
                 const netBalPrint = document.getElementById('printNetBalanceMl');
                 if (netBalPrint) netBalPrint.textContent = `${Math.round(this.state.netBalanceMl)} ml`;
                 const cumBalPrint = document.getElementById('printCumulativeBalanceMl');
                 if (cumBalPrint) cumBalPrint.textContent = `${Math.round(this.state.cumulativeBalanceMl)} ml`;
                 const kcalPrint = document.getElementById('printTotalKcalIntake');
                 if (kcalPrint) kcalPrint.textContent = `${Math.round(this.state.totalIntakeKcal)} Kcal`;
                 const protPrint = document.getElementById('printTotalProteinIntake');
                 if (protPrint) protPrint.textContent = `${this.state.totalIntakeProtein.toFixed(1)} g`;


                const intakeContainer = document.getElementById('print-details-intake');
                const lossContainer = document.getElementById('print-details-loss');

                if(!intakeContainer || !lossContainer) return;

                let intakeHtml = '';
                let lossAndGoalHtml = '';

                // --- INTAKE ---
                const intakeSections = [
                    { title: 'Rena Glucoslösningar/Kolloider', type: 'fluid' }, // Updated title
                    { title: 'Läkemedelsvätskor', type: 'medicine' },
                    { title: 'Blodprodukter', type: 'bloodProduct' },
                    { title: 'TPN/Sondmat/Peroralt', type: 'tpnSondmat' }
                ];

                let allIntakeEntries = [];
                intakeSections.forEach(section => {
                    const entries = [];
                    const containerId = this.config[section.type]?.containerId; // Safe access
                     if (!containerId) return;
                     const container = document.getElementById(containerId); // Get container element
                     if (!container) return; // Skip if container not found

                    container.querySelectorAll('[data-id]').forEach(row => {
                        const mlValue = parseFloat(row.querySelector('.ml-input')?.value) || 0;
                        if (mlValue > 0) {
                            const select = row.querySelector('.select-main');
                            let name = select?.value;
                            if (name && (name.startsWith('Övrig') || name.startsWith('Annan'))) {
                                name = row.querySelector('.custom-input')?.value || name;
                            }
                            const kcalValue = parseFloat(row.querySelector('.kcal-output')?.value) || 0;
                            const proteinValue = parseFloat(row.querySelector('.protein-output')?.value) || 0;
                            entries.push({ name, ml: mlValue, kcal: kcalValue, protein: proteinValue });
                        }
                    });

                    if (section.type === 'fluid') {
                        if (this.state.naclSyringeVolume > 0) {
                            entries.push({ name: 'NaCl från förfyllda sprutor', ml: this.state.naclSyringeVolume, kcal: 0, protein: 0 });
                        }
                        if (this.state.pressureSetVolume > 0) {
                            entries.push({ name: 'NaCl från tryckset', ml: this.state.pressureSetVolume, kcal: 0, protein: 0 });
                        }
                    }

                    if (entries.length > 0) {
                        allIntakeEntries.push({category: section.title, items: entries});
                    }
                });

                if (allIntakeEntries.length > 0) {
                    intakeHtml += '<h3>Vätskeintag</h3><table class="summary-table">';
                    allIntakeEntries.forEach(section => {
                        intakeHtml += `<tr class="category-row"><td colspan="2"><strong>${section.category}</strong></td></tr>`;
                        section.items.forEach(item => {
                            const kcalText = item.kcal > 0 ? ` (${Math.round(item.kcal)} Kcal)` : ''; // Round kcal
                            const proteinText = item.protein > 0 ? ` (${item.protein.toFixed(1)}g Protein)` : '';
                            intakeHtml += `<tr class="item-row"><td>${item.name || 'Okänd'}</td><td class="numeric-value">${Math.round(item.ml)} ml${kcalText}${proteinText}</td></tr>`; // Round ml
                        });
                    });
                    intakeHtml += '</table>';
                }


                // --- LOSSES ---
                const lossEntries = [];
                 const lossContainerEl = document.getElementById('lossEntriesContainer'); // Get container element
                 if (lossContainerEl) {
                    lossContainerEl.querySelectorAll('[data-id]').forEach(row => {
                        if (row.dataset.id === 'perspiratio_static') return; // Skip static one for now
                        const mlValue = parseFloat(row.querySelector('.ml-input')?.value) || 0;
                        if (mlValue > 0) {
                            const select = row.querySelector('.select-main');
                            let name = select?.value;
                            if (name === 'Annan förlust') {
                                name = row.querySelector('.custom-input')?.value || name;
                            }
                            lossEntries.push({ name, ml: mlValue });
                        }
                    });
                 }
                // Static perspiratio
                const perspiratioMl = parseFloat(document.getElementById('lossMlInput_perspiratio_static')?.value) || 0;
                if (perspiratioMl > 0) {
                    lossEntries.push({ name: 'Perspiratio', ml: perspiratioMl });
                }

                if (lossEntries.length > 0) {
                    lossAndGoalHtml += `<h3>Förluster</h3><table class="summary-table">`;
                    lossEntries.forEach(entry => {
                        let text = `<tr><td>${entry.name || 'Okänd'}</td><td class="numeric-value">${Math.round(entry.ml)} ml</td></tr>`; // Round ml
                        if (entry.name === 'Diures') {
                            text = `<tr><td>${entry.name}</td><td class="numeric-value">${Math.round(entry.ml)} ml (${this.state.avgHourlyDiuresis.toFixed(2)} ml/kg/h)</td></tr>`; // Round ml
                        }
                        lossAndGoalHtml += text;
                    });
                    lossAndGoalHtml += '</table>';
                }

                // --- DIURESIS GOAL ---
                if (document.getElementById('includeDiuresisGoalInPrint')?.checked) { // Safe access
                    const currentBalance = this.state.netBalanceMl;
                    const futureIntake = (parseFloat(document.getElementById('plannedSingleIntake')?.value) || 0) + // Safe access
                                         ((parseFloat(document.getElementById('plannedHourlyIntake')?.value) || 0) * this.calculateDurationInHours(document.getElementById('diuresisCalcTime')?.value, '06:00')); // Safe access
                    const futureLoss = (parseFloat(document.getElementById('plannedSingleLosses')?.value) || 0) + // Safe access
                                       (parseFloat(document.getElementById('expectedPerspiratioRemaining')?.value) || 0); // Safe access
                    const desiredBalance = parseFloat(document.getElementById('desiredBalanceTomorrow')?.value) || 0; // Safe access
                    const diuresisNeedPerHour = document.getElementById('diuresisNeedPerHour')?.textContent || '0.0'; // Safe access
                    const remainingHours = this.calculateDurationInHours(document.getElementById('diuresisCalcTime')?.value, '06:00').toFixed(1); // Safe access
                    const diuresisNeedTotal = parseFloat(diuresisNeedPerHour) * parseFloat(remainingHours);

                    lossAndGoalHtml += `
                        <h3>Plan för att nå vätskebalansmål (från kl. ${document.getElementById('diuresisCalcTime')?.value || '??:??'})</h3>
                        <table class="summary-table">
                            <tr><td>Nuvarande nettobalans:</td><td class="numeric-value">${Math.round(currentBalance)} ml</td></tr>
                            <tr><td>+ Förväntad framtida tillförsel:</td><td class="numeric-value">${Math.round(futureIntake)} ml</td></tr>
                            <tr><td>- Förväntade framtida förluster (exkl. diures):</td><td class="numeric-value">${Math.round(futureLoss)} ml</td></tr>
                            <tr><td>- Önskad nettobalans kl 06:00:</td><td class="numeric-value">${Math.round(desiredBalance)} ml</td></tr>
                            <tr class="highlight-row-print"><td><strong>= Totalt diuresbehov (återstående tid):</strong></td><td class="numeric-value"><strong>${Math.round(diuresisNeedTotal)} ml</strong></td></tr>
                            <tr><td><em>Motsvarar:</em></td><td class="numeric-value"><em>${diuresisNeedPerHour} ml/h i ${remainingHours} timmar</em></td></tr>
                        </table>`;
                }

                intakeContainer.innerHTML = intakeHtml;
                lossContainer.innerHTML = lossAndGoalHtml;
            },
            collectFormData() {
                const data = {
                    patientInfo: {}, fluidEntries: [], medicineEntries: [], bloodProductEntries: [], tpnSondmatEntries: [], lossEntries: [],
                    perspiratioCalc: {}, diuresisCalc: {}, nutritionPlan: { infusions: [], boluses: [], startTime: '', endTime: ''} // Add nutrition plan to data
                };
                ['dateInput', 'startTime', 'endTime', 'bedSelect', 'otherLocationInput', 'initialWeight', 'dailyWeight', 'height', 'gender', 'isUnder15', 'cumulativeBalancePrev', 'naclSyringes', 'pressureSets'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) data.patientInfo[id] = el.value;
                 });

                 // Main entries
                document.querySelectorAll('#fluidEntriesContainer [data-id]').forEach(row => data.fluidEntries.push({ selectValue: row.querySelector('.select-main')?.value, mlValue: row.querySelector('.ml-input')?.value, kcalValue: row.querySelector('.kcal-output')?.value, proteinValue: row.querySelector('.protein-output')?.value, customValue: row.querySelector('.custom-input')?.value }));
                document.querySelectorAll('#medicineEntriesContainer [data-id]').forEach(row => data.medicineEntries.push({ selectValue: row.querySelector('.select-main')?.value, mlValue: row.querySelector('.ml-input')?.value, kcalValue: row.querySelector('.kcal-output')?.value, proteinValue: row.querySelector('.protein-output')?.value, customValue: row.querySelector('.custom-input')?.value }));
                document.querySelectorAll('#bloodProductEntriesContainer [data-id]').forEach(row => data.bloodProductEntries.push({ selectValue: row.querySelector('.select-main')?.value, mlValue: row.querySelector('.ml-input')?.value }));
                document.querySelectorAll('#tpnSondmatEntriesContainer [data-id]').forEach(row => data.tpnSondmatEntries.push({ selectValue: row.querySelector('.select-main')?.value, mlValue: row.querySelector('.ml-input')?.value, kcalValue: row.querySelector('.kcal-output')?.value, proteinValue: row.querySelector('.protein-output')?.value, customValue: row.querySelector('.custom-input')?.value }));
                document.querySelectorAll('#lossEntriesContainer [data-id]').forEach(row => {
                    if(row.dataset.id !== 'perspiratio_static') data.lossEntries.push({ selectValue: row.querySelector('.select-main')?.value, mlValue: row.querySelector('.ml-input')?.value, customValue: row.querySelector('.custom-input')?.value })
                });
                data.lossEntries.push({ selectValue: 'Perspiratio', mlValue: document.getElementById('lossMlInput_perspiratio_static')?.value }); // Add static perspiratio

                // Calculators
                data.perspiratioCalc = { breathingSupport: document.getElementById('breathingSupport')?.value, maxTemp: document.getElementById('maxTemp')?.value };
                data.diuresisCalc = { desiredBalanceTomorrow: document.getElementById('desiredBalanceTomorrow')?.value, diuresisCalcTime: document.getElementById('diuresisCalcTime')?.value, plannedSingleIntake: document.getElementById('plannedSingleIntake')?.value, plannedHourlyIntake: document.getElementById('plannedHourlyIntake')?.value, plannedSingleLosses: document.getElementById('plannedSingleLosses')?.value };

                // Nutrition Plan
                 data.nutritionPlan.startTime = document.getElementById('nutritionPlanStartTime')?.value;
                 data.nutritionPlan.endTime = document.getElementById('nutritionPlanEndTime')?.value;
                 document.querySelectorAll('#plannedInfusionsContainer [data-id]').forEach(row => {
                     data.nutritionPlan.infusions.push({
                         selectValue: row.querySelector('.select-main')?.value,
                         rateValue: row.querySelector('.rate-input')?.value // Use rateValue
                     });
                 });
                 document.querySelectorAll('#plannedBolusesContainer [data-id]').forEach(row => {
                     data.nutritionPlan.boluses.push({
                         selectValue: row.querySelector('.select-main')?.value,
                         amountValue: row.querySelector('.amount-input')?.value // Use amountValue
                     });
                 });

                return data;
            },
            saveDataToFile() {
                try {
                    const data = this.collectFormData();
                    const jsonData = JSON.stringify(data, null, 2);
                    const now = new Date();
                    const time = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
                    const bed = data.patientInfo.bedSelect === 'Annan plats' ? (data.patientInfo.otherLocationInput || 'OkändSäng') : (data.patientInfo.bedSelect || 'OkändSäng');
                    const date = data.patientInfo.dateInput || 'OkäntDatum';
                    const filename = `${bed}_${date}_${time}.json`;

                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Error saving data:", error);
                }
            },
            loadDataFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        this.populateFormWithData(loadedData);
                    } catch (err) {
                        console.error("Error parsing JSON file:", err);
                        alert("Kunde inte läsa filen. Kontrollera att det är en giltig JSON-fil.");
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset file input
            },
            populateFormWithData(data) {
                // Clear existing dynamic rows (including planned ones)
                Object.values(this.dom.containers).forEach(container => {
                     if (container) { // Check if container exists
                         // Clear only dynamic rows, keep static perspiratio structure
                         if (container.id === 'lossEntriesContainer') {
                            container.querySelectorAll('[data-id]:not([data-id="perspiratio_static"])').forEach(row => row.remove());
                         } else {
                            container.innerHTML = ''; // Clear other containers completely
                         }
                     }
                });
                Object.keys(this.counters).forEach(key => this.counters[key] = 0); // Reset counters

                // Populate patient info
                if (data.patientInfo) {
                    for(const id in data.patientInfo) {
                        const el = document.getElementById(id);
                        if(el) el.value = data.patientInfo[id];
                    }
                }

                // Create and populate main rows
                data.fluidEntries?.forEach(d => this.addRow('fluid', d));
                data.medicineEntries?.forEach(d => this.addRow('medicine', d));
                data.bloodProductEntries?.forEach(d => this.addRow('bloodProduct', d));
                data.tpnSondmatEntries?.forEach(d => this.addRow('tpnSondmat', d));
                data.lossEntries?.forEach(d => {
                    if (d.selectValue === 'Perspiratio') {
                        const perspInput = document.getElementById('lossMlInput_perspiratio_static');
                        if (perspInput) perspInput.value = d.mlValue;
                    } else {
                        this.addRow('loss', d);
                    }
                });

                // Populate calculator sections
                if (data.perspiratioCalc) {
                    for(const id in data.perspiratioCalc) {
                        const el = document.getElementById(id);
                        if(el) el.value = data.perspiratioCalc[id];
                    }
                }
                if (data.diuresisCalc) {
                    for(const id in data.diuresisCalc) {
                        const el = document.getElementById(id);
                        if(el) el.value = data.diuresisCalc[id];
                    }
                }

                // Populate Nutrition Plan
                 if (data.nutritionPlan) {
                     // Cache elements if not already done (needed after clearing)
                     this.cacheNutritionPlanElements();

                     const startTimeEl = this.dom.nutritionPlan.startTime;
                     if (startTimeEl) startTimeEl.value = data.nutritionPlan.startTime || '06:00';
                     const endTimeEl = this.dom.nutritionPlan.endTime;
                     if (endTimeEl) endTimeEl.value = data.nutritionPlan.endTime || '06:00';

                     // Add rows using the specific function and initialData structure
                     data.nutritionPlan.infusions?.forEach(infusionData => {
                         this.addPlannedNutritionRow('infusion', infusionData);
                     });
                     data.nutritionPlan.boluses?.forEach(bolusData => {
                          this.addPlannedNutritionRow('bolus', bolusData);
                     });
                 }


                this.checkInitialInputColors();
                this.updateAllCalculations(); // Recalculate everything once form is populated
            },
            resetAll() {
                // Rensa alla input-fält, select etc.
                document.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="hidden"], select').forEach(el => {
                    // Behåll standardvärden för vissa fält
                    if (el.id === 'startTime' || el.id === 'endTime' || el.id === 'nutritionPlanStartTime' || el.id === 'nutritionPlanEndTime') {
                        el.value = '06:00';
                    } else if (el.id === 'maxTemp') {
                        el.value = '37.0';
                    } else if (el.id === 'isUnder15') {
                        el.value = 'no';
                    } else if (el.id === 'breathingSupport') {
                         el.value = 'standard'; // Reset breathing support
                    } else if (el.id === 'naclSyringes' || el.id === 'pressureSets') {
                         el.value = '0'; // Reset counters
                    } else if (el.tagName === 'SELECT') {
                         if (el.id !== 'lossSelect_perspiratio_static') {
                            el.selectedIndex = 0; // Reset select lists
                         }
                    } else if (el.id !== 'lossMlInput_perspiratio_static'){
                        el.value = ''; // Rensa övriga textfält
                    }
                });
                 // Rensa statisk perspiratio-värde
                 const staticPerspInput = document.getElementById('lossMlInput_perspiratio_static');
                 if (staticPerspInput) staticPerspInput.value = '';

                // Rensa alla dynamiska rader (inklusive planerade)
                 Object.values(this.dom.containers).forEach(container => {
                      if (container) {
                          // Rensa bara dynamiska rader i loss-containern
                          if (container.id === 'lossEntriesContainer') {
                             container.querySelectorAll('[data-id]:not([data-id="perspiratio_static"])').forEach(row => row.remove());
                          } else {
                             container.innerHTML = ''; // Töm övriga helt
                          }
                      }
                 });

                 // Återställ nutritionskalkylatorns val och sliders
                 const nutLevelDisplay = document.getElementById('nutritionLevelDisplay');
                 if (nutLevelDisplay) nutLevelDisplay.textContent = 'Inget valt';
                 const kcalSlider = document.getElementById('kcalSlider');
                 if (kcalSlider) { kcalSlider.value = 0; kcalSlider.disabled = true; }
                 const proteinLevelDisplay = document.getElementById('proteinLevelDisplay');
                 if (proteinLevelDisplay) proteinLevelDisplay.textContent = 'Inget valt';
                 const proteinSlider = document.getElementById('proteinSlider');
                  if (proteinSlider) { proteinSlider.value = 0; proteinSlider.disabled = true; }
                  // Reset hidden values
                   const selectedNutLevel = document.getElementById('selectedNutritionLevel');
                   if (selectedNutLevel) selectedNutLevel.value = '';
                   const selectedNutKcal = document.getElementById('selectedNutritionLevelKcal');
                   if (selectedNutKcal) selectedNutKcal.value = '';
                   const selectedProtLevel = document.getElementById('selectedProteinLevel');
                   if (selectedProtLevel) selectedProtLevel.value = '';
                   const selectedProtValue = document.getElementById('selectedProteinLevelValue');
                   if (selectedProtValue) selectedProtValue.value = '';
                    // Reset calculation weight radio
                    const idealRadio = document.querySelector('input[name="calculationWeightSource"][value="ideal"]');
                    if (idealRadio) idealRadio.checked = true;
                    // Reset checkboxes
                     const feverCheckbox = document.getElementById('applyFeverAdjustment');
                     if (feverCheckbox) feverCheckbox.checked = true;
                     const bmiCheckbox = document.getElementById('applyBmiAdjustment');
                     if (bmiCheckbox) bmiCheckbox.checked = true;
                     // Reset fluid slider
                      const fluidSliderEl = document.getElementById('fluidSlider');
                      if(fluidSliderEl) fluidSliderEl.value = 30; // Reset to default


                 // Återställ counters
                 Object.keys(this.counters).forEach(key => this.counters[key] = 0);

                // Återställ standarddatum och initiala rader
                this.setDefaultValues(); // Sets date etc.
                this.addInitialRows(); // Re-adds Diures row
                this.checkInitialInputColors(); // Set correct input field colors
                this.updateAllCalculations(); // Recalculate everything
                this.closeModal('confirmationModalOverlay');
            },
            selectNutritionLevel() {
                const selectedRadio = document.querySelector('input[name="nutritionLevel"]:checked');
                if (selectedRadio) {
                    const selectedValue = selectedRadio.value;
                    const kcalValue = selectedRadio.dataset.kcal;
                    const nutLevelDisplay = document.getElementById('nutritionLevelDisplay');
                    const selectedNutLevel = document.getElementById('selectedNutritionLevel');
                    const selectedNutKcal = document.getElementById('selectedNutritionLevelKcal');
                    const kcalSlider = document.getElementById('kcalSlider');

                     if(nutLevelDisplay) nutLevelDisplay.textContent = selectedValue;
                     if(selectedNutLevel) selectedNutLevel.value = selectedValue;
                     if(selectedNutKcal) selectedNutKcal.value = kcalValue;
                     if(kcalSlider) {
                        kcalSlider.value = kcalValue;
                        kcalSlider.disabled = false;
                     }

                    this.updateAllCalculations(); // Recalculate after selection
                    this.closeModal('nutritionLevelModalOverlay');
                }
            },
            selectProteinLevel() {
                const selectedRadio = document.querySelector('input[name="proteinLevel"]:checked');
                if (selectedRadio) {
                    const selectedValue = selectedRadio.value;
                    const proteinValue = selectedRadio.dataset.protein;
                    const protLevelDisplay = document.getElementById('proteinLevelDisplay');
                    const selectedProtLevel = document.getElementById('selectedProteinLevel');
                    const selectedProtValue = document.getElementById('selectedProteinLevelValue');
                    const proteinSlider = document.getElementById('proteinSlider');

                     if(protLevelDisplay) protLevelDisplay.textContent = selectedValue;
                     if(selectedProtLevel) selectedProtLevel.value = selectedValue;
                     if(selectedProtValue) selectedProtValue.value = proteinValue;
                     if(proteinSlider) {
                         proteinSlider.value = proteinValue;
                         proteinSlider.disabled = false;
                     }

                    this.updateAllCalculations(); // Recalculate after selection
                    this.closeModal('proteinLevelModalOverlay');
                }
            },
            updateNutritionCalculationWeight() {
                const source = document.querySelector('input[name="calculationWeightSource"]:checked')?.value; // Safe access
                const finalWeightInput = document.getElementById('nutritionFinalCalculationWeight');
                 if (!finalWeightInput) return; // Exit if not found

                if (source === 'custom') {
                    // When custom is selected, don't auto-update the value, just recalculate goals based on it
                } else {
                     const dailyWeight = parseFloat(document.getElementById('dailyWeight')?.value); // Safe
                     const idealOrAdjustedWeight = parseFloat(document.getElementById('idealWeight')?.value); // Safe

                    if (source === 'ideal') {
                        finalWeightInput.value = isNaN(idealOrAdjustedWeight) ? '' : idealOrAdjustedWeight.toFixed(1);
                    } else { // source === 'daily'
                        finalWeightInput.value = isNaN(dailyWeight) ? '' : dailyWeight.toFixed(1);
                    }
                }

                // Always update goals after weight source logic
                this.updateNutritionGoal();
                this.updateProteinGoal();
                this.updateFluidGoal();
                 // Recalculate planned nutrition as goals/weight might affect prognosis %
                 this.calculatePlannedNutrition();
            },
            updateNutritionGoal() {
                const kcalSlider = document.getElementById('kcalSlider');
                 if (!kcalSlider) return;
                const kcalPerKg = parseFloat(kcalSlider.value);
                let calculationWeight = parseFloat(document.getElementById('nutritionFinalCalculationWeight')?.value); // Safe
                const temp = parseFloat(document.getElementById('maxTemp')?.value); // Safe
                const adjustForFever = document.getElementById('applyFeverAdjustment')?.checked; // Safe access

                const kcalGoalDisplay = document.getElementById('kcalGoalDisplay');
                const kcalSliderValue = document.getElementById('kcalSliderValue');
                const nutritionLevelDisplay = document.getElementById('nutritionLevelDisplay');
                const selectedNutritionLevel = document.getElementById('selectedNutritionLevel');
                const kcalFeverWarning = document.getElementById('kcalFeverWarning');

                 if (kcalSliderValue) kcalSliderValue.textContent = `${kcalPerKg} kcal/kg`;

                if (calculationWeight && !isNaN(calculationWeight)) {
                    let totalKcal = Math.round(kcalPerKg * calculationWeight);

                    if(adjustForFever && temp > 37 && !isNaN(temp)) { // Added NaN check
                        const feverAdjustmentPercent = (temp - 37) * 10;
                        totalKcal = Math.round(totalKcal * (1 + feverAdjustmentPercent / 100));
                        if (kcalFeverWarning) {
                            kcalFeverWarning.textContent = `(Feberjusterat +${feverAdjustmentPercent.toFixed(0)}%)`;
                            kcalFeverWarning.style.display = 'block';
                        }
                    } else if (kcalFeverWarning) {
                        kcalFeverWarning.style.display = 'none';
                    }

                    if (kcalGoalDisplay) kcalGoalDisplay.textContent = `Mål: ${totalKcal} kcal/dygn`;
                } else {
                    if (kcalGoalDisplay) kcalGoalDisplay.textContent = `Mål: Ange patientdata`;
                    if (kcalFeverWarning) kcalFeverWarning.style.display = 'none';
                }

                if (kcalSlider.disabled || !nutritionLevelDisplay || !selectedNutritionLevel) return;

                let levelText = "Egen inställning";
                 if (kcalPerKg < 12.5) levelText = "Nivå 0: Resusciteringsfas (5-10 kcal/kg)";
                else if (kcalPerKg < 17.5) levelText = "Nivå 1: Akut instabil fas (15 kcal/kg)";
                else if (kcalPerKg < 22.5) levelText = "Nivå 2: Akut stabil fas (20 kcal/kg)";
                else if (kcalPerKg < 27.5) levelText = "Nivå 3: Tidig återuppbyggnadsfas (25 kcal/kg)";
                else levelText = "Nivå 4: Återhämtningsfas (30-35 kcal/kg)";

                nutritionLevelDisplay.textContent = levelText;
                selectedNutritionLevel.value = levelText;
                 this.calculatePlannedNutrition(); // Update prognosis if goal changes
            },
            updateProteinGoal() {
                const proteinSlider = document.getElementById('proteinSlider');
                 if (!proteinSlider) return;
                const proteinPerKg = parseFloat(proteinSlider.value);
                let calculationWeight = parseFloat(document.getElementById('nutritionFinalCalculationWeight')?.value); // Safe
                const height = parseFloat(document.getElementById('height')?.value); // Safe
                const dailyWeight = parseFloat(document.getElementById('dailyWeight')?.value); // Safe
                const adjustForBmi = document.getElementById('applyBmiAdjustment')?.checked; // Safe access

                const proteinGoalDisplay = document.getElementById('proteinGoalDisplay');
                const proteinSliderValue = document.getElementById('proteinSliderValue');
                const proteinLevelDisplay = document.getElementById('proteinLevelDisplay');
                const selectedProteinLevel = document.getElementById('selectedProteinLevel');
                const proteinBmiWarning = document.getElementById('proteinBmiWarning');

                 if (proteinSliderValue) proteinSliderValue.textContent = `${proteinPerKg.toFixed(1)} g/kg`;

                if (proteinBmiWarning) { // Check if element exists
                    if(height && dailyWeight && !isNaN(height) && !isNaN(dailyWeight) && height > 0) { // Added checks
                        const bmi = dailyWeight / ((height/100) * (height/100));
                        if(adjustForBmi && bmi > 25) {
                            calculationWeight = 25 * ((height/100) * (height/100)); // Calculate weight for BMI 25
                             calculationWeight = Math.max(0, calculationWeight); // Ensure non-negative
                            proteinBmiWarning.style.display = 'block';
                        } else {
                            proteinBmiWarning.style.display = 'none';
                        }
                    } else {
                        proteinBmiWarning.style.display = 'none';
                    }
                }


                if (calculationWeight && !isNaN(calculationWeight)) {
                     calculationWeight = Math.max(0, calculationWeight); // Ensure non-negative
                    const totalProtein = Math.round(proteinPerKg * calculationWeight);
                    if (proteinGoalDisplay) proteinGoalDisplay.textContent = `Mål: ${totalProtein} g/dygn`;
                } else {
                    if (proteinGoalDisplay) proteinGoalDisplay.textContent = `Mål: Ange patientdata`;
                }

                if(proteinSlider.disabled || !proteinLevelDisplay || !selectedProteinLevel) return;

                let levelText = "Egen inställning";
                if (proteinPerKg <= 0.6) {
                    levelText = "Kronisk njursvikt utan dialys";
                } else if (proteinPerKg >= 1.3 && proteinPerKg <= 1.5) {
                    levelText = "Standard IVA-patient";
                } else if (proteinPerKg >= 1.6 && proteinPerKg <= 2.0) {
                    levelText = "Brännskador, IHD, trauma";
                } else if (proteinPerKg > 2.0) { // Should only happen via button click setting 2.0
                    levelText = "Obesitas (BMI > 30)";
                }

                proteinLevelDisplay.textContent = levelText;
                selectedProteinLevel.value = levelText;
                 this.calculatePlannedNutrition(); // Update prognosis if goal changes
            },
             updateFluidGoal() {
                const fluidSlider = document.getElementById('fluidSlider');
                 if (!fluidSlider) return;
                const fluidPerKg = parseFloat(fluidSlider.value);
                let calculationWeight = parseFloat(document.getElementById('nutritionFinalCalculationWeight')?.value); // Safe
                const height = parseFloat(document.getElementById('height')?.value); // Safe
                const dailyWeight = parseFloat(document.getElementById('dailyWeight')?.value); // Safe
                const temp = parseFloat(document.getElementById('maxTemp')?.value); // Safe
                const adjustForFever = document.getElementById('applyFeverAdjustment')?.checked; // Safe access
                const adjustForBmi = document.getElementById('applyBmiAdjustment')?.checked; // Safe access

                const fluidGoalDisplay = document.getElementById('fluidGoalDisplay');
                const fluidSliderValue = document.getElementById('fluidSliderValue');
                const fluidBmiWarning = document.getElementById('fluidBmiWarning');
                const fluidFeverWarning = document.getElementById('fluidFeverWarning');

                 if (fluidSliderValue) fluidSliderValue.textContent = `${fluidPerKg} ml/kg`;

                if (fluidBmiWarning) { // Check if element exists
                    if(height && dailyWeight && !isNaN(height) && !isNaN(dailyWeight) && height > 0) { // Added checks
                        const bmi = dailyWeight / ((height/100) * (height/100));
                        if(adjustForBmi && bmi > 25) {
                            calculationWeight = 25 * ((height/100) * (height/100)); // Calculate weight for BMI 25
                            calculationWeight = Math.max(0, calculationWeight); // Ensure non-negative
                            fluidBmiWarning.style.display = 'block';
                        } else {
                            fluidBmiWarning.style.display = 'none';
                        }
                    } else {
                        fluidBmiWarning.style.display = 'none';
                    }
                }

                if (calculationWeight && !isNaN(calculationWeight)) {
                     calculationWeight = Math.max(0, calculationWeight); // Ensure non-negative
                    let totalFluid = Math.round(fluidPerKg * calculationWeight);

                    if(adjustForFever && temp > 37 && !isNaN(temp)) { // Added NaN check
                        const feverAdjustmentMl = (temp - 37) * 200;
                        totalFluid += Math.round(feverAdjustmentMl);
                        if (fluidFeverWarning) {
                            fluidFeverWarning.textContent = `(Feberjusterat +${Math.round(feverAdjustmentMl)} ml)`;
                            fluidFeverWarning.style.display = 'block';
                        }
                    } else if (fluidFeverWarning) {
                        fluidFeverWarning.style.display = 'none';
                    }
                    if (fluidGoalDisplay) fluidGoalDisplay.textContent = `Mål: ${totalFluid} ml/dygn`;
                } else {
                    if (fluidGoalDisplay) fluidGoalDisplay.textContent = `Mål: Ange patientdata`;
                    if (fluidFeverWarning) fluidFeverWarning.style.display = 'none';
                }
                 this.calculatePlannedNutrition(); // Update prognosis if goal changes
            },
             updateResults() {
                const kcalGoalText = document.getElementById('kcalGoalDisplay')?.textContent || ''; // Safe access
                const proteinGoalText = document.getElementById('proteinGoalDisplay')?.textContent || ''; // Safe access
                const fluidGoalText = document.getElementById('fluidGoalDisplay')?.textContent || ''; // Safe access

                const kcalGoal = parseFloat(kcalGoalText.match(/(\d+)\s*kcal/)?.[1]) || 0;
                const proteinGoal = parseFloat(proteinGoalText.match(/(\d+)\s*g/)?.[1]) || 0;
                const fluidGoal = parseFloat(fluidGoalText.match(/(\d+)\s*ml/)?.[1]) || 0;


                const currentKcal = Math.round(this.state.totalIntakeKcal);
                const currentFluid = Math.round(this.state.totalIntakeMl);
                const currentProtein = this.state.totalIntakeProtein; // Use potentially non-rounded state value for calculation

                const energyPercent = kcalGoal > 0 ? Math.round((currentKcal / kcalGoal) * 100) : 0;
                const fluidPercent = fluidGoal > 0 ? Math.round((currentFluid / fluidGoal) * 100) : 0;
                const proteinPercent = proteinGoal > 0 ? Math.round((currentProtein / proteinGoal) * 100) : 0;

                // Update UI safely
                 const energyValEl = document.getElementById('energyResultValue');
                 if (energyValEl) energyValEl.textContent = `${currentKcal} kcal`;
                 const energyPercEl = document.getElementById('energyResultPercent');
                 if (energyPercEl) energyPercEl.textContent = `(${energyPercent}% av mål)`;

                 const proteinValEl = document.getElementById('proteinResultValue');
                 if (proteinValEl) proteinValEl.textContent = `${currentProtein.toFixed(1)} g`; // Show one decimal for protein
                 const proteinPercEl = document.getElementById('proteinResultPercent');
                 if (proteinPercEl) proteinPercEl.textContent = `(${proteinPercent}% av mål)`;

                 const fluidValEl = document.getElementById('fluidResultValue');
                 if (fluidValEl) fluidValEl.textContent = `${currentFluid} ml`;
                 const fluidPercEl = document.getElementById('fluidResultPercent');
                 if (fluidPercEl) fluidPercEl.textContent = `(${fluidPercent}% av basalbehov)`;
            },
            // --- NEW: Calculate Planned Nutrition ---
             calculatePlannedNutrition() {
                 // Ensure DOM elements are cached and ready
                  if (!this.dom.nutritionPlan || !this.dom.nutritionPlan.startTime || !this.dom.nutritionPlan.endTime) {
                      // console.warn("Planned nutrition elements not ready during calculation."); // Less aggressive warning
                      return; // Don't proceed if core elements aren't there
                  }
                 const startTime = this.dom.nutritionPlan.startTime.value;
                 const endTime = this.dom.nutritionPlan.endTime.value;
                 const duration = this.calculateDurationInHours(startTime, endTime);
                 this.state.plannedNutrition.duration = duration;
                  if (this.dom.nutritionPlan.duration) this.dom.nutritionPlan.duration.textContent = `Planerad tid: ${duration.toFixed(1)} timmar`;

                 let totalInfusionKcalPerHour = 0;
                 let totalInfusionProteinPerHour = 0;
                 let totalBolusKcal = 0;
                 let totalBolusProtein = 0;

                 // Calculate infusions
                 this.dom.nutritionPlan.infusionsContainer?.querySelectorAll('.planned-nutrition-row').forEach(row => { // Safe access
                     const select = row.querySelector('.select-main');
                     const rateInput = row.querySelector('.rate-input');
                     const rate = parseFloat(rateInput?.value) || 0;
                     const selectedOption = select?.options[select.selectedIndex];

                     if (selectedOption && rate > 0) {
                         const kcalPerMl = parseFloat(selectedOption.dataset.kcalPerMl || '0');
                         const proteinPerMl = parseFloat(selectedOption.dataset.proteinPerMl || '0');
                         totalInfusionKcalPerHour += rate * kcalPerMl;
                         totalInfusionProteinPerHour += rate * proteinPerMl;
                     }
                 });

                 // Calculate boluses
                 this.dom.nutritionPlan.bolusesContainer?.querySelectorAll('.planned-nutrition-row').forEach(row => { // Safe access
                     const select = row.querySelector('.select-main');
                     const amountInput = row.querySelector('.amount-input');
                     const amount = parseFloat(amountInput?.value) || 0;
                     const selectedOption = select?.options[select.selectedIndex];

                     if (selectedOption && amount > 0) {
                         const kcalPerMl = parseFloat(selectedOption.dataset.kcalPerMl || '0');
                         const proteinPerMl = parseFloat(selectedOption.dataset.proteinPerMl || '0');
                         totalBolusKcal += amount * kcalPerMl;
                         totalBolusProtein += amount * proteinPerMl;
                     }
                 });

                 // Update state
                 this.state.plannedNutrition.totalInfusionKcalPerHour = totalInfusionKcalPerHour;
                 this.state.plannedNutrition.totalInfusionProteinPerHour = totalInfusionProteinPerHour;
                 this.state.plannedNutrition.totalBolusKcal = totalBolusKcal;
                 this.state.plannedNutrition.totalBolusProtein = totalBolusProtein;

                 const plannedTotalKcalFromInfusions = totalInfusionKcalPerHour * duration;
                 const plannedTotalProteinFromInfusions = totalInfusionProteinPerHour * duration;

                 this.state.plannedNutrition.plannedTotalKcal = plannedTotalKcalFromInfusions + totalBolusKcal;
                 this.state.plannedNutrition.plannedTotalProtein = plannedTotalProteinFromInfusions + totalBolusProtein;

                 // Update UI for planned summary safely
                  if (this.dom.nutritionPlan.infusionTotalKcalPerHour) this.dom.nutritionPlan.infusionTotalKcalPerHour.textContent = Math.round(totalInfusionKcalPerHour);
                  if (this.dom.nutritionPlan.infusionTotalProteinPerHour) this.dom.nutritionPlan.infusionTotalProteinPerHour.textContent = totalInfusionProteinPerHour.toFixed(1);
                  if (this.dom.nutritionPlan.bolusTotalKcal) this.dom.nutritionPlan.bolusTotalKcal.textContent = Math.round(totalBolusKcal);
                  if (this.dom.nutritionPlan.bolusTotalProtein) this.dom.nutritionPlan.bolusTotalProtein.textContent = totalBolusProtein.toFixed(1);
                  if (this.dom.nutritionPlan.plannedTotalKcal) this.dom.nutritionPlan.plannedTotalKcal.textContent = Math.round(this.state.plannedNutrition.plannedTotalKcal);
                  if (this.dom.nutritionPlan.plannedTotalProtein) this.dom.nutritionPlan.plannedTotalProtein.textContent = this.state.plannedNutrition.plannedTotalProtein.toFixed(1);

                  // Calculate and update prognosis
                  this.updateNutritionPrognosis();
             },
              // --- NEW: Update Prognosis ---
              updateNutritionPrognosis() {
                  if (!this.dom.nutritionPlan || !this.dom.nutritionPlan.startTime) return; // Ensure elements are ready

                  const currentKcal = this.state.totalIntakeKcal;
                  const currentProtein = this.state.totalIntakeProtein;
                  const plannedKcal = this.state.plannedNutrition.plannedTotalKcal;
                  const plannedProtein = this.state.plannedNutrition.plannedTotalProtein;

                  const prognosisTotalKcal = currentKcal + plannedKcal;
                  const prognosisTotalProtein = currentProtein + plannedProtein;

                  const kcalGoalText = document.getElementById('kcalGoalDisplay')?.textContent || '';
                  const proteinGoalText = document.getElementById('proteinGoalDisplay')?.textContent || '';
                  const kcalGoal = parseFloat(kcalGoalText.match(/(\d+)\s*kcal/)?.[1]) || 0;
                  const proteinGoal = parseFloat(proteinGoalText.match(/(\d+)\s*g/)?.[1]) || 0;

                  const prognosisKcalPercent = kcalGoal > 0 ? Math.round((prognosisTotalKcal / kcalGoal) * 100) : 0;
                  const prognosisProteinPercent = proteinGoal > 0 ? Math.round((prognosisTotalProtein / proteinGoal) * 100) : 0;

                  // Update state
                  this.state.plannedNutrition.prognosisTotalKcal = prognosisTotalKcal;
                  this.state.plannedNutrition.prognosisTotalProtein = prognosisTotalProtein;
                  this.state.plannedNutrition.prognosisTotalKcalPercent = prognosisKcalPercent;
                  this.state.plannedNutrition.prognosisTotalProteinPercent = prognosisProteinPercent;

                  // Update UI safely
                  if (this.dom.nutritionPlan.prognosisTotalKcal) this.dom.nutritionPlan.prognosisTotalKcal.textContent = Math.round(prognosisTotalKcal);
                  if (this.dom.nutritionPlan.prognosisTotalKcalPercent) this.dom.nutritionPlan.prognosisTotalKcalPercent.textContent = prognosisKcalPercent;
                  if (this.dom.nutritionPlan.prognosisTotalProtein) this.dom.nutritionPlan.prognosisTotalProtein.textContent = prognosisTotalProtein.toFixed(1);
                  if (this.dom.nutritionPlan.prognosisTotalProteinPercent) this.dom.nutritionPlan.prognosisTotalProteinPercent.textContent = prognosisProteinPercent;
              },
            toggleTheme() {
                this.dom.body.classList.toggle('dark-theme');
                const isDark = this.dom.body.classList.contains('dark-theme');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                 if (this.dom.themeToggle) this.dom.themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            },
            loadTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                 const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
                 this.dom.body.classList.toggle('dark-theme', isDark);
                 if (this.dom.themeToggle) this.dom.themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>

