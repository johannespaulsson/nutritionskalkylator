<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutritionskalkylator IVA Sk√∂vde</title>
    
    <!-- L√§nkar till Font Awesome f√∂r ikoner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Grundl√§ggande stil f√∂r body */
        body {
            font-family: 'Inter', sans-serif;
            margin: 10px;
            background-color: #f4f4f4;
            color: #333;
            font-size: 0.9rem;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* Huvudbeh√•llare */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);
        }

        /* Rubriker */
        h2 {
            color: #1a73e8;
            border-bottom: 1px solid #1a73e8;
            padding-bottom: 4px;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.5em;
        }

        /* Rutn√§tslayout (3 kolumner) */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            align-items: start;
        }

        /* Rutor/Kort */
        .grid-item {
            margin-bottom: 8px;
            background-color: #fcfcfc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        .grid-item h3 {
            color: #1a73e8;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .grid-item label, .modal-content label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
        }

        /* Formul√§relement */
        .grid-item input[type="date"],
        .grid-item input[type="time"],
        .grid-item input[type="text"],
        .grid-item input[type="number"], 
        .grid-item select {
            width: calc(100% - 12px); /* Justerat f√∂r padding */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .grid-item input:disabled {
            background-color: #f5f5f5;
            border-color: #eee;
            color: #aaa;
            cursor: not-allowed;
        }

        .grid-item input:focus,
        .grid-item select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
            outline: none;
        }

        /* Input Grupper (F√§lt + Knapp) */
        .input-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .input-group input {
            flex-grow: 1;
            width: auto; 
        }
        .input-group button {
            padding: 8px 12px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            transition: background-color 0.2s, transform 0.1s;
        }
        .input-group button:hover {
            background-color: #0d47a1;
            transform: translateY(-1px);
        }
        .input-group button:active {
            transform: translateY(0);
        }

        /* Radio & Checkbox grupper */
        .radio-group, .checkbox-group {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            background-color: #fdfdfd;
            margin-top: 10px;
        }
        .radio-group label, .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-weight: normal;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .radio-group label:last-child, .checkbox-group label:last-child {
            margin-bottom: 0;
        }
        .radio-group input, .checkbox-group input {
            margin-right: 8px;
            accent-color: #1a73e8;
            width: auto;
        }

        /* Justeringsrad (Temp) */
        .adjustment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            gap: 10px; 
        }
        .temp-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .temp-input-group label {
            font-weight: normal; 
            font-size: 0.85rem; 
            margin-bottom: 0;
        }
        /* Specifik stil f√∂r det lilla temp-f√§ltet */
        .grid-item .temp-input-group input[type="number"] {
            width: 40px; 
            padding: 2px 4px;
            font-size: 0.85rem;
            text-align: center;
            border: 1px solid #ccc; 
            border-radius: 4px;
            -moz-appearance: textfield;
        }
        .grid-item .temp-input-group input[type="number"]::-webkit-outer-spin-button,
        .grid-item .temp-input-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .temp-input-group span {
            font-size: 0.85rem; 
            color: #555; 
        }

        /* BMI Display */
        .bmi-display {
            margin-top: 12px;
            padding: 10px;
            background-color: #f0f4f8;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
            color: #444;
        }
        .bmi-display.bmi-warning {
            color: #b71c1c;
            font-weight: 600;
            background-color: #ffebee;
            border-color: #ffcdd2;
        }

        /* Resultat Display (Kolumn 3) */
        .result-display {
            background-color: #e8f0fe;
            border: 1px solid #d0e0fd;
            border-radius: 6px;
            padding: 15px;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #d0e0fd;
        }
        .result-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .result-label {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }
        .result-value {
            font-weight: bold;
            color: #1a73e8;
            font-size: 1.2rem;
        }
        .result-unit {
            font-size: 0.85rem;
            color: #666;
            margin-left: 4px;
        }

        /* ----- TOAST NOTIFICATION ----- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            pointer-events: none; /* Klick g√•r igenom om ingen toast finns */
        }
        .toast {
            pointer-events: auto;
            background-color: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUpFade 0.4s ease-out;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .toast i {
            color: #4caf50; /* Gr√∂n bock */
        }
        .toast.info i {
            color: #2196f3; /* Bl√• info */
        }
        .toast u {
            cursor: pointer;
            color: #90caf9;
            text-decoration: none;
            border-bottom: 1px dotted #90caf9;
            margin-left: 5px;
        }
        .toast u:hover {
            color: #bbdefb;
            border-bottom-style: solid;
        }
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }


        /* ----- MODALER ----- */
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background-color: #fcfcfc;
            border-radius: 8px 8px 0 0;
        }
        .modal-header h3 {
            margin: 0;
            color: #1a73e8;
            font-size: 1.2em;
        }
        .modal-close {
            color: #999;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover { color: #333; }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto; 
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
            background-color: #fcfcfc;
            border-radius: 0 0 8px 8px;
        }
        .modal-footer button {
            padding: 8px 16px;
            background-color: #666; /* Neutral st√§ngknapp */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-footer button:hover { background-color: #444; }

        /* Modal-inneh√•ll */
        .guidance-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .guidance-section:last-child { border-bottom: none; margin-bottom: 0; }
        
        .guidance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .guidance-header strong { font-size: 1.05em; color: #333; }
        
        .guidance-section p {
            font-size: 0.9rem;
            color: #555;
            margin: 0;
            line-height: 1.5;
        }
        
        .btn-select {
            padding: 6px 12px;
            background-color: #e8f0fe;
            color: #1a73e8;
            border: 1px solid #1a73e8;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-select:hover {
            background-color: #1a73e8;
            color: white;
        }
        
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        .info-table th, .info-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
        }
        .info-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }

        /* STIL F√ñR IMPORT-LISTAN */
        .patient-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .patient-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .patient-list li:hover {
            background-color: #f5f9ff;
        }
        .patient-list li:last-child {
            border-bottom: none;
        }
        .pat-id {
            font-weight: bold;
            color: #333;
            font-size: 0.95rem;
        }
        .pat-date {
            font-size: 0.85rem;
            color: #777;
        }

        /* --- DEV / TEST PANEL --- */
        .dev-panel {
            margin: 30px auto;
            max-width: 1200px;
            border: 2px dashed #ff9800;
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 8px;
        }
        .dev-panel summary {
            cursor: pointer;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 10px;
        }
        .dev-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .dev-button {
            padding: 5px 10px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .dev-output {
            background-color: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Nutritionskalkylator</h2>

        <div class="grid-container">
            <!-- Kolumn 1: Ber√§kningsvikt -->
            <div class="grid-item">
                <h3>Ber√§kningsvikt</h3>

                <label for="length">L√§ngd (cm)</label>
                <input type="number" id="length" placeholder="Ange l√§ngd...">

                <label for="gender" style="margin-top: 10px;">K√∂n</label>
                <select id="gender" style="width: 100%;">
                    <option value="" disabled selected>Ange k√∂n</option>
                    <option value="male">Man</option>
                    <option value="female">Kvinna</option>
                </select>
                
                <label for="currentWeight" style="margin-top: 10px;">Dagens vikt (kg)</label>
                <input type="number" id="currentWeight" placeholder="Ange dagens vikt...">

                <!-- Alternativ f√∂r ber√§kningsvikt -->
                <div class="radio-group" style="margin-top: 12px;">
                    <label>
                        <input type="radio" name="weightType" value="ideal" checked> Ber√§kna fr√•n Idealvikt
                    </label>
                    <label>
                        <input type="radio" name="weightType" value="current"> Anv√§nd Dagens vikt
                    </label>
                    <label>
                        <input type="radio" name="weightType" value="other"> Annat
                    </label>
                </div>

                <label for="calculationWeight" style="margin-top: 10px;">Ber√§kningsvikt (kg) 
                    <span id="adjustedText" style="font-weight: normal; color: #555; font-size: 0.8rem;"></span>
                </label>
                <input type="number" id="calculationWeight" placeholder="Ber√§knad vikt...">

                <!-- BMI-display -->
                <div id="bmiResult" class="bmi-display">
                    Ange l√§ngd och dagens vikt f√∂r BMI
                </div>
            </div>
            
            <!-- Kolumn 2: Behovsbed√∂mning -->
            <div class="grid-item">
                <h3>Behovsbed√∂mning</h3>
                
                <label for="calorieNeed">Kaloribehov (kcal/kg/dygn)</label>
                <div class="input-group">
                    <input type="number" id="calorieNeed" placeholder="Ange kaloribehov...">
                    <!-- Knapp f√∂r att √∂ppna modalen -->
                    <button id="calorieGuidanceBtn">V√§gledning</button>
                </div>

                <label for="proteinNeed" style="margin-top: 10px;">Proteinbehov (g/kg/dygn)</label>
                <div class="input-group">
                    <input type="number" id="proteinNeed" placeholder="Ange proteinbehov..." step="0.1">
                    <button id="proteinGuidanceBtn">V√§gledning</button> 
                </div>
            
                <label for="fluidNeed" style="margin-top: 10px;">Basalt v√§tskebehov (ml/kg/dygn)</label>
                <div class="input-group">
                    <input type="number" id="fluidNeed" placeholder="Ange v√§tskebehov...">
                    <button id="fluidGuidanceBtn">V√§gledning</button>
                </div>

                <!-- Nya checkboxar -->
                <div class="checkbox-group" style="margin-top: 12px;">
                    <!-- Rad 1: Feberjustering -->
                    <div class="adjustment-row">
                        <label for="feverAdjustment">
                            <input type="checkbox" id="feverAdjustment" checked> Feberjustering
                        </label>
                        <div class="temp-input-group">
                            <label for="meanTemp">Medeltemp:</label>
                            <input type="number" id="meanTemp" value="37.5" step="0.1">
                            <span>&deg;C</span>
                        </div>
                    </div>
                    
                    <!-- Rad 2: BMI-justering -->
                    <div class="adjustment-row" style="margin-top: 5px;">
                        <label for="bmiAdjustment">
                            <input type="checkbox" id="bmiAdjustment" checked> BMI-justering
                        </label>
                    </div>
                </div>
            </div>

            <!-- Kolumn 3: Resultat -->
            <div class="grid-item">
                <h3>Ber√§knat dygnsbehov</h3>
                <div class="result-display">
                    <div class="result-row">
                        <span class="result-label">Energi</span>
                        <div>
                            <span class="result-value" id="resEnergy">--</span>
                            <span class="result-unit">kcal/dygn</span>
                        </div>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Protein</span>
                        <div>
                            <span class="result-value" id="resProtein">--</span>
                            <span class="result-unit">g/dygn</span>
                        </div>
                    </div>
                    <div class="result-row">
                        <span class="result-label">V√§tska</span>
                        <div>
                            <span class="result-value" id="resFluid">--</span>
                            <span class="result-unit">ml/dygn</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #666; text-align: center;">
                    <span id="resFeverNote"></span>
                </div>
            </div>

        </div> 

        <!-- KNAPP F√ñR ATT NOLLST√ÑLLA & IMPORTERA -->
        <div style="display: flex; justify-content: space-between; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            
            <!-- Importknapp -->
            <button id="importBtn" style="padding: 10px 20px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s;">
                <i class="fas fa-folder-open" style="margin-right: 6px;"></i> H√§mta sparad patient
            </button>

            <!-- Resetknapp -->
            <button id="resetBtn" style="padding: 10px 20px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s;">
                <i class="fas fa-trash-alt" style="margin-right: 6px;"></i> Rensa allt
            </button>
        </div>

    </div> 
    
    <!-- --- DEV / TEST PANEL (SIMULERA ANDRA APPEN) --- -->
    <details class="dev-panel">
        <summary>üõ† Utvecklarverktyg: Simulera "V√§tskebalans IVA" (Testdata)</summary>
        <p style="margin-top: 0; font-size: 0.85rem; color: #555;">
            Denna panel simulerar att din andra app sparar data i LocalStorage enligt din specifikation (iva_skovde_vatskebalans_saves).
        </p>
        
        <div class="dev-controls">
            <button class="dev-button" id="btnDevShowStorage">Visa LocalStorage</button>
            <button class="dev-button" id="btnDevClearStorage">Rensa LocalStorage</button>
            <button class="dev-button" id="btnDevGenPatients">Generera test-patienter</button>
        </div>
        
        <div class="dev-output" id="devOutput">Klicka p√• en knapp f√∂r att se data...</div>
    </details>

    <!-- ----- MODALER ----- -->
    
    <div id="calorieModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3>V√§gledning: Kaloribehov</h3>
                <span class="modal-close">&times;</span> 
            </div>
            <div class="modal-body">
                
                <div class="guidance-section">
                    <div class="guidance-header">
                        <strong>Niv√• 0 (5-10 kcal/kg/dygn)</strong>
                        <button class="btn-select" data-value="5">V√§lj 5</button>
                    </div>
                    <p><strong>Resusciteringsfas.</strong> Sv√•r respiratorisk och cirkulatorisk svikt, t.ex. √∂verh√§ngande intubationsrisk, sv√•r SIRS, CO2-retention, massivt inotropt-, volyms- eller vasopressorbehov. Enbart kristalloid v√§tskeers√§ttning och ev. 5-10% glukos.</p>
                </div>
                
                <div class="guidance-section">
                    <div class="guidance-header">
                        <strong>Niv√• 1 (15 kcal/kg/dygn)</strong>
                        <button class="btn-select" data-value="15">V√§lj 15</button>
                    </div>
                    <p><strong>Akut instabil fas.</strong> Fortsatt h√∂gt syrgasbehov och adrenergt st√∂d, men inget √∂verh√§ngande hot. Djup sedation. B√∂r kunna startas dag 1-2 om ej extremt instabil.</p>
                </div>

                <div class="guidance-section">
                    <div class="guidance-header">
                        <strong>Niv√• 2 (20 kcal/kg/dygn)</strong>
                        <button class="btn-select" data-value="20">V√§lj 20</button>
                    </div>
                    <p><strong>Akut stabil fas.</strong> Patienten forts√§tter f√∂rb√§ttras och d√§r nutrition redan startats p√• niv√• 1. B√∂r kunna n√•s dygnet efter niv√• 1.</p>
                </div>

                <div class="guidance-section">
                    <div class="guidance-header">
                        <strong>Niv√• 3 (25 kcal/kg/dygn)</strong>
                        <button class="btn-select" data-value="25">V√§lj 25</button>
                    </div>
                    <p><strong>Tidig √•teruppbyggnadsfas.</strong> Tillst√•ndet b√∂rjar v√§nda. Stabilt syrgas- respektive inotropi-/vasopressorbehov.</p>
                </div>

                <div class="guidance-section">
                    <div class="guidance-header">
                        <strong>Niv√• 4 (30-35 kcal/kg/dygn)</strong>
                        <button class="btn-select" data-value="30">V√§lj 30</button>
                    </div>
                    <p><strong>√Öterh√§mtnings-/mobiliseringsfas.</strong> √ñkande energibehov.</p>
                </div>
                
                <div class="guidance-section">
                    <strong>Information om Feberjustering</strong>
                    <p>Vid feber har patienten √∂kat kaloribehov. Detta hanteras av checkboxen "Feberjustering" i huvudf√∂nstret.</p>
                    <table class="info-table">
                        <thead>
                            <tr>
                                <th>Feber</th>
                                <th>√ñkat kaloribehov/dygn</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>38 grader</td>
                                <td>10%</td>
                            </tr>
                            <tr>
                                <td>39 grader</td>
                                <td>20%</td>
                            </tr>
                            <tr>
                                <td>40 grader</td>
                                <td>30%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <button>St√§ng</button> 
            </div>
        </div>
    </div>
    
    <div id="proteinModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3>V√§gledning: Proteinbehov</h3>
                <span class="modal-close">&times;</span> 
            </div>
            <div class="modal-body">
                
                <div class="guidance-section">
                    <p>ESPEN guidelines fr√•n 2019 rekommenderar en proteintillf√∂rsel p√• 1,3-1,5 protein/kg/dygn f√∂r IVA-patienter.</p>
                </div>

                <div class="guidance-section">
                    <strong>Rekommendationer</strong>
                    <table class="info-table">
                        <thead>
                            <tr>
                                <th>Patientgrupp</th>
                                <th>Proteinbehov (g/kg/dygn)</th>
                                <th>V√§lj</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>IVA-patient, akut njursvikt, leversvikt, CRRT</td>
                                <td>1,3‚Äì1,5</td>
                                <td><button class="btn-select" data-value="1.3">V√§lj 1.3</button></td>
                            </tr>
                            <tr>
                                <td>Br√§nnskador, obesitas, hemodialys, (trauma)</td>
                                <td>1,5‚Äì2</td>
                                <td><button class="btn-select" data-value="1.5">V√§lj 1.5</button></td>
                            </tr>
                            <tr>
                                <td>Kronisk njursvikt utan dialys</td>
                                <td>0,6</td>
                                <td><button class="btn-select" data-value="0.6">V√§lj 0.6</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="guidance-section">
                    <strong>Bakgrund</strong>
                    <p>Hos kritiskt sjuk intensivv√•rdspatient sker proteolys och muskelminskning med upp till 1 kg/dygn. Det finns stor risk att patienterna p√• IVA undernutrieras g√§llande protein. √ñkat proteinintag kan ha positiva effekter som minskad mortalitet, tidigare extubation och kortare v√•rdtid. Proteinbehovet ber√§knas utifr√•n vikt vid BMI 25 om patienten √§r √∂verviktig. Proteinbehovet r√§knas ut och dokumenteras p√• √∂vervakningskurvan.</p>
                </div>
                
                <div class="guidance-section">
                    <strong>Proteintillf√∂rsel</strong>
                    <p>Protein tillf√∂rs prim√§rt patienten via sondn√§ring, n√§ringsdrycker, mat, dryck, l√§kemedel och i sista hand TPN. Proteinpulver anv√§nds i f√∂rsta hand som komplement f√∂r att uppn√• patientens proteinbehov. Detta ges d√• i form av portionsp√•sar av Fresubin proteinpulver. En p√•se r√∂rs ut i kall eller varm v√§tska alternativt mat (<100¬∞C) och ger 10 gram protein/p√•se.</p>
                </div>

            </div>
            <div class="modal-footer">
                <button>St√§ng</button> 
            </div>
        </div>
    </div>

    <div id="fluidModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3>V√§gledning: V√§tskebehov</h3>
                <span class="modal-close">&times;</span> 
            </div>
            <div class="modal-body">
                
                <div class="guidance-section">
                    <div class="guidance-header">
                        <strong>Generellt behov (25-30 ml/kg/dygn)</strong>
                        <span>
                            <button class="btn-select" data-value="25">V√§lj 25</button>
                            <button class="btn-select" data-value="30">V√§lj 30</button>
                        </span>
                    </div>
                    <p>Generellt v√§tskebehov per dygn cirka 25-30 ml/kg.</p>
                </div>

                <div class="guidance-section">
                    <strong>Regler</strong>
                    <p>V√§tskebehovet ber√§knas utifr√•n vikt vid BMI 25 om patienten √§r √∂verviktig. V√§tskebehovet r√§knas ut och dokumenteras p√• √∂vervakningskurvan.</p>
                </div>

                <div class="guidance-section">
                    <strong>Undantag & S√§rskilda fall</strong>
                    <p>V√§tskebehovet skiljer sig dock √•t vid sepsis, dehydrering, lung√∂dem, feber etc.</p>
                    <ul style="font-size: 0.85rem; color: #555; padding-left: 20px; margin-top: 5px;">
                        <li><strong>Dehydrering utan chock:</strong> 5% av kroppsvikten ska ers√§ttas.</li>
                        <li><strong>Dehydrering med chock:</strong> 10% av kroppsvikten ska ers√§ttas.</li>
                    </ul>
                </div>

            </div>
            <div class="modal-footer">
                <button>St√§ng</button> 
            </div>
        </div>
    </div>

    <!-- --- MODAL F√ñR BEKR√ÑFTELSE AV RESET --- -->
    <div id="confirmModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Rensa allt?</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p>√Ñr du s√§ker p√• att du vill rensa alla f√§lt? Detta kan inte √•ngras.</p>
            </div>
            <div class="modal-footer">
                <button id="cancelResetBtn" style="background-color: #aaa; margin-right: 10px;">Avbryt</button>
                <button id="confirmResetBtn" style="background-color: #f44336;">Ja, rensa</button>
            </div>
        </div>
    </div>
    
    <!-- --- MODAL F√ñR ATT V√ÑLJA SPARAD PATIENT --- -->
    <div id="importModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3>V√§lj sparad patient</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 15px;">V√§lj en patient fr√•n listan (sparad fr√•n V√§tskebalans-appen):</p>
                <ul id="savedPatientList" class="patient-list">
                    <!-- Listan fylls p√• med JS -->
                    <li style="color: #aaa; font-style: italic;">H√§mtar lista...</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="close-import">St√§ng</button>
            </div>
        </div>
    </div>


    <script>
        // GLOBAL HJ√ÑLPFUNKTION F√ñR TOAST (m√•ste ligga utanf√∂r DOMContentLoaded om den anropas i HTML, men h√§r ok)
        function showToast(message, duration = 4000) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (message.includes('Nyare data')) toast.classList.add('info');
            
            // Ikon
            let icon = '<i class="fas fa-check-circle"></i>';
            if (message.includes('Nyare')) icon = '<i class="fas fa-info-circle"></i>';
            
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        // Exponera en funktion f√∂r "Force Load" fr√•n toasten
        window.forceLoadLatest = function() {
            const storedJSON = localStorage.getItem('iva_skovde_vatskebalans_saves');
            if (storedJSON) {
                const allSaves = JSON.parse(storedJSON);
                const sortedKeys = Object.keys(allSaves).sort((a, b) => b - a);
                if(sortedKeys.length > 0) {
                    const latestSave = allSaves[sortedKeys[0]];
                    // Dispatcha ett custom event eller anropa en global funktion
                    // F√∂renkling: Vi s√§tter en flagga och laddar om sidan, eller accessar via window-objekt om vi exponerat main-logiken.
                    // Eftersom populateForm ligger inuti DOMContentLoaded scope, m√•ste vi vara lite smarta.
                    // L√∂sning: Vi triggar en ny s√∂kning via knappen "Importera" programmatiskt, eller reload.
                    // Enklast: Spara "auto_load_latest" flagga och reload.
                    localStorage.setItem('iva_auto_load_trigger', 'true');
                    location.reload();
                }
            }
        };


        document.addEventListener('DOMContentLoaded', () => {

            // === H√§mta element fr√•n DOM ===
            const lengthInput = document.getElementById('length');
            const genderInput = document.getElementById('gender');
            const currentWeightInput = document.getElementById('currentWeight');
            const calculationWeightInput = document.getElementById('calculationWeight');
            const adjustedTextInput = document.getElementById('adjustedText');
            const weightTypeRadios = document.querySelectorAll('input[name="weightType"]');
            const bmiResultDiv = document.getElementById('bmiResult');

            const calorieNeedInput = document.getElementById('calorieNeed');
            const proteinNeedInput = document.getElementById('proteinNeed');
            const fluidNeedInput = document.getElementById('fluidNeed');
            const feverAdjustmentCheckbox = document.getElementById('feverAdjustment');
            const meanTempInput = document.getElementById('meanTemp');
            const bmiAdjustmentCheckbox = document.getElementById('bmiAdjustment');
            
            const resEnergy = document.getElementById('resEnergy');
            const resProtein = document.getElementById('resProtein');
            const resFluid = document.getElementById('resFluid');
            const resFeverNote = document.getElementById('resFeverNote');

            const resetBtn = document.getElementById('resetBtn'); 
            const confirmModal = document.getElementById('confirmModal');
            const confirmResetBtn = document.getElementById('confirmResetBtn');
            const cancelResetBtn = document.getElementById('cancelResetBtn');
            
            // Import-knapp och modal
            const importBtn = document.getElementById('importBtn');
            const importModal = document.getElementById('importModal');
            const savedPatientList = document.getElementById('savedPatientList');
            const importCloseButtons = document.querySelectorAll('.close-import, #importModal .modal-close');

            const allModals = document.querySelectorAll('.modal-backdrop');
            
            // Dev tools
            const btnDevShowStorage = document.getElementById('btnDevShowStorage');
            const btnDevClearStorage = document.getElementById('btnDevClearStorage');
            const btnDevGenPatients = document.getElementById('btnDevGenPatients');
            const devOutput = document.getElementById('devOutput');


            // === Funktioner ===

            const closeModal = (modalEl) => {
                modalEl.style.display = 'none';
                document.body.classList.remove('modal-open');
            };
            
            function setupModal(triggerBtnId, modalId, inputTargetId) {
                const triggerBtn = document.getElementById(triggerBtnId);
                const modal = document.getElementById(modalId);
                const inputTarget = document.getElementById(inputTargetId);
                
                if (!triggerBtn || !modal || !inputTarget) return;

                const closeBtn = modal.querySelector('.modal-close');
                const footerCloseBtn = modal.querySelector('.modal-footer button');
                const selectButtons = modal.querySelectorAll('.btn-select');

                triggerBtn.addEventListener('click', () => {
                    modal.style.display = 'block';
                    document.body.classList.add('modal-open');
                });

                const closeHandler = () => closeModal(modal);
                closeBtn.addEventListener('click', closeHandler);
                footerCloseBtn.addEventListener('click', closeHandler);

                selectButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const value = button.getAttribute('data-value');
                        inputTarget.value = value;
                        closeModal(modal);
                        calculateResults(); 
                    });
                });
            }

            function calculateAndDisplayBMI(weight, lengthCm) {
                if (!weight || !lengthCm || lengthCm <= 0 || weight <= 0) {
                    bmiResultDiv.textContent = 'Ange l√§ngd och dagens vikt f√∂r BMI';
                    bmiResultDiv.className = 'bmi-display'; 
                    return;
                }

                const lengthM = lengthCm / 100;
                const bmi = weight / (lengthM * lengthM);
                const bmiRounded = bmi.toFixed(1);

                let category = '';
                let isWarning = false;

                if (bmi < 18.5) {
                    category = 'Undervikt';
                    isWarning = true;
                } else if (bmi < 25) {
                    category = 'Normalvikt';
                } else if (bmi < 30) {
                    category = '√ñvervikt';
                    isWarning = true;
                } else if (bmi < 35) {
                    category = 'Obesitas grad 1';
                    isWarning = true;
                } else if (bmi < 40) {
                    category = 'Obesitas grad 2';
                    isWarning = true;
                } else {
                    category = 'Obesitas grad 3';
                    isWarning = true;
                }

                bmiResultDiv.textContent = `BMI: ${bmiRounded} (${category})`;
                if (isWarning) {
                    bmiResultDiv.classList.add('bmi-warning');
                } else {
                    bmiResultDiv.classList.remove('bmi-warning');
                }
            }

            // Spara data f√∂r delning (N√§r man jobbar i denna appen)
            function saveSharedData() {
                // Denna appen skriver INTE till 'iva_skovde_vatskebalans_saves' (det √§r bara f√∂r import)
                // Men vi sparar sessionen s√• man kan ladda om sidan
                const patientData = {
                    currentWeight: currentWeightInput.value,
                    calcWeight: calculationWeightInput.value,
                    length: lengthInput.value,
                    gender: genderInput.value,
                    temp: meanTempInput.value,
                    feverAdj: feverAdjustmentCheckbox.checked
                };

                if (patientData.currentWeight || patientData.length) {
                    localStorage.setItem('iva_nutrition_session', JSON.stringify(patientData));
                }
            }
            
            // Hj√§lpfunktion f√∂r att fylla i formul√§ret
            function populateForm(data) {
                if(!data || typeof data !== 'object') return;
                
                let pLen, pGen, pWgt, pTemp, pFev;

                // Fall 1: Data fr√•n V√§tskebalans-appen (enligt specifikation)
                if (data.patientInfo) {
                    pLen = data.patientInfo.height;
                    pGen = data.patientInfo.gender;
                    // Prioritera dagens vikt, annars intagsvikt
                    pWgt = data.patientInfo.dailyWeight || data.patientInfo.initialWeight;
                    
                    if (data.perspiratioCalc) {
                        pTemp = data.perspiratioCalc.maxTemp;
                    }
                    // Vi antar att om febertemp √§r satt > 37.5 s√• vill man ha feberjustering
                    const tempVal = parseFloat(pTemp);
                    pFev = (tempVal && tempVal > 37.5);
                } 
                // Fall 2: Sessionsdata fr√•n denna appen
                else {
                    pLen = data.length;
                    pGen = data.gender;
                    pWgt = data.currentWeight;
                    pTemp = data.temp;
                    pFev = (data.feverAdj !== undefined) ? data.feverAdj : true;
                }

                // Fyll i formul√§ret
                if(pLen) lengthInput.value = pLen;
                
                // Hantera K√∂n
                if(pGen) {
                    const gLower = pGen.toString().toLowerCase();
                    if(gLower.includes('man') || gLower.includes('male')) genderInput.value = "male";
                    else if(gLower.includes('kvin') || gLower.includes('fem')) genderInput.value = "female";
                }
                
                if(pWgt) currentWeightInput.value = pWgt;
                
                if(pTemp) meanTempInput.value = pTemp;
                
                feverAdjustmentCheckbox.checked = pFev;
                meanTempInput.disabled = !pFev;
                
                // Trigga omr√§kning
                updateCalculationWeight();
            }

            function updateCalculationWeight() {
                const length = parseFloat(lengthInput.value);
                const gender = genderInput.value;
                const currentWeight = parseFloat(currentWeightInput.value);
                const selectedType = document.querySelector('input[name="weightType"]:checked').value;

                adjustedTextInput.textContent = ''; 

                if (selectedType === 'current') {
                    calculationWeightInput.value = currentWeightInput.value;
                } else if (selectedType === 'ideal') {
                    if (length > 0 && gender) {
                        let idealWeight = 0;
                        if (gender === 'male') {
                            idealWeight = 50 + 0.91 * (length - 152.4);
                        } else {
                            idealWeight = 45.5 + 0.91 * (length - 152.4);
                        }

                        if (idealWeight < 0) idealWeight = 0;

                        if (bmiAdjustmentCheckbox.checked && currentWeight > (idealWeight * 1.2)) {
                            const adjustedWeight = idealWeight + 0.4 * (currentWeight - idealWeight);
                            calculationWeightInput.value = adjustedWeight.toFixed(1);
                            adjustedTextInput.textContent = '(justerad idealvikt)';
                        } else {
                            calculationWeightInput.value = idealWeight.toFixed(1);
                            adjustedTextInput.textContent = '';
                        }
                    } else {
                        calculationWeightInput.value = ''; 
                        adjustedTextInput.textContent = '';
                    }
                } 
                
                calculateAndDisplayBMI(currentWeight, length);
                calculateResults();
                saveSharedData();
            }
            
            function calculateResults() {
                const weight = parseFloat(calculationWeightInput.value);
                const kcalPerKg = parseFloat(calorieNeedInput.value);
                const protPerKg = parseFloat(proteinNeedInput.value);
                const fluidPerKg = parseFloat(fluidNeedInput.value);
                
                resEnergy.textContent = "--";
                resProtein.textContent = "--";
                resFluid.textContent = "--";
                resFeverNote.textContent = "";

                if (!weight || weight <= 0) return;

                // 1. Energi
                if (kcalPerKg > 0) {
                    let totalEnergy = weight * kcalPerKg;
                    
                    // Feberjustering
                    if (feverAdjustmentCheckbox.checked) {
                        const temp = parseFloat(meanTempInput.value);
                        if (temp >= 38.0) {
                            const extraFactor = (temp - 37) * 0.10; 
                            totalEnergy = totalEnergy * (1 + extraFactor);
                            resFeverNote.textContent = `(Inkl. febertill√§gg ca ${Math.round(extraFactor*100)}%)`;
                        }
                    }
                    resEnergy.textContent = Math.round(totalEnergy);
                }

                // 2. Protein
                if (protPerKg > 0) {
                    const totalProt = weight * protPerKg;
                    resProtein.textContent = totalProt.toFixed(1); 
                }

                // 3. V√§tska
                if (fluidPerKg > 0) {
                    const totalFluid = weight * fluidPerKg;
                    resFluid.textContent = Math.round(totalFluid);
                }
                
                saveSharedData();
            }
            
            // --- IMPORT-LOGIK (Specifik f√∂r V√§tskebalans-data) ---
            function updatePatientList() {
                // H√§mta data fr√•n den specifika nyckeln
                const storedJSON = localStorage.getItem('iva_skovde_vatskebalans_saves');
                let allSaves = {};
                
                if (storedJSON) {
                    try {
                        allSaves = JSON.parse(storedJSON);
                    } catch(e) { console.error("Kunde inte l√§sa patientlista", e); }
                }

                // Konvertera objektet till en lista och sortera (nyast f√∂rst)
                const sortedKeys = Object.keys(allSaves).sort((a, b) => b - a);

                savedPatientList.innerHTML = "";
                
                if (sortedKeys.length === 0) {
                     const li = document.createElement('li');
                     li.innerHTML = '<span style="color: #aaa; font-style: italic;">Inga sparade patienter hittades. Anv√§nd dev-tools nedan f√∂r att skapa testdata.</span>';
                     savedPatientList.appendChild(li);
                } else {
                    sortedKeys.forEach(key => {
                        const saveItem = allSaves[key];
                        // Plocka fram visningsnamn
                        let displayName = saveItem.name || "Ok√§nd patient";
                        // Om ingen "name" finns, bygg en av infon
                        if (!saveItem.name && saveItem.data && saveItem.data.patientInfo) {
                            const pi = saveItem.data.patientInfo;
                            displayName = `${pi.bedSelect || 'S√§ng?'} - ${pi.dateInput || ''}`;
                        }

                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div>
                                <div class="pat-id">${displayName}</div>
                                <div class="pat-date">ID: ${key}</div>
                            </div>
                            <div style="color: #1a73e8;"><i class="fas fa-arrow-right"></i></div>
                        `;
                        li.addEventListener('click', () => {
                            // H√§mta det inre 'data'-objektet
                            const clinicalData = saveItem.data;
                            if (clinicalData) {
                                if(confirm(`Vill du importera "${displayName}"?`)) {
                                    populateForm(clinicalData);
                                    closeModal(importModal);
                                    showToast(`Importerade: ${displayName}`);
                                }
                            } else {
                                alert("Kunde inte l√§sa data f√∂r denna patient.");
                            }
                        });
                        savedPatientList.appendChild(li);
                    });
                }
            }

            // --- AUTO-LADDNING (Sista pusselbiten) ---
            function autoLoadLatest() {
                // 1. Kolla om vi triggats av "Force Load"
                if (localStorage.getItem('iva_auto_load_trigger') === 'true') {
                    localStorage.removeItem('iva_auto_load_trigger');
                    loadLatestExternal(true); // Tvinga
                    return;
                }

                // 2. Kolla om vi har en p√•g√•ende session
                const hasSession = localStorage.getItem('iva_nutrition_session');
                
                if (hasSession) {
                    // Om session finns, ladda den f√∂rst
                    try { populateForm(JSON.parse(hasSession)); } catch(e){}
                    
                    // Kolla om det finns NYARE extern data?
                    // Det kan vara st√∂rande att f√• en fr√•ga varje g√•ng om man jobbar.
                    // Men vi kollar om det finns extern data och visar en diskret toast
                    checkIfExternalIsNewer();
                } else {
                    // Ingen session (tomt) -> F√∂rs√∂k ladda senaste externa direkt
                    loadLatestExternal(false); 
                }
            }

            function loadLatestExternal(force) {
                const storedJSON = localStorage.getItem('iva_skovde_vatskebalans_saves');
                if (!storedJSON) return;

                const allSaves = JSON.parse(storedJSON);
                const sortedKeys = Object.keys(allSaves).sort((a, b) => b - a); // Nyast f√∂rst
                
                if (sortedKeys.length > 0) {
                    const latest = allSaves[sortedKeys[0]];
                    
                    if (latest && latest.data) {
                        // Namn f√∂r toast
                        let pName = latest.name || "Patient";
                        if (!latest.name && latest.data.patientInfo) {
                            pName = `${latest.data.patientInfo.bedSelect || ''}`;
                        }

                        populateForm(latest.data);
                        showToast(`Data h√§mtad fr√•n ${pName}`);
                    }
                }
            }

            function checkIfExternalIsNewer() {
                const storedJSON = localStorage.getItem('iva_skovde_vatskebalans_saves');
                if (!storedJSON) return;
                
                const allSaves = JSON.parse(storedJSON);
                const sortedKeys = Object.keys(allSaves).sort((a, b) => b - a);
                
                if (sortedKeys.length > 0) {
                    const latest = allSaves[sortedKeys[0]];
                    // Visa toast med fr√•ga
                    let pName = latest.name || "Senaste patienten";
                    // Korta ner namnet om det √§r l√•ngt
                    if(pName.length > 20) pName = pName.substring(0, 20) + "...";
                    
                    showToast(`Hittade nyare data (${pName}). <u onclick="forceLoadLatest()">Ladda in?</u>`, 8000);
                }
            }


            // === DEV TOOLS LOGIK ===
            function refreshDevOutput() {
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    allData[key] = localStorage.getItem(key);
                }
                devOutput.textContent = JSON.stringify(allData, null, 2);
            }

            btnDevShowStorage.addEventListener('click', refreshDevOutput);
            
            btnDevClearStorage.addEventListener('click', () => {
                localStorage.clear();
                refreshDevOutput();
                alert("LocalStorage rensad!");
            });

            btnDevGenPatients.addEventListener('click', () => {
                // TESTDATA SOM MATCHAR DIN SPECIFIKATION
                const timestamp = Date.now();
                const testData = {
                    [timestamp]: {
                        id: timestamp,
                        name: "IVA 6 - 2025-11-17 06:00 (Test)",
                        timestamp: new Date().toISOString(),
                        data: {
                            patientInfo: {
                                dateInput: "2025-11-17",
                                startTime: "06:00",
                                endTime: "06:00",
                                bedSelect: "IVA 6",
                                otherLocationInput: "",
                                initialWeight: "70",
                                dailyWeight: "71",
                                height: "169",
                                gender: "Man",
                                isUnder15: "no",
                                cumulativeBalancePrev: "-500",
                                naclSyringes: "7",
                                pressureSets: "1"
                            },
                            fluidEntries: [],
                            medicineEntries: [],
                            bloodProductEntries: [],
                            tpnSondmatEntries: [],
                            lossEntries: [],
                            perspiratioCalc: {
                                breathingSupport: "standard",
                                maxTemp: "37.0"
                            },
                            diuresisCalc: {},
                            nutritionPlan: {}
                        }
                    }
                };
                
                const existing = localStorage.getItem('iva_skovde_vatskebalans_saves');
                let merged = testData;
                if(existing) {
                    try {
                        const parsed = JSON.parse(existing);
                        merged = { ...parsed, ...testData };
                    } catch(e) {}
                }

                localStorage.setItem('iva_skovde_vatskebalans_saves', JSON.stringify(merged));
                refreshDevOutput();
                showToast("Testdata skapad!");
            });


            // === Event Listeners ===

            setupModal('calorieGuidanceBtn', 'calorieModal', 'calorieNeed');
            setupModal('proteinGuidanceBtn', 'proteinModal', 'proteinNeed');
            setupModal('fluidGuidanceBtn', 'fluidModal', 'fluidNeed');

            window.addEventListener('click', (event) => {
                allModals.forEach(modal => {
                    if (event.target == modal) {
                        closeModal(modal);
                    }
                });
            });
            
            const confirmCloseBtn = confirmModal.querySelector('.modal-close');
            confirmCloseBtn.addEventListener('click', () => closeModal(confirmModal));
            cancelResetBtn.addEventListener('click', () => closeModal(confirmModal));

            resetBtn.addEventListener('click', () => {
                confirmModal.style.display = 'block';
                document.body.classList.add('modal-open');
            });
            
            confirmResetBtn.addEventListener('click', () => {
                lengthInput.value = "";
                genderInput.selectedIndex = 0; 
                currentWeightInput.value = "";
                calculationWeightInput.value = "";
                
                calorieNeedInput.value = "";
                proteinNeedInput.value = "";
                fluidNeedInput.value = "";
                
                document.querySelector('input[name="weightType"][value="ideal"]').checked = true;
                feverAdjustmentCheckbox.checked = true;
                meanTempInput.value = "37.5";
                meanTempInput.disabled = false;
                bmiAdjustmentCheckbox.checked = true;

                localStorage.removeItem('iva_nutrition_session');

                updateCalculationWeight();
                closeModal(confirmModal);
            });
            
            importBtn.addEventListener('click', () => {
                updatePatientList(); 
                importModal.style.display = 'block';
                document.body.classList.add('modal-open');
            });
            
            importCloseButtons.forEach(btn => {
                btn.addEventListener('click', () => closeModal(importModal));
            });


            lengthInput.addEventListener('input', updateCalculationWeight);
            genderInput.addEventListener('input', updateCalculationWeight);
            currentWeightInput.addEventListener('input', updateCalculationWeight);
            
            calculationWeightInput.addEventListener('input', calculateResults);

            weightTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateCalculationWeight();
                    if (e.target.value === 'other') {
                        calculationWeightInput.focus();
                    }
                });
            });
            
            calorieNeedInput.addEventListener('input', calculateResults);
            proteinNeedInput.addEventListener('input', calculateResults);
            fluidNeedInput.addEventListener('input', calculateResults);
            meanTempInput.addEventListener('input', calculateResults);
            
            feverAdjustmentCheckbox.addEventListener('change', () => {
                meanTempInput.disabled = !feverAdjustmentCheckbox.checked;
                calculateResults();
            });
            
            bmiAdjustmentCheckbox.addEventListener('change', updateCalculationWeight);

            // Init
            meanTempInput.disabled = !feverAdjustmentCheckbox.checked;
            
            // Ers√§tt loadSharedData med den nya autoLoadLatest som hanterar b√•da
            autoLoadLatest();
            
            if (!lengthInput.value && !currentWeightInput.value) {
                updateCalculationWeight(); 
            }
        });
    </script>
</body>
</html>
